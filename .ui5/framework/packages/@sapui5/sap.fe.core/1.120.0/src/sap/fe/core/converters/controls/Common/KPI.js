/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/helpers/IssueManager","sap/fe/core/converters/helpers/SelectionVariantHelper","sap/fe/core/formatters/TableFormatterTypes","sap/fe/core/helpers/TypeGuards","../../helpers/Aggregation","../../helpers/ID","./Criticality"],function(e,t,i,a,n,o,l){"use strict";var r={};var u=l.getMessageTypeFromCriticalityType;var c=o.getKPIID;var s=n.AggregationHelper;var d=a.isPathAnnotationExpression;var v=a.isAnnotationOfType;var p=i.MessageType;var f=t.getFilterDefinitionsFromSelectionVariant;var g=e.IssueType;var y=e.IssueSeverity;var C=e.IssueCategory;const h={"UI.TrendType/StrongUp":"Up","UI.TrendType/Up":"Up","UI.TrendType/StrongDown":"Down","UI.TrendType/Down":"Down","UI.TrendType/Sideways":"None"};const T={"UI.ChartType/ColumnStacked":"StackedColumn","UI.ChartType/BarStacked":"StackedBar","UI.ChartType/Donut":"Donut","UI.ChartType/Line":"Line","UI.ChartType/Bubble":"bubble","UI.ChartType/Column":"column","UI.ChartType/Bar":"bar","UI.ChartType/VerticalBullet":"vertical_bullet","UI.ChartType/Combination":"combination","UI.ChartType/Scatter":"scatter"};function m(e,t){var i,a;if(e.Measures===undefined){return undefined}const n=e.Dimensions?e.Dimensions.map(t=>{var i,a,n,o,l;const r=(i=e.DimensionAttributes)===null||i===void 0?void 0:i.find(e=>{var i;return((i=e.Dimension)===null||i===void 0?void 0:i.value)===t.value});return{name:t.value,label:((a=t.$target)===null||a===void 0?void 0:(n=a.annotations.Common)===null||n===void 0?void 0:(o=n.Label)===null||o===void 0?void 0:o.toString())||t.value,role:r===null||r===void 0?void 0:(l=r.Role)===null||l===void 0?void 0:l.replace("UI.ChartDimensionRoleType/","")}}):[];const o=e.Measures.map(t=>{var i,a,n,o,l;const r=(i=e.MeasureAttributes)===null||i===void 0?void 0:i.find(e=>{var i;return((i=e.Measure)===null||i===void 0?void 0:i.value)===t.value});return{name:t.value,label:((a=t.$target)===null||a===void 0?void 0:(n=a.annotations.Common)===null||n===void 0?void 0:(o=n.Label)===null||o===void 0?void 0:o.toString())||t.value,role:r===null||r===void 0?void 0:(l=r.Role)===null||l===void 0?void 0:l.replace("UI.ChartMeasureRoleType/","")}});return{chartType:T[e.ChartType]||"Line",dimensions:n,measures:o,sortOrder:t===null||t===void 0?void 0:(i=t.SortOrder)===null||i===void 0?void 0:i.map(e=>{var t;return{name:((t=e.Property)===null||t===void 0?void 0:t.value)||"",descending:!!e.Descending}}),maxItems:t===null||t===void 0?void 0:(a=t.MaxItems)===null||a===void 0?void 0:a.valueOf()}}function I(e,t){var i,a;const n=e.Value.$target;if((i=n.annotations.Measures)!==null&&i!==void 0&&i.ISOCurrency){var o;const e=(o=n.annotations.Measures)===null||o===void 0?void 0:o.ISOCurrency;if(d(e)){t.datapoint.unit={value:e.$target.name,isCurrency:true,isPath:true}}else{t.datapoint.unit={value:e.toString(),isCurrency:true,isPath:false}}}else if((a=n.annotations.Measures)!==null&&a!==void 0&&a.Unit){var l;const e=(l=n.annotations.Measures)===null||l===void 0?void 0:l.Unit;if(d(e)){t.datapoint.unit={value:e.$target.name,isCurrency:false,isPath:true}}else{t.datapoint.unit={value:e.toString(),isCurrency:false,isPath:false}}}}function S(e,t,i){if(e.Criticality){if(d(e.Criticality)){const a=e.Criticality.$target;if(a&&t.isPropertyAggregatable(a)){i.datapoint.criticalityPath=e.Criticality.path}else{i.datapoint.criticalityValue=p.None}}else{i.datapoint.criticalityValue=u(e.Criticality)}}else if(e.CriticalityCalculation){i.datapoint.criticalityCalculationMode=e.CriticalityCalculation.ImprovementDirection;i.datapoint.criticalityCalculationThresholds=[];switch(i.datapoint.criticalityCalculationMode){case"UI.ImprovementDirectionType/Target":i.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.DeviationRangeLowValue);i.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.ToleranceRangeLowValue);i.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.AcceptanceRangeLowValue);i.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.AcceptanceRangeHighValue);i.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.ToleranceRangeHighValue);i.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.DeviationRangeHighValue);break;case"UI.ImprovementDirectionType/Minimize":i.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.AcceptanceRangeHighValue);i.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.ToleranceRangeHighValue);i.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.DeviationRangeHighValue);break;case"UI.ImprovementDirectionType/Maximize":default:i.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.DeviationRangeLowValue);i.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.ToleranceRangeLowValue);i.datapoint.criticalityCalculationThresholds.push(e.CriticalityCalculation.AcceptanceRangeLowValue)}}else{i.datapoint.criticalityValue=p.None}}function D(e,t,i){if(e.Trend){if(d(e.Trend)){const a=e.Trend.$target;if(a&&t.isPropertyAggregatable(a)){i.datapoint.trendPath=e.Trend.path}else{i.datapoint.trendValue="None"}}else{i.datapoint.trendValue=h[e.Trend]||"None"}}else if(e.TrendCalculation){i.datapoint.trendCalculationIsRelative=e.TrendCalculation.IsRelativeDifference?true:false;if(e.TrendCalculation.ReferenceValue.$target){const a=e.TrendCalculation.ReferenceValue.$target;if(t.isPropertyAggregatable(a)){i.datapoint.trendCalculationReferencePath=e.TrendCalculation.ReferenceValue.path}else{i.datapoint.trendValue="None"}}else{i.datapoint.trendCalculationReferenceValue=e.TrendCalculation.ReferenceValue}if(i.datapoint.trendCalculationReferencePath!==undefined||i.datapoint.trendCalculationReferenceValue!==undefined){i.datapoint.trendCalculationTresholds=[e.TrendCalculation.StrongDownDifference.valueOf(),e.TrendCalculation.DownDifference.valueOf(),e.TrendCalculation.UpDifference.valueOf(),e.TrendCalculation.StrongUpDifference.valueOf()]}}else{i.datapoint.trendValue="None"}}function V(e,t,i){if(e.TargetValue){if(e.TargetValue.$target){const a=e.TargetValue.$target;if(t.isPropertyAggregatable(a)){i.datapoint.targetPath=e.TargetValue.path}}else{i.datapoint.targetValue=e.TargetValue}}}function b(e){const t=e.annotations["Common"]||{};let i;Object.keys(t).forEach(e=>{const a=t[e];if(a.term==="com.sap.vocabularies.Common.v1.SemanticObject"){if(!a.qualifier||!i){i=a}}});if(i){const e={semanticObject:i.toString(),unavailableActions:[]};const a=Object.keys(t).find(e=>{var a;return t[e].term==="com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions"&&t[e].qualifier===((a=i)===null||a===void 0?void 0:a.qualifier)});if(a){e.unavailableActions=t[a]}return e}else{return undefined}}function U(e){return!!e.template}function A(e,t,i){var a,n;const o=e.getConverterContextFor(`/${t.entitySet}`);const l=new s(o.getEntityType(),o);if(!l.isAnalyticsSupported()){e.getDiagnostics().addIssue(C.Annotation,y.Medium,g.KPI_ISSUES.NO_ANALYTICS+t.entitySet);return undefined}let r;let u;let d;let p;let h;const T=o.getAnnotationsByTerm("UI","com.sap.vocabularies.UI.v1.KPI");const U=T.find(e=>e.qualifier===t.qualifier);if(U){var A,P,R,O,M;u=U.DataPoint;r=U.SelectionVariant;d=(A=U.Detail)===null||A===void 0?void 0:A.DefaultPresentationVariant;p=(P=d)===null||P===void 0?void 0:(R=P.Visualizations)===null||R===void 0?void 0:(O=R.find(e=>v(e.$target,"com.sap.vocabularies.UI.v1.ChartDefinitionType")))===null||O===void 0?void 0:O.$target;if((M=U.Detail)!==null&&M!==void 0&&M.SemanticObject){var N;h={semanticObject:U.Detail.SemanticObject.toString(),action:(N=U.Detail.Action)===null||N===void 0?void 0:N.toString(),unavailableActions:[]}}}else{const i=o.getAnnotationsByTerm("UI","com.sap.vocabularies.UI.v1.SelectionPresentationVariant");const a=i.find(e=>e.qualifier===t.qualifier);if(a){var $,w,L,_,E,k;r=a.SelectionVariant;d=a.PresentationVariant;u=($=d)===null||$===void 0?void 0:(w=$.Visualizations)===null||w===void 0?void 0:(L=w.find(e=>v(e.$target,"com.sap.vocabularies.UI.v1.DataPointType")))===null||L===void 0?void 0:L.$target;p=(_=d)===null||_===void 0?void 0:(E=_.Visualizations)===null||E===void 0?void 0:(k=E.find(e=>v(e.$target,"com.sap.vocabularies.UI.v1.ChartDefinitionType")))===null||k===void 0?void 0:k.$target}else{e.getDiagnostics().addIssue(C.Annotation,y.Medium,g.KPI_ISSUES.KPI_NOT_FOUND+t.qualifier);return undefined}}if(!d||!u||!p){e.getDiagnostics().addIssue(C.Annotation,y.Medium,g.KPI_ISSUES.KPI_DETAIL_NOT_FOUND+t.qualifier);return undefined}const q=u.Value.$target;if(!l.isPropertyAggregatable(q)){e.getDiagnostics().addIssue(C.Annotation,y.Medium,g.KPI_ISSUES.MAIN_PROPERTY_NOT_AGGREGATABLE+t.qualifier);return undefined}const K=m(p,d);if(!K){return undefined}const j={type:"Analytical",id:c(i),entitySet:t.entitySet,datapoint:{propertyPath:u.Value.path,annotationPath:o.getEntitySetBasedAnnotationPath(u.fullyQualifiedName),title:(a=u.Title)===null||a===void 0?void 0:a.toString(),description:(n=u.Description)===null||n===void 0?void 0:n.toString()},selectionVariantFilterDefinitions:r?f(r):undefined,chart:K};if(!h){if(t.detailNavigation){h={outboundNavigation:t.detailNavigation}}else{h=b(q)}}if(h){j.navigation=h}I(u,j);S(u,l,j);D(u,l,j);V(u,l,j);return j}function P(e,t,i){if(U(t)){return{type:"Custom",key:e,template:t.template}}else{return A(i,t,e)}}function R(e){const t=e.getManifestWrapper().getKPIConfiguration(),i=[];Object.keys(t).forEach(a=>{const n=P(a,t[a],e);if(n){i.push(n)}});return i}r.getKPIDefinitions=R;return r},false);
//# sourceMappingURL=KPI.js.map