/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/ui/core/mvc/ControllerExtension","../CommonUtils","../helpers/ClassSupport"],function(e,t,i,r){"use strict";var o,s,n,f,d,c,p,a,l,u,g,y,E,h,F,S,v,m,_,O,P,G,b,x,C,w,j,M,D,I,q,$,A,T,R,V,B,N,k,z,Q,U;var L=r.publicExtension;var W=r.privateExtension;var H=r.methodOverride;var J=r.finalExtension;var K=r.defineUI5Class;function X(e,t){e.prototype=Object.create(t.prototype);e.prototype.constructor=e;Y(e,t)}function Y(e,t){Y=Object.setPrototypeOf?Object.setPrototypeOf.bind():function e(t,i){t.__proto__=i;return t};return Y(e,t)}function Z(e,t,i,r,o){var s={};Object.keys(r).forEach(function(e){s[e]=r[e]});s.enumerable=!!s.enumerable;s.configurable=!!s.configurable;if("value"in s||s.initializer){s.writable=true}s=i.slice().reverse().reduce(function(i,r){return r(e,t,i)||i},s);if(o&&s.initializer!==void 0){s.value=s.initializer?s.initializer.call(o):void 0;s.initializer=undefined}if(s.initializer===void 0){Object.defineProperty(e,t,s);s=null}return s}const ee="$$ImmediateRequest";let te=(o=K("sap.fe.core.controllerextensions.SideEffects"),s=H(),n=L(),f=J(),d=L(),c=J(),p=L(),a=J(),l=L(),u=J(),g=L(),y=J(),E=L(),h=J(),F=L(),S=J(),v=L(),m=J(),_=L(),O=J(),P=L(),G=J(),b=L(),x=J(),C=L(),w=J(),j=L(),M=J(),D=W(),I=J(),q=L(),$=J(),A=L(),T=J(),R=W(),V=J(),B=W(),N=J(),k=L(),z=J(),o(Q=(U=function(t){X(r,t);function r(){return t.apply(this,arguments)||this}var o=r.prototype;o.onInit=function e(){this._view=this.base.getView();this._sideEffectsService=i.getAppComponent(this._view).getSideEffectsService();this._registeredFieldGroupMap={};this._fieldGroupInvalidity={};this._registeredFailedSideEffects={}};o.addControlSideEffects=function e(t,i){this._sideEffectsService.addControlSideEffects(t,i)};o.removeControlSideEffects=function e(t){var i;const r=((i=t.isA)===null||i===void 0?void 0:i.call(t,"sap.ui.base.ManagedObject"))&&t.getId();if(r){this._sideEffectsService.removeControlSideEffects(r)}};o.getContextForSideEffects=function e(t,i){let r=t,o=this._sideEffectsService.getEntityTypeFromContext(t);if(i!==o){r=t.getBinding().getContext();if(r){o=this._sideEffectsService.getEntityTypeFromContext(r);if(i!==o){r=r.getBinding().getContext();if(r){o=this._sideEffectsService.getEntityTypeFromContext(r);if(i!==o){return undefined}}}}}return r||undefined};o.getFieldSideEffectsMap=function e(t){let i={};const r=t.getFieldGroupIds(),o=this._view.getViewData().entitySet,s=this._sideEffectsService.getConvertedMetaModel().entitySets.find(e=>e.name===o);i=this.getSideEffectsMapForFieldGroups(r,t.getBindingContext());if(o&&s){const e=s.entityType.fullyQualifiedName,r=this.getTargetProperty(t),o=this.getContextForSideEffects(t.getBindingContext(),e);if(r&&o){const t=this._sideEffectsService.getControlEntitySideEffects(e);Object.keys(t).forEach(s=>{const n=t[s];if(n.sourceProperties.includes(r)){const t=`${s}::${e}`;i[t]={name:t,immediate:true,sideEffects:n,context:o}}})}}return i};o.getSideEffectsMapForFieldGroups=function e(t,i){const r={};t.forEach(e=>{const{name:t,immediate:o,sideEffects:s,sideEffectEntityType:n}=this._getSideEffectsPropertyForFieldGroup(e);const f=i?this.getContextForSideEffects(i,n):undefined;if(s&&(!i||i&&f)){r[t]={name:t,immediate:o,sideEffects:s};if(i){r[t].context=f}}});return r};o.clearFieldGroupsValidity=function e(){this._fieldGroupInvalidity={}};o.isFieldGroupValid=function e(t,i){const r=this._getFieldGroupIndex(t,i);return Object.keys(this._fieldGroupInvalidity[r]??{}).length===0};o.getTargetProperty=function e(t){var i;const r=t.data("sourcePath");const o=this._view.getModel().getMetaModel();const s=(i=this._view.getBindingContext())===null||i===void 0?void 0:i.getPath();const n=s?`${o.getMetaPath(s)}/`:"";return r===null||r===void 0?void 0:r.replace(n,"")};o.prepareSideEffectsForField=function e(t,i,r){const o=t.getSource();this._saveFieldPropertiesStatus(o,i);if(!i){return}const s=this.getFieldSideEffectsMap(o);Object.keys(s).filter(e=>s[e].immediate!==true).forEach(e=>{const t=s[e];this.registerFieldGroupSideEffects(t,r)})};o.handleFieldChange=async function e(t,i,r){const o=t.getSource();this.prepareSideEffectsForField(t,i,r);return this._manageSideEffectsFromField(o)};o.handleFieldGroupChange=async function t(i){const r=i.getSource(),o=i.getParameter("fieldGroupIds")??[],s=o.reduce((e,t)=>e.concat(this.getRegisteredSideEffectsForFieldGroup(t)),[]);return Promise.all(s.map(e=>this._requestFieldGroupSideEffects(e))).catch(t=>{var i;const o=(i=r.getBindingContext())===null||i===void 0?void 0:i.getPath();e.debug(`Error while processing FieldGroup SideEffects on context ${o}`,t)})};o.requestSideEffects=async function e(t,i,r,o){let s=arguments.length>4&&arguments[4]!==undefined?arguments[4]:false;let n,f;if(o){const e=await o(t);n=e["aTargets"];f=e["TriggerAction"]}else{n=[...t.targetEntities??[],...t.targetProperties??[]];f=t.triggerAction}if(f&&!s){this._sideEffectsService.executeAction(f,i,r)}if(n.length){return this._sideEffectsService.requestSideEffects(n,i,r).catch(e=>{this.registerFailedSideEffects([t],i);throw e})}};o.requestMultipleSideEffects=async function e(t,i,r){let o=new Set;let s=new Set;const n=t.reduce((e,t)=>{const i=t.triggerAction;if(i){e.push(i)}return e},[]);for(const e of n){this._sideEffectsService.executeAction(e,i,r)}for(const e of t){o=(e.targetProperties??[]).reduce((e,t)=>e.add(t),o);s=(e.targetEntities??[]).reduce((e,t)=>e.add(t.$NavigationPropertyPath),s)}return this._sideEffectsService.requestSideEffects([...Array.from(o),...Array.from(s).map(e=>({$NavigationPropertyPath:e}))],i,r).catch(e=>{this.registerFailedSideEffects(t,i);throw e})};o.getRegisteredFailedRequests=function e(){return this._registeredFailedSideEffects};o.registerFailedSideEffects=function e(t,i){const r=i.getPath();this._registeredFailedSideEffects[r]=this._registeredFailedSideEffects[r]??[];for(const e of t){const t=this._registeredFailedSideEffects[r].every(t=>e.fullyQualifiedName!==t.fullyQualifiedName);if(t){this._registeredFailedSideEffects[r].push(e)}}};o.unregisterFailedSideEffectsForAContext=function e(t){delete this._registeredFailedSideEffects[t]};o.unregisterFailedSideEffects=function e(t,i){var r;const o=i.getPath();if((r=this._registeredFailedSideEffects[o])!==null&&r!==void 0&&r.length){this._registeredFailedSideEffects[o]=this._registeredFailedSideEffects[o].filter(e=>e.fullyQualifiedName!==t)}};o.registerFieldGroupSideEffects=function e(t,i){const r=this._getFieldGroupIndex(t.name,t.context);if(!this._registeredFieldGroupMap[r]){this._registeredFieldGroupMap[r]={promise:i??Promise.resolve(),sideEffectProperty:t}}};o.unregisterFieldGroupSideEffects=function e(t){const{context:i,name:r}=t;const o=this._getFieldGroupIndex(r,i);delete this._registeredFieldGroupMap[o]};o.getRegisteredSideEffectsForFieldGroup=function e(t){const i=[];for(const e of Object.keys(this._registeredFieldGroupMap)){if(e.startsWith(`${t}_`)){i.push(this._registeredFieldGroupMap[e])}}return i};o._getFieldGroupIndex=function e(t,i){return`${t}_${i.getPath()}`};o._getSideEffectsPropertyForFieldGroup=function e(t){var i;const r=t.includes(ee),o=t.replace(ee,""),s=o.split("#"),n=s[0],f=`${n}@com.sap.vocabularies.Common.v1.SideEffects${s.length===2?`#${s[1]}`:""}`,d=(i=this._sideEffectsService.getODataEntitySideEffects(n))===null||i===void 0?void 0:i[f];return{name:o,immediate:r,sideEffects:d,sideEffectEntityType:n}};o._manageSideEffectsFromField=async function t(i){const r=this.getFieldSideEffectsMap(i);try{const e={};const t=(t,i)=>{const r=t.getPath();if(e[r]){e[r].sideEffects.push(i)}else{e[r]={context:t,sideEffects:[i]}}};for(const e of Object.values(r).filter(e=>e.immediate===true)){this.unregisterFailedSideEffects(e.sideEffects.fullyQualifiedName,e.context);t(e.context,e.sideEffects)}for(const e of[i.getBindingContext(),this._view.getBindingContext()].filter(e=>!!e)){const i=e.getPath();const r=this._registeredFailedSideEffects[i]??[];this.unregisterFailedSideEffectsForAContext(i);for(const i of r){t(e,i)}}await Promise.all(Object.values(e).map(async e=>e.sideEffects.length===1?this.requestSideEffects(e.sideEffects[0],e.context):this.requestMultipleSideEffects(e.sideEffects,e.context)))}catch(t){e.debug(`Error while managing Field SideEffects`,t)}};o._requestFieldGroupSideEffects=async function t(i){this.unregisterFieldGroupSideEffects(i.sideEffectProperty);try{await i.promise}catch(t){e.debug(`Error while processing FieldGroup SideEffects`,t);return}try{const{sideEffects:e,context:t,name:r}=i.sideEffectProperty;if(this.isFieldGroupValid(r,t)){await this.requestSideEffects(e,t)}}catch(t){e.debug(`Error while executing FieldGroup SideEffects`,t)}};o._saveFieldPropertiesStatus=function e(t,i){const r=this.getFieldSideEffectsMap(t);Object.keys(r).forEach(e=>{const{name:o,immediate:s,context:n}=r[e];if(!s){const e=this._getFieldGroupIndex(o,n);if(i){var f;(f=this._fieldGroupInvalidity[e])===null||f===void 0?true:delete f[t.getId()]}else{this._fieldGroupInvalidity[e]={...this._fieldGroupInvalidity[e],...{[t.getId()]:true}}}}})};return r}(t),Z(U.prototype,"onInit",[s],Object.getOwnPropertyDescriptor(U.prototype,"onInit"),U.prototype),Z(U.prototype,"addControlSideEffects",[n,f],Object.getOwnPropertyDescriptor(U.prototype,"addControlSideEffects"),U.prototype),Z(U.prototype,"removeControlSideEffects",[d,c],Object.getOwnPropertyDescriptor(U.prototype,"removeControlSideEffects"),U.prototype),Z(U.prototype,"getContextForSideEffects",[p,a],Object.getOwnPropertyDescriptor(U.prototype,"getContextForSideEffects"),U.prototype),Z(U.prototype,"getFieldSideEffectsMap",[l,u],Object.getOwnPropertyDescriptor(U.prototype,"getFieldSideEffectsMap"),U.prototype),Z(U.prototype,"getSideEffectsMapForFieldGroups",[g,y],Object.getOwnPropertyDescriptor(U.prototype,"getSideEffectsMapForFieldGroups"),U.prototype),Z(U.prototype,"clearFieldGroupsValidity",[E,h],Object.getOwnPropertyDescriptor(U.prototype,"clearFieldGroupsValidity"),U.prototype),Z(U.prototype,"isFieldGroupValid",[F,S],Object.getOwnPropertyDescriptor(U.prototype,"isFieldGroupValid"),U.prototype),Z(U.prototype,"getTargetProperty",[v,m],Object.getOwnPropertyDescriptor(U.prototype,"getTargetProperty"),U.prototype),Z(U.prototype,"prepareSideEffectsForField",[_,O],Object.getOwnPropertyDescriptor(U.prototype,"prepareSideEffectsForField"),U.prototype),Z(U.prototype,"handleFieldChange",[P,G],Object.getOwnPropertyDescriptor(U.prototype,"handleFieldChange"),U.prototype),Z(U.prototype,"handleFieldGroupChange",[b,x],Object.getOwnPropertyDescriptor(U.prototype,"handleFieldGroupChange"),U.prototype),Z(U.prototype,"requestSideEffects",[C,w],Object.getOwnPropertyDescriptor(U.prototype,"requestSideEffects"),U.prototype),Z(U.prototype,"getRegisteredFailedRequests",[j,M],Object.getOwnPropertyDescriptor(U.prototype,"getRegisteredFailedRequests"),U.prototype),Z(U.prototype,"registerFailedSideEffects",[D,I],Object.getOwnPropertyDescriptor(U.prototype,"registerFailedSideEffects"),U.prototype),Z(U.prototype,"unregisterFailedSideEffectsForAContext",[q,$],Object.getOwnPropertyDescriptor(U.prototype,"unregisterFailedSideEffectsForAContext"),U.prototype),Z(U.prototype,"unregisterFailedSideEffects",[A,T],Object.getOwnPropertyDescriptor(U.prototype,"unregisterFailedSideEffects"),U.prototype),Z(U.prototype,"registerFieldGroupSideEffects",[R,V],Object.getOwnPropertyDescriptor(U.prototype,"registerFieldGroupSideEffects"),U.prototype),Z(U.prototype,"unregisterFieldGroupSideEffects",[B,N],Object.getOwnPropertyDescriptor(U.prototype,"unregisterFieldGroupSideEffects"),U.prototype),Z(U.prototype,"getRegisteredSideEffectsForFieldGroup",[k,z],Object.getOwnPropertyDescriptor(U.prototype,"getRegisteredSideEffectsForFieldGroup"),U.prototype),U))||Q);return te},false);
//# sourceMappingURL=SideEffects.js.map