/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepClone","sap/base/util/uid","sap/fe/core/buildingBlocks/AttributeModel","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/TypeGuards","sap/ui/base/BindingParser","sap/ui/core/util/XMLPreprocessor","sap/ui/model/json/JSONModel","./TraceInfo"],function(e,t,n,i,o,s,r,a,l,c,d){"use strict";var u={};var f=r.isFunctionArray;var p=r.isContext;var m=s.isBindingToolkitExpression;var g=s.compileExpression;var h=o.Placement;const b="sap.fe.core.buildingBlocks.BuildingBlockTemplateProcessor";const x="http://schemas.sap.com/sapui5/extension/sap.ui.core.template/1";const y=new DOMParser;function v(e,t,n,i){const o=t[i];const s=o===null||o===void 0?void 0:o.getObject();if(n.required===true&&(!o||s===null)){throw new Error(`${e}: Required metadataContext '${i}' is missing`)}else if(s){if(s.hasOwnProperty("$kind")&&s.$kind!==undefined&&n.expectedTypes!==undefined){if(!n.expectedTypes.includes(s.$kind)){throw new Error(`${e}: '${i}' must be '$kind' '${n.expectedTypes}' but is '${s.$kind}': ${o.getPath()}`)}}else if(s.hasOwnProperty("$Type")&&s.$Type!==undefined&&n.expectedAnnotationTypes){if(!n.expectedAnnotationTypes.includes(s.$Type)){throw new Error(`${e}: '${i}' must be '$Type' '${n.expectedAnnotationTypes}' but is '${s.$Type}': ${o.getPath()}`)}}}}function C(t,n,i,o){const s=n.metadataContexts&&Object.keys(n.metadataContexts)||[],r=n.properties&&Object.keys(n.properties)||[],a={};const l=o.getAttributeNames();for(const e of l){a[e]=true}s.forEach(function(e){const o=n.metadataContexts[e];v(t,i,o,e);delete a[e]});r.forEach(function(e){const i=n.properties[e];if(!o.hasAttribute(e)){if(i.required&&!i.hasOwnProperty("defaultValue")){throw new Error(`${t}: `+`Required property '${e}' is missing`)}}else{delete a[e]}});Object.keys(a).forEach(function(n){if(!n.includes(":")&&!n.startsWith("xmlns")){e.warning(`Unchecked parameter: ${t}: ${n}`,undefined,b)}})}u.validateMacroSignature=C;const $="sap.ui.core.Element";const P="sap.ui.model.Context";u.SAP_UI_MODEL_CONTEXT=P;function w(e){const t={};const n={dependents:{type:$,slot:"dependents",isPublic:true},customData:{type:$,slot:"customData",isPublic:true},layoutData:{type:$,slot:"layoutData",isPublic:true},...e.aggregations};const i={};for(const n of Object.keys(e.properties)){const o=e.properties[n].type;if(o!==P){t[n]=e.properties[n]}if([P,"object","array"].includes(o)){i[n]=e.properties[n]}}return{...e,properties:t,metadataContexts:i,aggregations:n}}function A(e,t){let n;if(t&&t.startsWith("/")){n=t}else{let i=e.currentContextPath.getPath();if(!i.endsWith("/")){i+="/"}n=i+t}return{model:"metaModel",path:n}}function k(e,t,n){let i;if(n.startsWith("/uid--")&&!e.models.converterContext.getProperty(n)){const t=q(n);e.models.converterContext.setProperty(n,t);i={model:"converterContext",path:n}}else if(t==="metaPath"&&e.currentContextPath||t==="contextPath"){i=A(e,n)}else if(n&&n.startsWith("/")){i={model:"metaModel",path:n}}else{i={model:"metaModel",path:e.bindingContexts.entitySet?e.bindingContexts.entitySet.getPath(n):n}}return i}function E(e,t,n,i,o,s){let r;if(!o&&t.hasAttribute(n)){const i=t.getAttribute(n);r=a.complexParser(i);if(!r){r=k(e,n,i)}}else if(e.bindingContexts.hasOwnProperty(n)){r={model:n,path:""}}else if(s){try{if(i.getContext(`${n}>`)){r={model:n,path:""}}}catch(e){return undefined}}return r}async function T(n,i,o,s){const r=n.properties;const a=Object.keys(r);const l={};for(const n of a){if(r[n].type==="object"){l[n]=r[n].defaultValue&&t(r[n].defaultValue)}else{l[n]=r[n].defaultValue}if(i.hasAttribute(n)&&o&&r[n].isPublic===false){e.error(`Property ${n} was ignored as it is not intended for public usage`)}else if(i.hasAttribute(n)){await s.visitAttribute(i,i.attributes.getNamedItem(n));let e=i.getAttribute(n);if(e!==undefined&&e!==null){if(typeof e==="string"&&!e.startsWith("{")){switch(r[n].type){case"boolean":e=e==="true";break;case"number":e=Number(e);break}}e=e===null?undefined:e;l[n]=e}}}return l}function N(e,t,n,i,o,s,r){t.currentContextPath=t.bindingContexts.contextPath;const a={};const l=e.metadataContexts;const c=Object.keys(l);const d=c.indexOf("contextPath");if(d!==-1){const e=c.splice(d,1);c.splice(0,0,e[0])}for(const d of c){const c=r[d];if(c!==undefined&&typeof c==="object"&&Object.keys(c).length>0){delete e.metadataContexts[d];continue}const u=i&&l[d].isPublic===false&&n.hasAttribute(d);const f=E(t,n,d,o,u,e.isOpen??false);if(f){f.name=d;M(s,o,f);if((d==="entitySet"||d==="contextPath")&&!t.bindingContexts.hasOwnProperty(d)){t.bindingContexts[d]=s[d]}if(d==="contextPath"){t.currentContextPath=s[d]}if(s[d]!==undefined){r[d]=s[d]}else if(typeof r[d]==="string"){delete e.metadataContexts[d]}}else{a[d]=true}}return a}function O(t,n){const i={};if(t&&t.children.length>0){const o=t.children;for(let t=0;t<o.length;t++){const s=o[t];let r=s.getAttribute("key")||s.getAttribute("id");if(r){r=`InlineXML_${r}`;s.setAttribute("key",r);let e={key:r,position:{placement:s.getAttribute("placement")||h.After,anchor:s.getAttribute("anchor")||undefined},type:"Slot"};if(n){e=n(s,e)}i[e.key]=e}else if(s.tagName!=="slot"){e.error(`The aggregation ${s.nodeName} is missing a Key attribute. It is not displayed`)}}}return i}async function j(e,t,n,i,o){const s={};if(e.firstElementChild!==null){let r=e.firstElementChild;while(r!==null){if(r.namespaceURI===x){const e=r.parentNode;if(e){const n=Array.from(e.children).indexOf(r);await t.visitNode(r);r=e.children[n]?e.children[n]:null}else{r=r.nextElementSibling}}else{const e=r.localName;let t=e;if(t[0].toUpperCase()===t[0]){t=n.defaultAggregation||""}const i=n.aggregations[t];if(i!==undefined&&!i.slot){const e=O(r,i.processAggregations);o[t]=e;for(const t in e){n.aggregations[t]=e[t]}}r=r.nextElementSibling}}r=e.firstElementChild;while(r!==null){const a=r.nextElementSibling;const l=r.localName;let c=l;if(c[0].toUpperCase()===c[0]){c=n.defaultAggregation||""}if(Object.keys(n.aggregations).includes(c)&&(!i||n.aggregations[c].isPublic===true)){const i=n.aggregations[c];if(!i.slot&&r!==null&&r.children.length>0){await t.visitNode(r);let n=r.firstElementChild;while(n){const t=n.nextElementSibling;if(!i.hasVirtualNode){const t=document.createElementNS(e.namespaceURI,n.getAttribute("key"));t.appendChild(n);s[n.getAttribute("key")]=t}else{s[n.getAttribute("key")]=n}n.removeAttribute("key");n=t}}else if(i.slot){await t.visitNode(r);if(c!==l){if(!s[c]){const t=document.createElementNS(e.namespaceURI,c);s[c]=t}s[c].appendChild(r)}else{s[c]=r}}}else if(Object.keys(n.properties).includes(c)){await t.visitNode(r);if(n.properties[c].type==="object"){const e={};const t=r.getAttributeNames();for(const n of t){e[n]=r.getAttribute(n)}if(r.children.length){for(let t=0;t<r.children.length;t++){const n=r.children[t];const i=n.localName;const o={};const s=n.getAttributeNames();for(const e of s){o[e]=n.getAttribute(e)}e[i]=o}}o[c]=e}else if(n.properties[c].type==="array"){if(r!==null&&r.children.length>0){const e=r.children;const t=[];for(let n=0;n<e.length;n++){const i=e[n];const o={};const s=i.getAttributeNames();for(const e of s){o[e]=i.getAttribute(e)}t.push(o)}o[c]=t}}}r=a}}return s}function B(e,t,n){let i=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;if(Object.keys(e).length>0){Object.keys(e).forEach(function(o){const s=e[o];if(n!==null&&n!==undefined&&s){const e=s.firstElementChild;if(!["dependents","customData","layoutData"].includes(o)){const i=t[o]!==undefined&&t[o].slot||o;const s=n.querySelector(`slot[name='${i}']`);if(s!==null){const t=S(n,o,e);s.replaceWith(...t.children)}}else if(i&&e!==null){const t=S(n,o,e);n.appendChild(t)}}})}}function S(e,t,n){const i=document.createElementNS(e.namespaceURI,t.replace(/:/gi,"_"));while(n){const e=n.nextElementSibling;i.appendChild(n);n=e}return i}async function I(t,n,o){let s=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;const r=w(t.metadata);const a=r.fragment??`${r.namespace??r.publicNamespace}.${r.xmlTag??r.name}`;const l={};const u=o.getSettings();u.models.converterContext??=new c;if(!u[a]){u[a]={}}const f=await T(r,n,s,o);const m=Object.keys(f);const g=N(r,u,n,s,o,l,f);try{const c=await j(n,o,r,s,f);let m={};if(u.models.viewData){m=u.models.viewData.getProperty("/controlConfiguration")}let g=f;Object.keys(f).forEach(e=>{var n,i,o;let s=f[e];const r=t===null||t===void 0?void 0:(n=t.metadata)===null||n===void 0?void 0:n.properties[e];if(r!==null&&r!==void 0&&r.validate){s=r.validate(s)||s}if((i=s)!==null&&i!==void 0&&(o=i.isA)!==null&&o!==void 0&&o.call(i,P)&&!s.getModel().isA("sap.ui.model.odata.v4.ODataMetaModel")){f[e]=s.getObject()}});f.isPublic=s;const h=new t({...f,...c},m,u);g=h.getProperties();Object.keys(r.metadataContexts).forEach(function(e){if(g.hasOwnProperty(e)){const t=g[e];if(p(t)){l[e]=t}else if(typeof t==="object"){const n=F(t);u.models.converterContext.setProperty(n,t);const i=u.models.converterContext.createBindingContext(n);q(n);l[e]=i}}});const b=new i(n,g,t);l["this"]=b.createBindingContext("/");let x;const y=(n===null||n===void 0?void 0:n.getAttribute("core:require"))||undefined;if(d.isTraceInfoActive()){const e=d.traceMacroCalls(a,r,l,n,o);if(e!==null&&e!==void 0&&e.macroInfo){x=u["_macroInfo"];u["_macroInfo"]=e.macroInfo}}C(a,r,l,n);const v=o.with(l,r.isOpen!==undefined?!r.isOpen:true);const $=n.parentNode;let w;let A;if($){w=Array.from($.children).indexOf(n);if(r.fragment){A=v.insertFragment(a,n)}else{const i=Object.keys(V);const o=await h.getTemplate(n);if(t.isRuntime){for(const e in V){if(!i.includes(e)){const t=q(e);u.models.converterContext.setProperty(e,t)}}}let s="";if(o){let t=false;let i=U(o,true);for(const e of i){const n=document.createNodeIterator(e,NodeFilter.SHOW_TEXT);let i=n.nextNode();if(e.localName==="parsererror"){t=true}while(i){if(i.textContent&&i.textContent.trim().length>0){s=i.textContent}i=n.nextNode()}}if(t){e.error(`Error while processing building block ${r.xmlTag||r.name}`);i=await R(async()=>{var e;const t=await((e=h.getTemplate)===null||e===void 0?void 0:e.call(h,n));return U(t??"",true)})}else if(s.length>0){e.error(`Error while processing building block ${r.xmlTag||r.name}`);const t=L([`Error while processing building block ${r.xmlTag||r.name}`,`Trailing text was found in the XML: ${s}`],i.map(e=>e.outerHTML).join("\n"));i=U(t,true)}n.replaceWith(...i);const a=i.map(async e=>{B(c,r.aggregations,e,false);return v.visitNode(e)});A=Promise.all(a)}else{n.remove();A=Promise.resolve()}}await A;const i=$.children[w];B(c,r.aggregations,i,true);if(i!==undefined){const e=i.querySelectorAll("slot");e.forEach(function(e){e.remove()});if(y){let e=i.getAttributeNS("sap.ui.core","require");if(e){e=e.substring(0,e.length-1)+","+y.substring(1)}else{e=y}i.setAttributeNS("sap.ui.core","require",e)}}}if(x){u["_macroInfo"]=x}else{delete u["_macroInfo"]}}catch(t){const i={initialProperties:{},resolvedProperties:{},missingContexts:g};for(const e of m){const t=f[e];if(p(t)){i.initialProperties[e]={path:t.getPath(),value:t.getObject()}}else{i.initialProperties[e]=t}}for(const e in f){const t=f[e];if(!m.includes(e)){if(p(t)){i.resolvedProperties[e]={path:t.getPath(),value:t.getObject()}}else{i.resolvedProperties[e]=t}}}e.error(t);const o=L([`Error while processing building block ${r.name}`],n.outerHTML,i,t.stack);const s=U(o,true);n.replaceWith(...s)}}function M(e,t,n){const i=n.name||n.model||undefined;if(e[i]){return}try{let o=n.path;if(n.model!==null){o=`${n.model}>${o}`}const s=t.getSettings();if(n.model==="converterContext"&&n.path.length>0){e[i]=s.models[n.model].getContext(n.path)}else if(!s.bindingContexts[n.model]&&s.models[n.model]){e[i]=s.models[n.model].getContext(n.path)}else{e[i]=t.getContext(o)}}catch(e){}}function D(e){if(e.metadata.namespace!==undefined){l.plugIn(async(t,n)=>I(e,t,n),e.metadata.namespace,e.metadata.xmlTag||e.metadata.name)}if(e.metadata.publicNamespace!==undefined){l.plugIn(async(t,n)=>I(e,t,n,true),e.metadata.publicNamespace,e.metadata.xmlTag||e.metadata.name)}}u.registerBuildingBlock=D;function W(e){if(e.metadata.namespace!==undefined){l.plugIn(null,e.metadata.namespace,e.metadata.xmlTag||e.metadata.name)}if(e.metadata.publicNamespace!==undefined){l.plugIn(null,e.metadata.publicNamespace,e.metadata.xmlTag||e.metadata.name)}}u.unregisterBuildingBlock=W;function L(e,t,n,i){const o=e.map(e=>G`<m:Label text="${X(e)}"/>`);let s="";if(i){const e=btoa(`<pre>${i}</pre>`);s=G`<m:FormattedText htmlText="{= BBF.base64Decode('${e}') }" />`}let r="";if(n){r=G`<m:VBox>
						<m:Label text="Trace Info"/>
						<code:CodeEditor type="json"  value="${`{= BBF.base64Decode('${btoa(JSON.stringify(n,null,4))}') }`}" height="300px" />
					</m:VBox>`}return G`<controls:FormElementWrapper xmlns:controls="sap.fe.core.controls">
					<m:VBox xmlns:m="sap.m" xmlns:code="sap.ui.codeeditor" core:require="{BBF:'sap/fe/core/buildingBlocks/BuildingBlockFormatter'}">
					${o}
					${s}
						<grid:CSSGrid gridTemplateRows="fr" gridTemplateColumns="repeat(2,1fr)" gridGap="1rem" xmlns:grid="sap.ui.layout.cssgrid" >
							<m:VBox>
								<m:Label text="How the building block was called"/>
								<code:CodeEditor type="xml" value="${`{= BBF.base64Decode('${btoa(t.replaceAll("&gt;",">"))}') }`}" height="300px" />
							</m:VBox>
							${r}
						</grid:CSSGrid>
					</m:VBox>
				</controls:FormElementWrapper>`}const V={};function F(e){const t=`/uid--${n()}`;V[t]=e;return t}function q(e){const t=V[e];delete V[e];return t}let _=false;const R=async function(e){_=true;let t;try{t=e()}finally{_=false}return t};function U(e){var t,n;let i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(i){e=`<template\n\t\t\t\t\t\txmlns:template="http://schemas.sap.com/sapui5/extension/sap.ui.core.template/1"\n\t\t\t\t\t\txmlns:m="sap.m"\n\t\t\t\t\t\txmlns:macros="sap.fe.macros"\n\t\t\t\t\t\txmlns:core="sap.ui.core"\n\t\t\t\t\t\txmlns:mdc="sap.ui.mdc"\n\t\t\t\t\t\txmlns:customData="http://schemas.sap.com/sapui5/extension/sap.ui.core.CustomData/1">${e}</template>`}const o=y.parseFromString(e,"text/xml");let s=o.firstElementChild;while(((r=s)===null||r===void 0?void 0:r.localName)==="template"){var r;s=s.firstElementChild}const a=(t=s)!==null&&t!==void 0&&t.parentElement?(n=s)===null||n===void 0?void 0:n.parentElement.children:[s];return Array.from(a)}u.parseXMLString=U;function X(e){return e===null||e===void 0?void 0:e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/"/g,"&quot;").replace(/'/g,"&apos;")}u.escapeXMLAttributeValue=X;function H(e){var t;const n=U(e,true);if((n===null||n===void 0?void 0:n.length)>0&&((t=n[0])===null||t===void 0?void 0:t.localName)==="parsererror"){const t=n[0].innerText||n[0].innerHTML;return L([t.split("\n")[0]],e)}else{return e}}const G=function(e){let t="";let n;for(var i=arguments.length,o=new Array(i>1?i-1:0),s=1;s<i;s++){o[s-1]=arguments[s]}for(n=0;n<o.length;n++){t+=e[n];const i=o[n];if(Array.isArray(i)&&i.length>0&&typeof i[0]==="string"){t+=i.flat(5).join("\n").trim()}else if(f(i)){t+=i.map(e=>e()).join("\n")}else if(m(i)){const e=g(i);t+=X(e)}else if(typeof i==="undefined"){t+="{this>undefinedValue}"}else if(typeof i==="function"){t+=i()}else if(typeof i==="object"&&i!==null){if(p(i)){t+=i.getPath()}else{const e=F(i);t+=`${e}`}}else if(i&&typeof i==="string"&&!i.startsWith("<")&&!i.startsWith("&lt;")){t+=X(i)}else{t+=i}}t+=e[n];t=t.trim();if(_){return H(t)}return t};u.xml=G;return u},false);
//# sourceMappingURL=BuildingBlockTemplateProcessor.js.map