/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ModelHelper","sap/fe/navigation/library","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","sap/ui/fl/apply/api/ControlVariantApplyAPI","sap/ui/mdc/p13n/StateUtil"],function(t,e,i,r,n,a,o,l,p,s,c){"use strict";var f,d,u,y,g,S,h,v,b,w,C,A,O,I,m,P,_,R,E,j,B,V,D,K,x,H,M,F,T,N,k,$,z,L,U,q,G,W,Y,J,Q,X,Z,tt,et,it,rt,nt,at;var ot=r.publicExtension;var lt=r.privateExtension;var pt=r.finalExtension;var st=r.extensible;var ct=r.defineUI5Class;function ft(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;dt(t,e)}function dt(t,e){dt=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,i){e.__proto__=i;return e};return dt(t,e)}function ut(t,e,i,r,n){var a={};Object.keys(r).forEach(function(t){a[t]=r[t]});a.enumerable=!!a.enumerable;a.configurable=!!a.configurable;if("value"in a||a.initializer){a.writable=true}a=i.slice().reverse().reduce(function(i,r){return r(t,e,i)||i},a);if(n&&a.initializer!==void 0){a.value=a.initializer?a.initializer.call(n):void 0;a.initializer=undefined}if(a.initializer===void 0){Object.defineProperty(t,e,a);a=null}return a}const yt=o.NavType;const gt="#additionalStates";const St={"sap.ui.fl.variants.VariantManagement":{retrieve:function(t){return{variantId:t.getCurrentVariantKey()}},apply:async function(e,i){try{if(i&&i.variantId!==undefined&&i.variantId!==e.getCurrentVariantKey()){const r=this._checkIfVariantIdIsAvailable(e,i.variantId);let n;if(r){n=i.variantId}else{n=e.getStandardVariantKey();this.controlsVariantIdUnavailable.push(...e.getFor())}try{await s.activateVariant({element:e,variantReference:n});await this._setInitialStatesForDeltaCompute(e)}catch(i){t.error(i);this.invalidateInitialStateForApply.push(...e.getFor());await this._setInitialStatesForDeltaCompute(e)}}else{this._setInitialStatesForDeltaCompute(e)}}catch(e){t.error(e)}}},"sap.m.IconTabBar":{retrieve:function(t){return{selectedKey:t.getSelectedKey()}},apply:function(t,e){if(e&&e.selectedKey){const i=t.getItems().find(function(t){return t.getKey()===e.selectedKey});if(i){t.setSelectedItem(i)}}}},"sap.ui.mdc.FilterBar":{retrieve:async function(t){const e=this.getStateKey(t);const i=await c.retrieveExternalState(t);const r=t.getPropertyInfoSet();const n=i.filter||{};r.filter(function(t){return Object.keys(n).length>0&&t.path&&n[t.path]&&(t.removeFromAppState||n[t.path].length===0)}).forEach(function(t){if(t.path){delete n[t.path]}});return this._getControlState(e,i)},apply:async function(e,i,r,n){try{if(i){const t=this._isInitialStatesApplicable(i===null||i===void 0?void 0:i.initialState,e,n);const a=r.navigationType;if(a===yt.hybrid&&i.fullState!==undefined){const t=e.getParent(),n=await t.convertSelectionVariantToStateFilters(r.selectionVariant);const a={...i.fullState,filter:{...i.fullState.filter,...n}};await e.getParent()._clearFilterValuesWithOptions(e,{clearEditFilter:true});return c.applyExternalState(e,a)}if(t){const t=await c.diffState(e,i.initialState,i.fullState);return c.applyExternalState(e,t)}else if(n){await e.getParent()._clearFilterValuesWithOptions(e,{clearEditFilter:true})}return c.applyExternalState(e,(i===null||i===void 0?void 0:i.fullState)??i)}}catch(e){t.error(e)}}},"sap.ui.mdc.Table":{retrieve:async function(t){const e=this.getStateKey(t);const i=await c.retrieveExternalState(t);return this._getControlState(e,i)},apply:async function(e,i,r,n){try{if(i){const t=this._isInitialStatesApplicable(i===null||i===void 0?void 0:i.initialState,e,n,r.navigationType!==yt.hybrid);if(t){var a;if(i.initialState&&!((a=i.initialState)!==null&&a!==void 0&&a.supplementaryConfig)){i.initialState.supplementaryConfig={}}const t=await c.diffState(e,i.initialState,i.fullState);return c.applyExternalState(e,t)}else{if(!i.supplementaryConfig){i.supplementaryConfig={}}return c.applyExternalState(e,(i===null||i===void 0?void 0:i.fullState)??i)}}}catch(e){t.error(e)}},refreshBinding:function(e){const i=e.getRowBinding();if(i){const t=i.getRootBinding();if(t===i){i.refresh()}else{const t=i.getHeaderContext();const e=i.getGroupId();if(t){t.requestSideEffects([{$NavigationPropertyPath:""}],e)}}}else{t.info(`Table: ${e.getId()} was not refreshed. No binding found!`)}}},"sap.ui.mdc.Chart":{retrieve:function(t){return c.retrieveExternalState(t)},apply:function(t,e){if(e){return c.applyExternalState(t,e)}}},"sap.uxap.ObjectPageLayout":{retrieve:function(t){return{selectedSection:t.getSelectedSection()}},apply:function(t,e){if(e){t.setSelectedSection(e.selectedSection)}},refreshBinding:function(e){const r=e.getBindingContext();const o=r&&r.getBinding();if(o){const t=a.getMetaPathForContext(r);const l=n.getControlRefreshStrategyForContextPath(e,t);if(l==="self"){const e=r.getModel(),n=e.getMetaModel(),a=i.getContextPathProperties(n,t,{$kind:"NavigationProperty"})||{},l=Object.keys(a).reduce(function(t,e){if(a[e].$isCollection!==true){t.push({$NavigationPropertyPath:e})}return t},[]),p=[{$PropertyPath:"*"}],s=o.getGroupId();r.requestSideEffects(p.concat(l),s)}else if(l==="includingDependents"){o.refresh()}}else{t.info(`ObjectPage: ${e.getId()} was not refreshed. No binding found!`)}}},"sap.m.SegmentedButton":{retrieve:function(t){return{selectedKey:t.getSelectedKey()}},apply:function(t,e){if(e!==null&&e!==void 0&&e.selectedKey&&e.selectedKey!==t.getSelectedKey()){var i;t.setSelectedKey(e.selectedKey);if((i=t.getParent())!==null&&i!==void 0&&i.isA("sap.ui.mdc.ActionToolbar")){t.fireEvent("selectionChange")}}}},"sap.m.Select":{retrieve:function(t){return{selectedKey:t.getSelectedKey()}},apply:function(t,e){if(e!==null&&e!==void 0&&e.selectedKey&&e.selectedKey!==t.getSelectedKey()){var i;t.setSelectedKey(e.selectedKey);if((i=t.getParent())!==null&&i!==void 0&&i.isA("sap.ui.mdc.ActionToolbar")){t.fireEvent("change")}}}},"sap.f.DynamicPage":{retrieve:function(t){return{headerExpanded:t.getHeaderExpanded()}},apply:function(t,e){if(e){t.setHeaderExpanded(e.headerExpanded)}}},"sap.ui.core.mvc.View":{retrieve:function(t){const e=t.getController();if(e&&e.viewState){return e.viewState.retrieveViewState(e.viewState)}return{}},apply:function(t,e,i,r){const n=t.getController();if(n&&n.viewState){return n.viewState.applyViewState(e,i,r)}},refreshBinding:function(t){const e=t.getController();if(e&&e.viewState){return e.viewState.refreshViewBindings()}}},"sap.ui.core.ComponentContainer":{retrieve:function(t){const e=t.getComponentInstance();if(e){return this.retrieveControlState(e.getRootControl())}return{}},apply:function(t,e,i){const r=t.getComponentInstance();if(r){return this.applyControlState(r.getRootControl(),e,i)}}},"sap.sac.df.changeHandler.MultiDimModelChangeHandler":{retrieve:function(t){return t._getMultiDimModel().serialize("INA_REPOSITORY_DELTA")},apply:function(t,e){if(e){return t._getMultiDimModel().deserialize(e,"INA_REPOSITORY_DELTA")}}}};let ht=(f=ct("sap.fe.core.controllerextensions.ViewState"),d=ot(),u=pt(),y=ot(),g=st(p.After),S=lt(),h=pt(),v=lt(),b=pt(),w=ot(),C=st(p.After),A=ot(),O=st(p.After),I=ot(),m=st(p.After),P=lt(),_=pt(),R=ot(),E=st(p.After),j=lt(),B=pt(),V=ot(),D=st(p.After),K=ot(),x=pt(),H=ot(),M=pt(),F=ot(),T=st(p.After),N=lt(),k=pt(),$=ot(),z=st(p.Instead),L=ot(),U=pt(),q=lt(),G=ot(),W=st(p.After),Y=ot(),J=st(p.After),Q=ot(),X=st(p.After),Z=lt(),tt=ot(),et=st(p.After),it=lt(),rt=pt(),f(nt=(at=function(i){ft(r,i);function r(){var e;e=i.call(this)||this;e.initialControlStatesMapper={};e.controlsVariantIdUnavailable=[];e.invalidateInitialStateForApply=[];e.viewStateControls=[];e._setInitialStatesForDeltaCompute=async i=>{try{const t=e.viewStateControls;const r=[];const n=[];let a=[];const o=(i===null||i===void 0?void 0:i.getFor())??[];t.filter(function(t){return t&&(!i||o.includes(t.getId()))&&(t.isA("sap.ui.mdc.Table")||t.isA("sap.ui.mdc.FilterBar")||t.isA("sap.ui.mdc.Chart"))}).forEach(t=>{if(i){e._addEventListenersToVariantManagement(i,o)}const a=c.retrieveExternalState(t);r.push(a);n.push(e.getStateKey(t))});a=await Promise.all(r);a.forEach((t,i)=>{e.initialControlStatesMapper[n[i]]=t})}catch(e){t.error(e)}};e._iRetrievingStateCounter=0;e._pInitialStateApplied=new Promise(t=>{e._pInitialStateAppliedResolve=t});return e}var n=r.prototype;n.refreshViewBindings=async function t(){const e=await this.collectResults(this.base.viewState.adaptBindingRefreshControls);let i=Promise.resolve();e.filter(t=>t&&t.isA&&t.isA("sap.ui.base.ManagedObject")).forEach(t=>{i=i.then(this.refreshControlBinding.bind(this,t))});return i};n.adaptBindingRefreshControls=function t(e){};n.refreshControlBinding=function e(i){const r=this.getControlRefreshBindingHandler(i);let n=Promise.resolve();if(typeof r.refreshBinding!=="function"){t.info(`refreshBinding handler for control: ${i.getMetadata().getName()} is not provided`)}else{n=n.then(r.refreshBinding.bind(this,i))}return n};n.getControlRefreshBindingHandler=function t(e){const i={};if(e){for(const t in St){if(e.isA(t)){i["refreshBinding"]=St[t].refreshBinding||{};break}}}this.base.viewState.adaptBindingRefreshHandler(e,i);return i};n.adaptBindingRefreshHandler=function t(e,i){};n.onSuspend=function t(){};n.onRestore=function t(){};n.destroy=function t(){delete this._pInitialStateAppliedResolve;i.prototype.destroy.call(this)};n.collectResults=function t(e){const i=[];for(var r=arguments.length,n=new Array(r>1?r-1:0),a=1;a<r;a++){n[a-1]=arguments[a]}n.push(i);e.apply(this,n);return Promise.all(i)};n.adaptControlStateHandler=function t(e,i){};n.getControlStateHandler=function t(e){const i=[],r=[];if(e){for(const t in St){if(e.isA(t)){i.push(Object.assign({},St[t]));break}}}this.base.viewState.adaptControlStateHandler(e,r);return i.concat(r)};n.adaptStateControls=function t(e){};n.getStateKey=function t(e){return this.getView().getLocalId(e.getId())||e.getId()};n.retrieveViewState=async function t(){++this._iRetrievingStateCounter;let i;try{await this._pInitialStateApplied;const t=await this.collectResults(this.base.viewState.adaptStateControls);const r=await Promise.all(t.filter(function(t){return t&&t.isA&&t.isA("sap.ui.base.ManagedObject")}).map(t=>this.retrieveControlState(t).then(e=>({key:this.getStateKey(t),value:e}))));i=r.reduce(function(t,i){const r={};r[i.key]=i.value;return e(t,r)},{});const n=await Promise.resolve(this._retrieveAdditionalStates());if(n&&Object.keys(n).length){i[gt]=n}}finally{--this._iRetrievingStateCounter}return this._iRetrievingStateCounter===0?i:undefined};n.retrieveAdditionalStates=function t(e){};n._retrieveAdditionalStates=function t(){const e={};this.base.viewState.retrieveAdditionalStates(e);return e};n.retrieveControlState=function t(i){const r=this.getControlStateHandler(i);return Promise.all(r.map(t=>{if(typeof t.retrieve!=="function"){throw new Error(`controlStateHandler.retrieve is not a function for control: ${i.getMetadata().getName()}`)}return t.retrieve.call(this,i)})).then(t=>t.reduce(function(t,i){return e(t,i)},{}))};n.applyInitialStateOnly=function t(){return true};n.applyViewState=async function e(i,r,n){if(this.base.viewState.applyInitialStateOnly()&&this._getInitialStateApplied()){return}try{await this.collectResults(this.base.viewState.onBeforeStateApplied,[],r.navigationType);const t=await this.collectResults(this.base.viewState.adaptStateControls);this.viewStateControls=t;let e=Promise.resolve();let a=false;const o=t.reduce((t,e)=>{if(!e){return t}const i=e.isA("sap.ui.fl.variants.VariantManagement");if(!a){a=i}t=i?[e,...t]:[...t,e];return t},[]);if(!a){this._setInitialStatesForDeltaCompute()}o.filter(function(t){return t.isA("sap.ui.base.ManagedObject")}).forEach(t=>{const a=this.getStateKey(t);e=e.then(this.applyControlState.bind(this,t,i?i[a]:undefined,r,n??false))});await e;if(r.navigationType===yt.iAppState||r.navigationType===yt.hybrid){await this.collectResults(this.base.viewState.applyAdditionalStates,i?i[gt]:undefined)}else{await this.collectResults(this.base.viewState.applyNavigationParameters,r);await this.collectResults(this.base.viewState._applyNavigationParametersToFilterbar,r)}}finally{try{await this.collectResults(this.base.viewState.onAfterStateApplied);this._setInitialStateApplied()}catch(e){t.error(e)}}};n._checkIfVariantIdIsAvailable=function t(e,i){const r=e.getVariants();let n=false;r.forEach(function(t){if(t.key===i){n=true}});return n};n._setInitialStateApplied=function t(){if(this._pInitialStateAppliedResolve){const t=this._pInitialStateAppliedResolve;delete this._pInitialStateAppliedResolve;t()}};n._getInitialStateApplied=function t(){return!this._pInitialStateAppliedResolve};n.onBeforeStateApplied=function t(e,i){};n.onAfterStateApplied=function t(e){};n.applyAdditionalStates=function t(e,i){};n._applyNavigationParametersToFilterbar=function t(e,i){};n.applyNavigationParameters=function t(e,i){};n.applyControlState=async function t(e,i,r,n){const a=this.getControlStateHandler(e);let o=Promise.resolve();a.forEach(t=>{if(typeof t.apply!=="function"){throw new Error(`controlStateHandler.apply is not a function for control: ${e.getMetadata().getName()}`)}o=o.then(t.apply.bind(this,e,i,r,n))});return o};n.getInterface=function t(){return this};n._getControlState=function t(e,i){const r=this.initialControlStatesMapper;if(Object.keys(r).length>0&&r[e]){if(Object.keys(r[e]).length===0){r[e]={...i}}return{fullState:i,initialState:r[e]}}return i};n._addEventListenersToVariantManagement=function t(e,i){const r={variantManagedControls:i};const n=()=>{this._updateInitialStatesOnVariantChange(i)};e.attachSave(r,n,{});e.attachSelect(r,n,{})};n._updateInitialStatesOnVariantChange=function t(e){const i=this.initialControlStatesMapper;Object.keys(i).forEach(t=>{for(const r of e){if(r.includes(t)){i[t]={}}}})};n._isInitialStatesApplicable=function t(e,i,r,n){return e&&!this.invalidateInitialStateForApply.includes(i.getId())&&!this.controlsVariantIdUnavailable.includes(i.getId())&&(n??true)&&r!==true};return r}(l),ut(at.prototype,"refreshViewBindings",[d,u],Object.getOwnPropertyDescriptor(at.prototype,"refreshViewBindings"),at.prototype),ut(at.prototype,"adaptBindingRefreshControls",[y,g],Object.getOwnPropertyDescriptor(at.prototype,"adaptBindingRefreshControls"),at.prototype),ut(at.prototype,"refreshControlBinding",[S,h],Object.getOwnPropertyDescriptor(at.prototype,"refreshControlBinding"),at.prototype),ut(at.prototype,"getControlRefreshBindingHandler",[v,b],Object.getOwnPropertyDescriptor(at.prototype,"getControlRefreshBindingHandler"),at.prototype),ut(at.prototype,"adaptBindingRefreshHandler",[w,C],Object.getOwnPropertyDescriptor(at.prototype,"adaptBindingRefreshHandler"),at.prototype),ut(at.prototype,"onSuspend",[A,O],Object.getOwnPropertyDescriptor(at.prototype,"onSuspend"),at.prototype),ut(at.prototype,"onRestore",[I,m],Object.getOwnPropertyDescriptor(at.prototype,"onRestore"),at.prototype),ut(at.prototype,"collectResults",[P,_],Object.getOwnPropertyDescriptor(at.prototype,"collectResults"),at.prototype),ut(at.prototype,"adaptControlStateHandler",[R,E],Object.getOwnPropertyDescriptor(at.prototype,"adaptControlStateHandler"),at.prototype),ut(at.prototype,"getControlStateHandler",[j,B],Object.getOwnPropertyDescriptor(at.prototype,"getControlStateHandler"),at.prototype),ut(at.prototype,"adaptStateControls",[V,D],Object.getOwnPropertyDescriptor(at.prototype,"adaptStateControls"),at.prototype),ut(at.prototype,"getStateKey",[K,x],Object.getOwnPropertyDescriptor(at.prototype,"getStateKey"),at.prototype),ut(at.prototype,"retrieveViewState",[H,M],Object.getOwnPropertyDescriptor(at.prototype,"retrieveViewState"),at.prototype),ut(at.prototype,"retrieveAdditionalStates",[F,T],Object.getOwnPropertyDescriptor(at.prototype,"retrieveAdditionalStates"),at.prototype),ut(at.prototype,"retrieveControlState",[N,k],Object.getOwnPropertyDescriptor(at.prototype,"retrieveControlState"),at.prototype),ut(at.prototype,"applyInitialStateOnly",[$,z],Object.getOwnPropertyDescriptor(at.prototype,"applyInitialStateOnly"),at.prototype),ut(at.prototype,"applyViewState",[L,U],Object.getOwnPropertyDescriptor(at.prototype,"applyViewState"),at.prototype),ut(at.prototype,"_checkIfVariantIdIsAvailable",[q],Object.getOwnPropertyDescriptor(at.prototype,"_checkIfVariantIdIsAvailable"),at.prototype),ut(at.prototype,"onBeforeStateApplied",[G,W],Object.getOwnPropertyDescriptor(at.prototype,"onBeforeStateApplied"),at.prototype),ut(at.prototype,"onAfterStateApplied",[Y,J],Object.getOwnPropertyDescriptor(at.prototype,"onAfterStateApplied"),at.prototype),ut(at.prototype,"applyAdditionalStates",[Q,X],Object.getOwnPropertyDescriptor(at.prototype,"applyAdditionalStates"),at.prototype),ut(at.prototype,"_applyNavigationParametersToFilterbar",[Z],Object.getOwnPropertyDescriptor(at.prototype,"_applyNavigationParametersToFilterbar"),at.prototype),ut(at.prototype,"applyNavigationParameters",[tt,et],Object.getOwnPropertyDescriptor(at.prototype,"applyNavigationParameters"),at.prototype),ut(at.prototype,"applyControlState",[it,rt],Object.getOwnPropertyDescriptor(at.prototype,"applyControlState"),at.prototype),at))||nt);return ht},false);
//# sourceMappingURL=ViewState.js.map