/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ResourceModelHelper","sap/m/Button","sap/m/Dialog","sap/m/MessageBox","sap/m/Text","sap/ui/core/Core","../../helpers/ModelHelper","../../operationsHelper","./draftDataLossPopup"],function(e,t,n,o,r,i,a,s,c,u,d,l,f){"use strict";var g=r.getResourceModel;var h=o.getInvolvedDataModelObjects;const E={EDIT:"EditAction",ACTIVATION:"ActivationAction",DISCARD:"DiscardAction",PREPARE:"PreparationAction"};function P(e,t){const n=e.getModel(),o=n.getMetaModel(),r=o.getMetaPath(e.getPath());return o.getObject(`${r}@com.sap.vocabularies.Common.v1.DraftRoot/${t}`)}function p(e,t,n){const o=P(e,t);return e.getModel().bindContext(`${o}(...)`,e,n)}function m(e,t){const n=e.getModel(),o=n.getMetaModel(),r=o.getMetaPath(e.getPath());return o.getObject(`${r}@com.sap.vocabularies.Common.v1.DraftRoot/${t}/$ReturnType`)}function A(e){return!!P(e,E.PREPARE)}async function v(e,t,n,o,r){if(e.getProperty("IsActiveEntity")){const i={$$inheritExpandSelect:true};const a=R.createOperation(e,E.EDIT,i);a.setParameter("PreserveChanges",t);const s=g(n);const c=s.getText("C_COMMON_OBJECT_PAGE_EDIT");const u=a.execute(o,undefined,l.fnOnStrictHandlingFailed.bind(R,o,{label:c,model:e.getModel()},s,null,null,null,undefined,undefined),e.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding"));if(r){a.getModel().submitBatch(o)}return u}else{throw new Error("You cannot edit this draft document")}}async function D(t,n,o){if(R.getMessagesPath(t)&&R.hasPrepareAction(t)){try{if(!o){await t.getBinding().requestObject("")}const e=await R.executeDraftPreparationAction(t,t.getUpdateGroupId(),true,o);if(e&&!m(t,E.PREPARE)){b(t,n.getSideEffectsService())}return e}catch(t){e.error("Error while requesting messages",t)}}return undefined}async function C(t,n,o){const r=A(t);const i=r;if(!t.getProperty("IsActiveEntity")){const a=p(t,E.ACTIVATION,{$$inheritExpandSelect:true});const s=g(n);const c=s.getText("C_OP_OBJECT_PAGE_SAVE");try{return await a.execute(o,i,o?l.fnOnStrictHandlingFailed.bind(R,o,{label:c,model:t.getModel()},s,null,null,null,undefined,undefined):undefined,t.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding"))}catch(o){if(r){const o=P(t,E.PREPARE),r=n.getSideEffectsService(),i=r.getODataActionSideEffects(o,t),a=i&&i.pathExpressions;if(a&&a.length>0){try{await r.requestSideEffects(a,t)}catch(t){e.error("Error while requesting side effects",t)}}else{try{await b(t,r)}catch(t){e.error("Error while requesting messages",t)}}}throw o}}else{throw new Error("The activation action cannot be executed on an active document")}}function w(e){const t=e.getModel().getMetaModel();const n=t.getMetaPath(e.getPath());const o=m(e,E.PREPARE);return o?t.getObject(`${n}/@${"com.sap.vocabularies.Common.v1.Messages"}/$Path`):null}function M(t,n,o,r){if(!t.getProperty("IsActiveEntity")){const i=o?w(t):null;const a=p(t,E.PREPARE,i?{$select:i}:null);a.setParameter("SideEffectsQualifier","");const s=n||a.getGroupId();return a.execute(s,r).then(function(){return a}).catch(function(t){e.error("Error while executing the operation",t)})}else{throw new Error("The preparation action cannot be executed on an active document")}}function x(e){const t=e.getModel(),n=t.getMetaModel(),o=n.getMetaPath(e.getPath());return n.getObject(`${o}/@com.sap.vocabularies.Common.v1.Messages/$Path`)}function b(e,t){const n=R.getMessagesPath(e);if(n){return t.requestSideEffects([n],e)}return Promise.resolve()}async function y(e,t,n){if(!e.getProperty("IsActiveEntity")){const o=R.createOperation(e,E.DISCARD);const r=t&&g(t);const i="direct";const a=(r===null||r===void 0?void 0:r.getText("C_TRANSACTION_HELPER_DRAFT_DISCARD_BUTTON"))||"";const s=!n?o.execute(i):o.execute(i,undefined,l.fnOnStrictHandlingFailed.bind(R,i,{label:a,model:e.getModel()},r,null,null,null,undefined,undefined),false);e.getModel().submitBatch(i);return s}else{throw new Error("The discard action cannot be executed on an active document")}}async function T(t,n,o,r){if(!n.getPath().startsWith(t.getPath())){e.error("Cannot compute rightmost sibling context");throw new Error("Cannot compute rightmost sibling context")}if(n.getProperty("IsActiveEntity")===false&&n.getProperty("HasActiveEntity")===false){return undefined}const i=t.getModel();try{const e=n.getPath().replace(t.getPath(),"");const c=e?e.substring(1).split("/"):[];c.unshift(t.getPath().substring(1));const u=[];const d=[];let l="";const f=[...c];if(o!==null&&o!==void 0&&o.rootSiblingPathPromise){var a;f.shift();l="/"+(t===null||t===void 0?void 0:(a=t.getPath())===null||a===void 0?void 0:a.substring(1))}const g=f.map(e=>{l+=`/${e}`;u.unshift(l);if(l.endsWith(")")){const e=i.bindContext(`${l}/SiblingEntity`,undefined,r?{$$groupId:r}:undefined).getBoundContext();return e.requestCanonicalPath()}else{return Promise.resolve(undefined)}});const h=await Promise.all(g);if(o!==null&&o!==void 0&&o.rootSiblingPathPromise){var s;const e=(s=await o.rootSiblingPathPromise)===null||s===void 0?void 0:s.getPath();h.unshift(e);u.push(t.getPath())}let E="";h.forEach((e,t)=>{if(t!==0){if(c[t].endsWith(")")){const n=c[t].replace(/\(.*$/,"");const o=e.replace(/.*\(/,"(");E+=`/${n}${o}`}else{E+=`/${c[t]}`}}else{E=e}d.unshift(E)});return{targetContext:i.bindContext(E,undefined,{$$groupId:"$auto.Heroes"}).getBoundContext(),pathMapping:u.map((e,t)=>({oldPath:e,newPath:d[t]}))}}catch(e){return undefined}}async function O(e,o,r,i){const a=r||{},c=typeof a.bPreserveChanges==="undefined"||typeof a.bPreserveChanges==="boolean"&&a.bPreserveChanges;async function u(t){const o=e.getModel();const a=o.bindContext(`${e.getPath()}/DraftAdministrativeData`).getBoundContext();const c=g(r.oView);const u=await a.requestObject();if(u){n.removeUnboundTransitionMessages();let t=u.InProcessByUserDescription||u.InProcessByUser;const o=r.oView.getViewData().entitySet;if(t){const e=c.getText("C_DRAFT_OBJECT_PAGE_DRAFT_LOCKED_BY_USER",t,o);s.error(e);throw new Error(e)}else{t=u.CreatedByUserDescription||u.CreatedByUser;const n=c.getText("C_DRAFT_OBJECT_PAGE_DRAFT_UNSAVED_CHANGES",t,o);await R.showEditConfirmationMessageBox(n,e);return R.executeDraftEditAction(e,false,r.oView,i,true)}}else if(t!==null&&t!==void 0&&t.message){s.error(t.message)}throw new Error(`Draft creation aborted for document: ${e.getPath()}`)}if(!e){throw new Error("Binding context to active document is required")}let d;try{d=await R.executeDraftEditAction(e,c,r.oView,i)}catch(o){if(o.status===409||o.status===423){n.removeBoundTransitionMessages();n.removeUnboundTransitionMessages();const r=await R.computeSiblingInformation(e,e);if(r!==null&&r!==void 0&&r.targetContext){await t.waitForContextRequested(r.targetContext);return r.targetContext}else{d=await u(o)}}else if(!(o&&o.canceled)){throw new Error(o)}}if(d){var l;const e=R.getActionName(d,E.EDIT);const t=o.getSideEffectsService().getODataActionSideEffects(e,d);if(t!==null&&t!==void 0&&(l=t.triggerActions)!==null&&l!==void 0&&l.length){await o.getSideEffectsService().requestSideEffectsForODataAction(t,d);return d}else{return d}}else{return undefined}}async function S(e,t,n,o){const r=n||{};if(!e){throw new Error("Binding context to draft document is required")}const i=r.fnBeforeActivateDocument?await r.fnBeforeActivateDocument(e):true;if(!i){throw new Error(`Activation of the document was aborted by extension for document: ${e.getPath()}`)}let a;if(!A(e)){a=await C(e,t)}else{const n="$auto";const r=e.getModel().hasPendingChanges("$auto")?true:false;let i=R.executeDraftPreparationAction(e,n,undefined,r);e.getModel().submitBatch(n);const s=R.executeDraftActivationAction(e,t,n);try{const e=await Promise.all([i,s]);a=e[1]}catch(t){const r=w(e);if(r){i=R.executeDraftPreparationAction(e,n,true);e.getModel().submitBatch(n);await i;const t=await e.requestObject();if(t[r].length>0){o===null||o===void 0?void 0:o.removeTransitionMessages(false,false,e.getPath())}}throw t}}return r.fnAfterActivateDocument?r.fnAfterActivateDocument(e,a):a}function _(e,t){const n=u.getLibraryResourceBundle("sap.fe.core");return new Promise(function(o,r){const s=new a({title:n.getText("C_MESSAGE_HANDLING_SAPFE_ERROR_MESSAGES_PAGE_TITLE_WARNING"),state:"Warning",content:new c({text:e}),beginButton:new i({text:n.getText("C_COMMON_OBJECT_PAGE_EDIT"),type:"Emphasized",press:function(){s.close();o(true)}}),endButton:new i({text:n.getText("C_COMMON_OBJECT_PAGE_CANCEL"),press:function(){s.close();r(`Draft creation aborted for document: ${t.getPath()}`)}}),afterClose:function(){s.destroy()}});s.addStyleClass("sapUiContentPadding");s.open()})}function B(e,t,n){const o=P(e,E.DISCARD),r=e.getObject().IsActiveEntity;if(r||!r&&!o){if(e.hasPendingChanges()){return e.getBinding().resetChanges().then(function(){return e.delete()}).catch(function(e){return Promise.reject(e)})}else{var i;return!e.getProperty("IsActiveEntity")&&e.getProperty("HasActiveEntity")&&d.isDraftRoot((i=h(e.getModel().getMetaModel().getMetaContext(e.getPath())))===null||i===void 0?void 0:i.targetEntitySet)?e.getModel().delete(e):e.delete()}}else{return y(e,t,n)}}const R={createDraftFromActiveDocument:O,activateDocument:S,deleteDraft:B,executeDraftEditAction:v,executeDraftValidation:D,executeDraftPreparationAction:M,executeDraftActivationAction:C,hasPrepareAction:A,getMessagesPath:x,computeSiblingInformation:T,processDataLossOrDraftDiscardConfirmation:f.processDataLossOrDraftDiscardConfirmation,silentlyKeepDraftOnForwardNavigation:f.silentlyKeepDraftOnForwardNavigation,createOperation:p,executeDraftDiscardAction:y,NavigationType:f.NavigationType,getActionName:P,showEditConfirmationMessageBox:_};return R},false);
//# sourceMappingURL=draft.js.map