/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/ActionRuntime","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/BusyLocker","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/controllerextensions/editFlow/operations","sap/fe/core/controllerextensions/editFlow/sticky","sap/fe/core/controllerextensions/messageHandler/messageHandling","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/DeleteHelper","sap/fe/core/helpers/FPMHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/library","sap/m/Button","sap/m/Dialog","sap/m/MessageBox","sap/m/MessageToast","sap/m/Popover","sap/m/Text","sap/m/VBox","sap/ui/core/Core","sap/ui/core/Fragment","sap/ui/core/XMLTemplateProcessor","sap/ui/core/library","sap/ui/core/util/XMLPreprocessor","sap/ui/model/json/JSONModel","../../converters/annotations/DataField","../../helpers/MetaModelFunction","../../helpers/ToES6Promise","../../helpers/TypeGuards"],function(e,t,n,a,o,i,r,s,l,c,d,u,g,f,C,p,h,m,v,E,b,y,D,A,M,w,x,T,P,_,O,I){"use strict";var S=I.isNavigationProperty;var N=_.getRequiredPropertiesFromInsertRestrictions;var R=_.getNonComputedVisibleFields;var B=P.isDataFieldForAction;var L=f.generate;var k=g.getResourceModel;var F=l.getInvolvedDataModelObjects;const H=C.CreationMode;const U=C.ProgrammingModel;const j=c.DeleteOptionTypes;const $=c.DeleteDialogContentControl;function V(e){if(e&&e.getMetadata&&e.getMetadata().getName()==="sap.ui.base.Event"){e={}}return e||{}}let W=function(){function l(){}var g=l.prototype;g.busyLock=function e(t,n){a.lock(t.getModel("ui"),n)};g.busyUnlock=function e(t,n){a.unlock(t.getModel("ui"),n)};g.getProgrammingModel=function e(t){let n;if(t.isA("sap.ui.model.odata.v4.Context")){n=t.getPath()}else{n=(t.isRelative()?t.getResolvedPath():t.getPath())??""}const a=t.getModel().getMetaModel();if(u.isDraftSupported(a,n)){return U.Draft}else if(u.isStickySessionSupported(a)){return U.Sticky}else{return U.NonDraft}};g.validateDocument=function e(t,n,a){const o=n&&n.customValidationFunction;if(o){const e=o.substring(0,o.lastIndexOf(".")||-1).replace(/\./gi,"/"),i=o.substring(o.lastIndexOf(".")+1,o.length),r=n.data;delete r["@$ui5.context.isTransient"];return d.validationWrapper(e,i,r,a,t)}return Promise.resolve([])};g.getDataFromDefaultValueFunction=async function e(t){var n,a,o,r;const s=t.getModel();const l=s.getMetaModel();const c=l.getMetaContext(t.getResolvedPath());const d=F(c);const u=(n=d.targetObject.annotations.Common)===null||n===void 0?void 0:n.DefaultValuesFunction;const g=(a=d.targetEntitySet)===null||a===void 0?void 0:(o=a.annotations.Common)===null||o===void 0?void 0:o.DefaultValuesFunction;const f=u??g;if(!f){return undefined}const C=S(d.targetObject)&&u!==undefined;const p=C?t.getContext():t.getHeaderContext();if(!p){return undefined}const h=`${l.getMetaPath(p.getPath())}/${f}`;const m=F(l.getMetaContext(h));const v=(r=m.targetObject)!==null&&r!==void 0&&r.isBound?await i.callBoundFunction(f.toString(),p,s):await i.callFunctionImport(f.toString(),s);return v.getObject()};g.isListBindingHierarchical=function e(t){var n;return(n=t.getAggregation())!==null&&n!==void 0&&n.hierarchyQualifier?true:false};g.createContext=async function e(t,n,a){const o=n??{};if(this.isListBindingHierarchical(t)){var i;if(((i=a.parentContext)===null||i===void 0?void 0:i.isExpanded())===false){await t.expand(a.parentContext)}Object.assign(o,{"@$ui5.node.parent":a.parentContext});return t.create(o,true)}else{return t.create(o,true,a.createAtEnd,a.createInactive)}};g.getCreationParameters=function e(t,n,a){const o=t.getModel().getMetaModel();const i=o.getMetaPath(t.getHeaderContext().getPath());const r=R(o,i,a);return r.filter(e=>!(e in(n??{})))};g.createDocument=async function t(n,a,o,i,r){const s=n.getModel(),l=s.getMetaModel(),c=l.getMetaPath(n.getHeaderContext().getPath()),d=o.getRouterProxy().getHash(),u=o.getComponentData(),g=u&&u.startupParameters||{},f=!n.isRelative()?this._getNewAction(g,d,l,c):undefined;const p={$$patchWithoutSideEffects:true};const h=l.getObject(`${c}/@com.sap.vocabularies.Common.v1.Messages/$Path`);let m="/busy";let v;if(h){p["$select"]=h}const E=V(a);if(!n){throw new Error("Binding required for new document creation")}const b=this.getProgrammingModel(n);if(b!==U.Draft&&b!==U.Sticky){throw new Error("Create document only allowed for draft or sticky session supported services")}if(E.busyMode==="Local"){m=`/busyLocal/${E.busyId}`}E.beforeCreateCallBack=r?null:E.beforeCreateCallBack;if(!(a!==null&&a!==void 0&&a.inactive)){this.busyLock(o,m)}const y=D.getLibraryResourceBundle("sap.fe.core");let A;try{if(f){A=await this.callAction(f,{contexts:n.getHeaderContext(),showActionParameterDialog:true,label:this._getSpecificCreateActionDialogLabel(l,c,f,y),bindingParameters:p,parentControl:E.parentControl,bIsCreateAction:true,skipParameterDialog:E.skipParameterDialog},null,o,i)}else{try{const e=E.data;if(!r){const e=await this.getDataFromDefaultValueFunction(n);E.data=Object.assign({},e,E.data)}if(E.data){delete E.data["@odata.context"]}const t=E.creationMode!==H.CreationRow&&E.creationMode!==H.Inline;const a=t?this.getCreationParameters(n,e,o):[];if(a.length>0){A=await this._launchDialogWithKeyFields(n,a,s,E,o,i);v=A.newContext}else{if(E.beforeCreateCallBack){await O(E.beforeCreateCallBack({contextPath:n&&n.getPath()}))}v=await this.createContext(n,E.data,{createAtEnd:!!E.createAtEnd,createInactive:!!E.inactive,parentContext:E.parentContext});if(!E.inactive){A=await this.onAfterCreateCompletion(n,v,E)}}}catch(t){e.error("Error while creating the new document",t);throw t}}v=v||A;await i.showMessageDialog({control:E.parentControl});return v}catch(e){var M;await i.showMessageDialog({control:E.parentControl});if((e===C.Constants.ActionExecutionFailed||e===C.Constants.CancelActionDialog)&&(M=v)!==null&&M!==void 0&&M.isTransient()){v.delete("$direct")}throw e}finally{if(!(a!==null&&a!==void 0&&a.inactive)){this.busyUnlock(o,m)}}};g._isDraftEnabled=function e(t){const n=t[0];const a=this.getProgrammingModel(n);return a===U.Draft};g.deleteDocument=function e(t,n,a,o,i){this.busyLock(a);const r=Array.isArray(t)?[...t]:[t];return new Promise((e,t)=>{try{const l=this._isDraftEnabled(n.selectedContexts||r);const d=[];let u=[];let g;if(n){if(!n.numberOfSelectedContexts){if(l){const e=r.find(e=>{const t=e.getObject();return t.IsActiveEntity===true&&t.HasDraftEntity===true&&t.DraftAdministrativeData&&t.DraftAdministrativeData.InProcessByUser&&!t.DraftAdministrativeData.DraftIsCreatedByMe});if(e){const n=e.getObject().DraftAdministrativeData.InProcessByUser;m.show(o.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_SINGLE_OBJECT_LOCKED",[n]),{title:o.getText("C_COMMON_DELETE"),onClose:t});return}else{g=r.find(e=>{const{IsActiveEntity:t,HasDraftEntity:n,DraftAdministrativeData:a}=e.getObject()||{};return t===true&&n===true&&!!(a!==null&&a!==void 0&&a.InProcessByUser)})}}n=V(n);let e="";if(g){const t=g.getObject().DraftAdministrativeData.InProcessByUser;e=o.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_CHANGES",[t],n.entitySetName)}else if(n.title){if(n.description){e=o.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO",[n.title,n.description],n.entitySetName)}else{e=o.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_ONLY",[n.title],n.entitySetName)}}else{e=o.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",undefined,n.entitySetName)}u.push({type:j.deletableContexts,contexts:r,text:e,selected:true,control:$.TEXT})}else{let e=r.length;if(l){e+=n.draftsWithNonDeletableActive.length+n.draftsWithDeletableActive.length+n.unSavedContexts.length;c.updateDraftOptionsForDeletableTexts(n,r,e,o,d,u)}else{const t=c.getNonDeletableText(n,e,o);if(t){d.push(t)}}const t=c.getOptionsForDeletableTexts(n,r,o);u=[...u,...t]}}const f=(n.selectedContexts??r)[0].getBinding();const C=f.isA("sap.ui.model.odata.v4.ODataListBinding")&&this.isListBindingHierarchical(f);c.updateContentForDeleteDialog(u,d);const p=async()=>{s.removeBoundTransitionMessages();this.busyLock(a);try{await c.deleteConfirmHandler(u,n,i,o,a,l,C);e()}catch(e){t()}finally{this.busyUnlock(a)}};const h=this.createDeleteDialog(d,n,o,p,t);if(n.noDialog){p()}else{h.addStyleClass("sapUiContentPadding");h.open()}}finally{this.busyUnlock(a)}})};g.createDeleteDialog=function e(t,n,a,o,i){var r;let s=false;const l=new y({items:t});const c=D.getLibraryResourceBundle("sap.fe.core");let d;if((r=n.parentControl)!==null&&r!==void 0&&r.isA("sap.ui.mdc.Table")){d=a.getText("M_COMMON_TABLE_DELETE",undefined,n.entitySetName)}else{d=c.getText("C_COMMON_DELETE")}const u=new h({title:d,state:"Warning",content:[l],ariaLabelledBy:t,beginButton:new p({text:d,type:"Emphasized",press:function(){s=true;u.close();o()}}),endButton:new p({text:a.getText("C_COMMON_DIALOG_CANCEL"),press:function(){u.close()}}),afterClose:function(){u.destroy();if(!s){i()}}});return u};g.editDocument=async function e(t,n,a,i,s){const l=this.getProgrammingModel(t);if(!t){throw new Error("Binding context to active document is required")}if(l!==U.Draft&&l!==U.Sticky){throw new Error("Edit is only allowed for draft or sticky session supported services")}this.busyLock(a);i.removeTransitionMessages();try{const e=l===U.Draft?await o.createDraftFromActiveDocument(t,a,{bPreserveChanges:true,oView:n},s):await r.editDocumentInStickySession(t,a);await i.showMessageDialog();return e}catch(e){await i.showMessages({concurrentEditFlag:true});throw e}finally{this.busyUnlock(a)}};g.cancelDocument=async function e(t,n,a,i,s,l,c){if(!t){throw new Error("No context exists. Pass a meaningful context")}this.busyLock(a);const d=V(n);const u=t.getModel();const g=this.getProgrammingModel(t);if(g!==U.Draft&&g!==U.Sticky){throw new Error("Cancel document only allowed for draft or sticky session supported services")}try{let e=false;if(g===U.Draft&&!c){const e=u.bindContext(`${t.getPath()}/DraftAdministrativeData`).getBoundContext();const n=await e.requestObject();if(n){c=n.CreationDateTime!==n.LastChangeDateTime}}if(!d.skipDiscardPopover){await this._confirmDiscard(d.cancelButton,c,i)}if(t.isKeepAlive()){t.setKeepAlive(true,undefined)}if(d.beforeCancelCallBack){await d.beforeCancelCallBack({context:t})}if(g===U.Draft){if(l){if(t.hasPendingChanges()){t.getBinding().resetChanges()}e=await o.deleteDraft(t,a)}else{const n=u.bindContext(`${t.getPath()}/SiblingEntity`).getBoundContext();try{const a=await n.requestCanonicalPath();if(t.hasPendingChanges()){t.getBinding().resetChanges()}e=u.bindContext(a).getBoundContext()}finally{await o.deleteDraft(t,a)}}}else{const n=await r.discardDocument(t);if(n){if(n.hasPendingChanges()){n.getBinding().resetChanges()}if(!l){n.refresh();e=n}}}s.removeTransitionMessages();await s.showMessages();return e}catch(e){await s.showMessages();throw e}finally{this.busyUnlock(a)}};g.saveDocument=async function e(t,a,i,l,c,d,u){const g=this.getProgrammingModel(t);if(g!==U.Sticky&&g!==U.Draft){throw new Error("Save is only allowed for draft or sticky session supported services")}try{this.busyLock(a);const e=g===U.Draft?await o.activateDocument(t,a,{},d):await r.activateDocument(t,a);const n=s.getMessages().concat(s.getMessages(true,true));if(!(n.length===1&&n[0].type===w.MessageType.Success)){v.show(u?i.getText("C_TRANSACTION_HELPER_OBJECT_CREATED"):i.getText("C_TRANSACTION_HELPER_OBJECT_SAVED"))}return e}catch(e){if(l&&(c===null||c===void 0?void 0:c.length)>0){c.forEach(e=>{if(!n.hasTransientContext(e)){a.getSideEffectsService().requestSideEffectsForNavigationProperty(e.getPath(),t)}})}await d.showMessages();throw e}finally{this.busyUnlock(a)}};g.callAction=async function e(t,n,a,o,r,s){n=V(n);let l,c;const d=n.bindingParameters;if(!t){throw new Error("Provide name of action to be executed")}const u=t.split("/")[1];t=u||t;l=u?undefined:n.contexts;if(l&&(Array.isArray(l)&&l.length||!Array.isArray(l))){l=Array.isArray(l)?l[0]:l;c=l.getModel()}if(n.model){c=n.model}if(!c){throw new Error("Pass a context for a bound action or pass the model for an unbound action")}const g=o.getSideEffectsService().getODataActionSideEffects(t,l)||{};try{let e;if(l&&c){e=await i.callBoundAction(t,n.contexts,c,o,{parameterValues:n.parameterValues,invocationGrouping:n.invocationGrouping,label:n.label,skipParameterDialog:n.skipParameterDialog,mBindingParameters:d,entitySetName:n.entitySetName,additionalSideEffect:g,onSubmitted:()=>{r===null||r===void 0?void 0:r.removeTransitionMessages();this.busyLock(o)},onResponse:()=>{this.busyUnlock(o)},parentControl:n.parentControl,controlId:n.controlId,internalModelContext:n.internalModelContext,operationAvailableMap:n.operationAvailableMap,bIsCreateAction:n.bIsCreateAction,bGetBoundContext:n.bGetBoundContext,bObjectPage:n.bObjectPage,messageHandler:r,defaultValuesExtensionFunction:n.defaultValuesExtensionFunction,selectedItems:n.contexts,disableStrictHandling:s,groupId:n.groupId})}else{e=await i.callActionImport(t,c,o,{parameterValues:n.parameterValues,label:n.label,skipParameterDialog:n.skipParameterDialog,bindingParameters:d,entitySetName:n.entitySetName,onSubmitted:()=>{this.busyLock(o)},onResponse:()=>{this.busyUnlock(o)},parentControl:n.parentControl,internalModelContext:n.internalModelContext,operationAvailableMap:n.operationAvailableMap,messageHandler:r,bObjectPage:n.bObjectPage})}if(r){await this._handleActionResponse(r,n,t)}return e}catch(e){if(r){await this._handleActionResponse(r,n,t)}throw e}};g._handleActionResponse=function e(t,n,a){const o=s.getMessages(true,true);const i=n.label?n.label:a;if(o.length>0&&n&&n.internalModelContext){n.internalModelContext.setProperty("sActionName",n.label?n.label:a)}let r;if(n.controlId){r=n.parentControl.byId(n.controlId)}else{r=n.parentControl}return t.showMessages({sActionName:i,control:r})};g.handleValidationError=function e(){const t=D.getMessageManager(),n=t.getMessageModel().getData().filter(function(e){if(e.validation){return e}});t.removeMessages(n)};g._createPopover=function e(t){return new E(t)};g._confirmDiscard=function e(t,n,a){if(!n){this.handleValidationError();return Promise.resolve()}t.setEnabled(false);return new Promise((e,n)=>{const o=this._createPopover({showHeader:false,placement:"Top"});o.addStyleClass("sapUiContentPadding");const i=new b({text:a.getText("C_TRANSACTION_HELPER_DRAFT_DISCARD_MESSAGE")});const r=new p({text:a.getText("C_TRANSACTION_HELPER_DRAFT_DISCARD_BUTTON"),width:"100%",press:()=>{this.handleValidationError();o.data("continueDiscard",true);o.close()}});o.addContent(new y({items:[i,r]}));o.attachBeforeOpen(()=>{o.setInitialFocus(r)});o.attachAfterClose(()=>{t.setEnabled(true);if(o.data("continueDiscard")){e()}else{n()}});o.openBy(t,false)})};g._launchDialogWithKeyFields=function e(o,i,r,s,l,c){let d;const u=s.parentControl;const g=r.bindList(o.getPath(),o.getContext(),[],[],{$$updateGroupId:"submitLater"});g.refreshInternal=function(){};const f=g.create(s.data,true);return new Promise(async(e,p)=>{const m="sap/fe/core/controls/NonComputedVisibleKeyFieldsDialog";const v=M.loadTemplate(m,"fragment"),E=k(u),b=r.getMetaModel(),y=[],w=o.isRelative()?o.getResolvedPath():o.getPath(),P=b.createBindingContext(w),_=b.getMetaPath(w);for(const e in i){y.push(b.createBindingContext(`${_}/${i[e]}`))}const I=new T(y);const S=I.createBindingContext("/");const R=N(_,b);const B=new T(R);const F=B.createBindingContext("/");const H=await x.process(v,{name:m},{bindingContexts:{entitySet:P,fields:S,requiredProperties:F},models:{entitySet:P.getModel(),fields:S.getModel(),metaModel:b,requiredProperties:B}});let U=[];const j={};const $=D.getMessageManager();const V=e=>{const t=$.getMessageModel().getData();const n=t.filter(t=>t.getControlIds().some(t=>t.includes(e)));$.removeMessages(n)};let W;const G={handleChange:async e=>{const t=e.getParameter("id");const n=e.getSource();const a=W.find(e=>e.field===n);V(t);a.validationPromise=e.getParameter("promise");try{a.value=await a.validationPromise;a.hasError=false}catch(e){delete a.value;a.hasError=true}},handleLiveChange:e=>{const t=e.getParameter("id");V(t)}};const q=await A.load({definition:H,controller:G});let K;let J=false;d=new h(L(["CreateDialog",_]),{title:E.getText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE"),content:[q],beginButton:{text:E.getText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE_BUTTON"),type:"Emphasized",press:async e=>{if(!await t.validateProperties($,W,E)){return}a.lock(d);s.bIsCreateDialog=true;try{const e=await Promise.all(Object.keys(j).map(async function(e){const t=await j[e];const n={};n[e]=t;return n}));if(s.beforeCreateCallBack){await O(s.beforeCreateCallBack({contextPath:o&&o.getPath(),createParameters:e}))}const t=f.getObject();const n={};Object.keys(t).forEach(function(e){const a=b.getObject(`${_}/${e}`);if(a&&a.$kind==="NavigationProperty"){return}n[e]=t[e]});const a=await this.createContext(o,n,{createAtEnd:!!s.createAtEnd,createInactive:!!s.inactive,parentContext:s.parentContext});const i=this.onAfterCreateCompletion(o,a,s);let r=await i;if(!r||r&&r.bKeepDialogOpen!==true){r=r??{};d.setBindingContext(null);r.newContext=a;J=true;K={response:r};d.close()}}catch(e){if(e!==C.Constants.CreationFailed){K={error:e};d.close()}}finally{a.unlock(d);c.showMessages()}}},endButton:{text:E.getText("C_COMMON_ACTION_PARAMETER_DIALOG_CANCEL"),press:function(){K={error:C.Constants.CancelActionDialog};d.close()}},beforeClose:function(){var t;for(const e of W){const t=e.field.getId();V(t)}(t=d.getBindingContext("internal"))===null||t===void 0?void 0:t.setProperty("isCreateDialogOpen",false);d.destroy();g.destroy();if(J){e(K.response)}else{var n;p(((n=K)===null||n===void 0?void 0:n.error)??C.Constants.CancelActionDialog)}}});U=q===null||q===void 0?void 0:q.getAggregation("form").getAggregation("formContainers")[0].getAggregation("formElements");if(u&&u.addDependent){u.addDependent(d)}d.setBindingContext(f);try{await n.setUserDefaults(l,y,f,false,s.createAction,s.data);W=U.map(e=>{const t=e.getFields()[0];const n=t.isA("sap.ui.mdc.MultiValueField");return{parameter:e,isMultiValue:n,field:t,value:n?t.getItems():t.getValue(),validationPromise:undefined,hasError:false}});d.getBindingContext("internal").setProperty("isCreateDialogOpen",true);d.open()}catch(e){await c.showMessages();throw e}})};g.onAfterCreateCompletion=function t(n,a,o){let i;const r=new Promise(e=>{i=e});const s=e=>{const t=e.getParameter("context"),o=e.getParameter("success");if(t===a){n.detachCreateCompleted(s,this);i(o)}};const l=()=>{a.created().then(undefined,function(){e.trace("transient creation context deleted")}).catch(function(t){e.trace("transient creation context deletion error",t)})};n.attachCreateCompleted(s,this);return r.then(e=>{if(!e){if(!o.keepTransientContextOnFailed){l();n.resetChanges();n.getModel().resetChanges(n.getUpdateGroupId());throw C.Constants.CreationFailed}return{bKeepDialogOpen:true}}else{return a.created()}})};g._getNewAction=function e(t,n,a,o){let i;if(t&&t.preferredMode&&n.toUpperCase().includes("I-ACTION=CREATEWITH")){const e=t.preferredMode[0];i=e.toUpperCase().indexOf("CREATEWITH:")>-1?e.substr(e.lastIndexOf(":")+1):undefined}else if(t&&t.preferredMode&&n.toUpperCase().includes("I-ACTION=AUTOCREATEWITH")){const e=t.preferredMode[0];i=e.toUpperCase().indexOf("AUTOCREATEWITH:")>-1?e.substr(e.lastIndexOf(":")+1):undefined}else{i=a&&a.getObject!==undefined?a.getObject(`${o}@com.sap.vocabularies.Session.v1.StickySessionSupported/NewAction`)||a.getObject(`${o}@com.sap.vocabularies.Common.v1.DraftRoot/NewAction`):undefined}return i};g._getSpecificCreateActionDialogLabel=function e(t,n,a,o){var i;const r=t===null||t===void 0?void 0:t.getObject(`${n}/@com.sap.vocabularies.UI.v1.LineItem`);const s=r===null||r===void 0?void 0:(i=r.find(e=>B(e)&&e.Action.split("(",1)[0]===a))===null||i===void 0?void 0:i.Label;return s||(t===null||t===void 0?void 0:t.getObject(`${n}/${a}@com.sap.vocabularies.Common.v1.Label`))||(o===null||o===void 0?void 0:o.getText("C_TRANSACTION_HELPER_SAPFE_ACTION_CREATE"))};return l}();const G=new W;return G},false);
//# sourceMappingURL=TransactionHelper.js.map