/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/helpers/Aggregation","sap/fe/core/converters/helpers/IssueManager","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/FilterTemplating"],function(t,e,i,o,n,l){"use strict";var a={};var r=l.isPropertyFilterable;var v=l.getIsRequired;var d=n.checkFilterExpressionRestrictions;var s=o.isEntitySet;var u=i.not;var g=i.compileExpression;var c=e.IssueType;var f=e.IssueSeverity;var p=e.IssueCategory;var P=t.AggregationHelper;const y=function(t,e,i){var o,n,l,a;let r,v,d;let s;const u=i.getCustomAggregateDefinitions();let g=i.getTransAggregations();let c=[];if(e!==null&&e!==void 0&&(o=e.$target)!==null&&o!==void 0&&o.Measures){var f,p,P;c=u.filter(function(t){var i,o,n;return t.qualifier===(e===null||e===void 0?void 0:(i=e.$target)===null||i===void 0?void 0:(o=i.Measures)===null||o===void 0?void 0:(n=o[0])===null||n===void 0?void 0:n.value)});s=c.length>0?c[0].qualifier:e===null||e===void 0?void 0:(f=e.$target)===null||f===void 0?void 0:(p=f.Measures)===null||p===void 0?void 0:(P=p[0])===null||P===void 0?void 0:P.value}if(!c[0]&&e!==null&&e!==void 0&&(n=e.$target)!==null&&n!==void 0&&n.DynamicMeasures){var y,h;s=t.getConverterContextFor(t.getAbsoluteAnnotationPath((y=e.$target.DynamicMeasures)===null||y===void 0?void 0:(h=y[0])===null||h===void 0?void 0:h.value)).getDataModelObjectPath().targetObject.Name;g=i.getAggregatedProperties("AggregatedProperty")}else{g=i.getAggregatedProperties("AggregatedProperties")[0]}const m=e===null||e===void 0?void 0:(l=e.$target)===null||l===void 0?void 0:(a=l.Dimensions[0])===null||a===void 0?void 0:a.value;if(u.some(function(t){return t.qualifier===s})){r=s}else if(g&&g[0]){g.some(function(t){if(t.Name===s){r=t===null||t===void 0?void 0:t.AggregatableProperty.value}})}const A=i.getAggregatableProperties();const L=i.getGroupableProperties();if(A&&A.length){for(const t of A){var I;if((t===null||t===void 0?void 0:(I=t.Property)===null||I===void 0?void 0:I.value)===r){d=true}}}if(L&&L.length){for(const t of L){if((t===null||t===void 0?void 0:t.value)===m){v=true}}}return d&&v};function h(t,e,i,o){var n;let l;const a=o[i];if(a!==null&&a!==void 0&&(n=a.visualFilter)!==null&&n!==void 0&&n.valueList){var h,A,L,I,E,C;const o=a===null||a===void 0?void 0:(h=a.visualFilter)===null||h===void 0?void 0:h.valueList;const n=o.split("#");const ft=n.length>1?`ValueList#${n[1]}`:n[0];const pt=t.resolvePath(i);const Pt=pt===null||pt===void 0?void 0:(A=pt.annotations)===null||A===void 0?void 0:(L=A.Common)===null||L===void 0?void 0:L[ft];const yt=(pt===null||pt===void 0?void 0:(I=pt.annotations)===null||I===void 0?void 0:(E=I.Common)===null||E===void 0?void 0:(C=E.ValueListWithFixedValues)===null||C===void 0?void 0:C.valueOf())||false;if(Pt){var S,D;const t=Pt===null||Pt===void 0?void 0:Pt.CollectionPath.toString();const o=e.getConverterContextFor(`/${t||((S=e.getEntitySet())===null||S===void 0?void 0:S.name)}`);const n=Pt===null||Pt===void 0?void 0:Pt.Parameters;let a;const h=[];let A=[];const L=o.getParameterEntityType();A=L?L.keys.map(function(t){return t.name}):[];if(e.getContextPath()===o.getContextPath()){m(h,A,true)}if(n){for(const t of n){var V;const e=(V=t.LocalDataProperty)===null||V===void 0?void 0:V.value;const n=t.ValueListProperty;if(((t===null||t===void 0?void 0:t.$Type)==="com.sap.vocabularies.Common.v1.ValueListParameterInOut"||(t===null||t===void 0?void 0:t.$Type)==="com.sap.vocabularies.Common.v1.ValueListParameterOut")&&i===e){a=t}if(((t===null||t===void 0?void 0:t.$Type)==="com.sap.vocabularies.Common.v1.ValueListParameterInOut"||(t===null||t===void 0?void 0:t.$Type)==="com.sap.vocabularies.Common.v1.ValueListParameterIn")&&i!==e){const t=r(o,n);if(!t){h.push({localDataProperty:e,valueListProperty:n})}}}}if(h&&h.length){h.forEach(function(t){const n=g(d(e.getConverterContextFor(e.getAbsoluteAnnotationPath(t===null||t===void 0?void 0:t.localDataProperty)).getDataModelObjectPath(),["SingleValue"]));const l=g(d(o.getConverterContextFor(o.getAbsoluteAnnotationPath(t===null||t===void 0?void 0:t.valueListProperty)).getDataModelObjectPath(),["SingleValue"]));if(l==="true"&&n==="false"){throw new Error(`FilterRestrictions of ${i} in MainEntitySet and ValueListEntitySet are different`)}})}const I=Pt===null||Pt===void 0?void 0:Pt.PresentationVariantQualifier;const E=Pt===null||Pt===void 0?void 0:Pt.SelectionVariantQualifier;const C=o===null||o===void 0?void 0:(D=o.getEntityType().annotations.UI)===null||D===void 0?void 0:D[`PresentationVariant#${I}`];const ft=new P(o.getEntityType(),o);if(!ft.isAnalyticsSupported()){return undefined}if(C){var $;const n=C===null||C===void 0?void 0:C.Visualizations;const r=`/${Pt===null||Pt===void 0?void 0:Pt.CollectionPath}`||`/${o===null||o===void 0?void 0:($=o.getEntitySet())===null||$===void 0?void 0:$.name}`;l={};l.contextPath=r;l.isValueListWithFixedValues=yt;let P;for(const t of n){var T;if(((T=t.$target)===null||T===void 0?void 0:T.term)==="com.sap.vocabularies.UI.v1.Chart"){P=t;break}}if(P){var F,M,O,R,b,x,N,U,H,q,w,j,_,Q;const r=y(o,P,ft);if(!r){return}const I=(F=P)===null||F===void 0?void 0:(M=F.$target)===null||M===void 0?void 0:(O=M.Dimensions[0])===null||O===void 0?void 0:(R=O.$target)===null||R===void 0?void 0:(b=R.annotations)===null||b===void 0?void 0:(x=b.UI)===null||x===void 0?void 0:(N=x.Hidden)===null||N===void 0?void 0:N.valueOf();const S=(U=P)===null||U===void 0?void 0:(H=U.$target)===null||H===void 0?void 0:(q=H.Dimensions[0])===null||q===void 0?void 0:(w=q.$target)===null||w===void 0?void 0:(j=w.annotations)===null||j===void 0?void 0:(_=j.UI)===null||_===void 0?void 0:(Q=_.HiddenFilter)===null||Q===void 0?void 0:Q.valueOf();if(I===true||S===true){return}else if(n&&n.length){var k,G,W,z,B,J,K,X,Y,Z,tt;l.chartAnnotation=P.$target?o===null||o===void 0?void 0:o.getAbsoluteAnnotationPath(`${P.$target.fullyQualifiedName}/$AnnotationPath/`):undefined;const n=(k=o.getEntitySet())===null||k===void 0?void 0:k.name;let r;const y=o===null||o===void 0?void 0:o.getRelativeAnnotationPath(`${C.fullyQualifiedName}/`,o.getEntityType());if(L){r=o.getContextPath()+"/"+y}else{r="/"+n+"/"+y}l.presentationAnnotation=C?r:undefined;l.outParameter=(G=a)===null||G===void 0?void 0:(W=G.LocalDataProperty)===null||W===void 0?void 0:W.value;l.inParameters=h;l.valuelistProperty=(z=a)===null||z===void 0?void 0:z.ValueListProperty;const I=d(e.getConverterContextFor(e.getAbsoluteAnnotationPath(i)).getDataModelObjectPath(),["SingleRange","MultiRange"]);if(g(I)==="true"){e.getDiagnostics().addIssue(p.Annotation,f.High,c.MALFORMED_VISUALFILTERS.VALUELIST);return undefined}const S=d(e.getConverterContextFor(e.getAbsoluteAnnotationPath(i)).getDataModelObjectPath(),["SingleValue"]);l.multipleSelectionAllowed=g(u(S));l.required=v(e,i);let D;if(E){var et,it;D=o===null||o===void 0?void 0:(et=o.getEntityTypeAnnotation(`@UI.SelectionVariant#${E}`))===null||et===void 0?void 0:et.annotation;let t;const e=o===null||o===void 0?void 0:o.getRelativeAnnotationPath(`${(it=D)===null||it===void 0?void 0:it.fullyQualifiedName}/`,o.getEntityType());if(L){t=o.getContextPath()+"/"+e}else{t="/"+n+"/"+e}l.selectionVariantAnnotation=D?t:undefined}let V=[];if(L){var ot,nt,lt,at,rt;const i=t.split("/")[0];const o=t.split("/")[1];const n=e.getConverterContextFor(`/${i}`);const l=n===null||n===void 0?void 0:(ot=n.getDataModelObjectPath().startingEntitySet)===null||ot===void 0?void 0:(nt=ot.annotations)===null||nt===void 0?void 0:(lt=nt.Capabilities)===null||lt===void 0?void 0:(at=lt.NavigationRestrictions)===null||at===void 0?void 0:at.RestrictedProperties;const a=l===null||l===void 0?void 0:l.find(t=>{var e;if(((e=t.NavigationProperty)===null||e===void 0?void 0:e.type)==="NavigationPropertyPath"){return t.NavigationProperty.value===o}});V=(a===null||a===void 0?void 0:(rt=a.FilterRestrictions)===null||rt===void 0?void 0:rt.RequiredProperties)??[]}else{const t=o===null||o===void 0?void 0:o.getEntitySet();if(s(t)){var vt,dt;V=((vt=t.annotations.Capabilities)===null||vt===void 0?void 0:(dt=vt.FilterRestrictions)===null||dt===void 0?void 0:dt.RequiredProperties)??[]}}let $=[];if((B=V)!==null&&B!==void 0&&B.length){V.forEach(function(t){$.push(t.value)})}$=$.concat(A);l.requiredProperties=$;if(e.getContextPath()===o.getContextPath()){m(h,V,false)}if((J=l.requiredProperties)!==null&&J!==void 0&&J.length){if(!l.inParameters||!l.inParameters.length){if(!l.selectionVariantAnnotation){l.showOverlayInitially=true}else{var st,ut,gt,ct;let t=((st=D)===null||st===void 0?void 0:(ut=st.SelectOptions)===null||ut===void 0?void 0:ut.map(t=>{var e;return(e=t.PropertyName)===null||e===void 0?void 0:e.value}))||[];const e=((gt=D)===null||gt===void 0?void 0:(ct=gt.Parameters)===null||ct===void 0?void 0:ct.map(t=>{var e;return(e=t.PropertyName)===null||e===void 0?void 0:e.value}))||[];t=t.concat(e);$=$.sort();t=t.sort();l.showOverlayInitially=$.some(function(e){return!t.includes(e)})}}else{l.showOverlayInitially=false}}else{l.showOverlayInitially=false}const T=(K=P)===null||K===void 0?void 0:(X=K.$target)===null||X===void 0?void 0:(Y=X.Dimensions[0])===null||Y===void 0?void 0:(Z=Y.$target)===null||Z===void 0?void 0:Z.type;l.renderLineChart=T==="Edm.DateTimeOffset"||T==="Edm.Date"||T==="Edm.TimeOfDay"||((tt=P.$target)===null||tt===void 0?void 0:tt.ChartType)!=="UI.ChartType/Line"}}else{e.getDiagnostics().addIssue(p.Annotation,f.High,c.MALFORMED_VISUALFILTERS.CHART);return}}else{e.getDiagnostics().addIssue(p.Annotation,f.High,c.MALFORMED_VISUALFILTERS.PRESENTATIONVARIANT)}}else{e.getDiagnostics().addIssue(p.Annotation,f.High,c.MALFORMED_VISUALFILTERS.VALUELIST)}}else{e.getDiagnostics().addIssue(p.Manifest,f.High,c.MALFORMED_VISUALFILTERS.VALUELIST)}return l}a.getVisualFilters=h;function m(t,e,i){e.forEach(function(e){const o=i?e:e.value;t.push({localDataProperty:o,valueListProperty:o})})}a._addInParameters=m;return a},false);
//# sourceMappingURL=VisualFilters.js.map