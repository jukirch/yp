/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/controls/Common/Action","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/helpers/BindingToolkit","../ManifestSettings","../controls/Common/DataVisualization","../controls/Common/KPI","../helpers/ID"],function(t,e,n,i,a,o,r,s){"use strict";var l={};var c=s.getTableID;var u=s.getIconTabBarID;var d=s.getFilterVariantManagementID;var f=s.getFilterBarID;var p=s.getDynamicListReportID;var v=s.getCustomTabID;var h=s.getChartID;var y=r.getKPIDefinitions;var g=o.isSelectionPresentationCompliant;var m=o.isPresentationCompliant;var C=o.getSelectionVariant;var b=o.getSelectionPresentationVariant;var P=o.getMultiDimensionalGridVisualization;var I=o.getDefaultPresentationVariant;var T=o.getDefaultLineItem;var V=o.getDefaultChart;var w=o.getDataVisualizationConfiguration;var E=a.VisualizationType;var z=a.VariantManagementType;var M=a.TemplateType;var S=i.getExpressionFromAnnotation;var D=i.compileExpression;var k=n.insertCustomElements;var A=e.getSelectionFields;var F=e.getManifestFilterFields;var L=e.getFilterBarHideBasicSearch;var B=t.getActionsFromManifest;function x(t){const e=[];t.forEach(function(t){if(!t.type){const n=t.secondaryVisualization?t.secondaryVisualization.visualizations:t.presentation.visualizations;n.forEach(function(t){if(t.type===E.Table){e.push(t)}})}});return e}function R(t){const e=[];t.forEach(function(t){if(!t.type){const n=t.primaryVisualization?t.primaryVisualization.visualizations:t.presentation.visualizations;n.forEach(function(t){if(t.type===E.Chart){e.push(t)}})}});return e}const W=function(t){const e={};for(const s in t){var n,i,a;if((n=t[s])!==null&&n!==void 0&&(i=n.settings)!==null&&i!==void 0&&(a=i.defaultValues)!==null&&a!==void 0&&a.length){var o,r;e[s]=(o=t[s])===null||o===void 0?void 0:(r=o.settings)===null||r===void 0?void 0:r.defaultValues}}return e};function H(t,e,n){const i=e.getManifestWrapper().getDefaultTemplateAnnotationPath();const a=b(t,i,e);const o="ALP flavor needs both chart and table to load the application";if(a){if(i){const t=a.PresentationVariant;if(!t){throw new Error("Presentation Variant is not configured in the SPV mentioned in the manifest")}if(!m(t,n)){if(n){throw new Error(o)}return undefined}}if(g(a,n)===true){return a}else if(n){throw new Error(o)}}const r=I(t);if(r){if(m(r,n)){return r}else if(n){throw new Error(o)}}if(!n){return T(t)}return undefined}const G=function(t){let e=t;if(e.converterContext){var n,i;let t=e.converterContext;e=e;const a=function(t){return t.key!==undefined};let o=w(e.annotation?t.getRelativeAnnotationPath(e.annotation.fullyQualifiedName,t.getEntityType()):"",true,t,e,undefined,undefined,a(e));let r="";let s="";let l="";let u="";const d=function(t,e){let n;for(const i of t.visualizations){if(e&&(i.type===E.Chart||i.type===E.MultiDimensionalGrid)){n=i;break}if(!e&&i.type===E.Table){n=i;break}}const i=Object.assign({},t);if(n){i.visualizations=[n]}else{throw new Error((e?"Primary":"Secondary")+" visualisation needs valid "+(e?"chart":"table"))}return i};const f=function(n,i){if(n.type==="MultiDimensionalGrid"){return P(n)}n=n;const a=t.getEntityTypeAnnotation(n.annotationPath);const r=a.annotation;t=a.converterContext;const s=r;if(s||t.getTemplateType()===M.AnalyticalListPage){o=w(s?t.getRelativeAnnotationPath(s.fullyQualifiedName,t.getEntityType()):"",true,t,e,undefined,undefined,undefined);return o}else{const t="Annotation Path for the "+(i?"primary":"secondary")+" visualisation mentioned in the manifest is not found";throw new Error(t)}};const p=function(t,n){var i,a,o,l;const c=d(t[0],true);s=(c===null||c===void 0?void 0:(i=c.visualizations[0])===null||i===void 0?void 0:i.type)===E.Chart?c===null||c===void 0?void 0:(a=c.visualizations[0])===null||a===void 0?void 0:a.id:"";const u=d(t[1]?t[1]:t[0],false);r=u===null||u===void 0?void 0:(o=u.visualizations[0])===null||o===void 0?void 0:(l=o.annotation)===null||l===void 0?void 0:l.id;if(c&&u){e=e;const t=e.visible;const i={primaryVisualization:c,secondaryVisualization:u,tableControlId:r,chartControlId:s,defaultPath:n,visible:t};return i}};if(!t.getManifestWrapper().hasMultipleVisualizations(e)&&((n=o)===null||n===void 0?void 0:(i=n.visualizations)===null||i===void 0?void 0:i.length)===2&&t.getTemplateType()===M.AnalyticalListPage){const t=p([o],"both");if(t){return t}}else if(t.getManifestWrapper().hasMultipleVisualizations(e)||t.getTemplateType()===M.AnalyticalListPage){const{primary:t,secondary:n}=e;if(t&&t.length&&n&&n.length){const i=p([f(t[0],true),f(n[0],false)],e.defaultPath);if(i){return i}}else{throw new Error("SecondaryItems in the Views is not present")}}else if(a(e)){const n=t.getEntityTypeAnnotation(e.annotationPath);const i=n.annotation;t=n.converterContext;l=D(S(i.Text));o.visualizations.forEach((t,n)=>{var i;switch(t.type){case E.Table:const t=o.visualizations[n];const r=t.control.filters||{};r.hiddenFilters=r.hiddenFilters||{paths:[]};if(!e.keepPreviousPersonalization){t.annotation.id=c(e.key||"","LineItem")}e=e;if(((i=e.annotation)===null||i===void 0?void 0:i.term)==="com.sap.vocabularies.UI.v1.SelectionPresentationVariant"){var a;if(!e.annotation.SelectionVariant){throw new Error(`The Selection Variant is missing for the Selection Presentation Variant ${e.annotation.fullyQualifiedName}`)}u=`@${(a=e.annotation.SelectionVariant)===null||a===void 0?void 0:a.fullyQualifiedName.split("@")[1]}`}else{u=e.annotationPath}r.hiddenFilters.paths.push({annotationPath:u});t.control.filters=r;break;case E.Chart:const s=o.visualizations[n];s.id=h(e.key||"","Chart");s.multiViews=true;break;default:break}})}o.visualizations.forEach(t=>{if(t.type===E.Table){r=t.annotation.id}else if(t.type===E.Chart){s=t.id}});e=e;const v=e.visible;return{presentation:o,tableControlId:r,chartControlId:s,title:l,selectionVariantPath:u,visible:v}}else{e=e;const t=e.label,n=e.template,i=e.type,a=v(e.key||""),o=e.visible;return{title:t,fragment:n,type:i,customTabId:a,visible:o}}};const j=function(t,e){let n=[];if(e){e.paths.forEach(i=>{if(t.getManifestWrapper().hasMultipleVisualizations(i)){if(e.paths.length>1){throw new Error("ALP flavor cannot have multiple views")}else{i=i;n.push({converterContext:t,primary:i.primary,secondary:i.secondary,defaultPath:i.defaultPath})}}else if(i.template){i=i;n.push({key:i.key,label:i.label,template:i.template,type:"Custom",visible:i.visible})}else{i=i;const e=t.getConverterContextFor(i.contextPath||i.entitySet&&`/${i.entitySet}`||t.getContextPath()),a=e.getEntityType();if(a&&e){let t;const o=e.getEntityTypeAnnotation(i.annotationPath);const r=o.annotation;if(r){t=r.term==="com.sap.vocabularies.UI.v1.SelectionVariant"?H(a,e,false):r;n.push({converterContext:e,annotation:t,annotationPath:i.annotationPath,keepPreviousPersonalization:i.keepPreviousPersonalization,key:i.key,visible:i.visible})}}else{}}})}else{const e=t.getEntityType();if(t.getTemplateType()===M.AnalyticalListPage){n=Q(t,n)}else{n.push({annotation:H(e,t,false),converterContext:t})}}return n.map(t=>G(t))};const N=function(t,e){const n=t.getManifestWrapper();const i=n.getViewConfiguration();if(e.length>1&&!$(t)){return{showTabCounts:i?(i===null||i===void 0?void 0:i.showCounts)||n.hasMultipleEntitySets():undefined,id:u()}}return undefined};function Q(t,e){const n=t.getEntityType();const i=H(n,t,true);let a,o;if(i){e.push({annotation:i,converterContext:t})}else{a=V(n);o=T(n);if(a&&o){const n=[{annotationPath:"@"+a.term}];const i=[{annotationPath:"@"+o.term}];e.push({converterContext:t,primary:n,secondary:i,defaultPath:"both"})}else{throw new Error("ALP flavor needs both chart and table to load the application")}}return e}function $(t){return t.getManifestWrapper().hasMultipleVisualizations()||t.getTemplateType()===M.AnalyticalListPage}const K=function(t){const e=t.getManifestWrapper();return k([],B(e.getHeaderActions(),t).actions)};l.getHeaderActions=K;const O=function(t,e){t.forEach(t=>{if(!t.type){const n=t.presentation;n.visualizations.forEach(t=>{if(t.type===E.Chart&&t.filterId!==e){t.filterId=e}})}})};l.checkChartFilterBarId=O;const U=function(t){const e=t.getEntityType();const n=t.getContextPath();if(!n){throw new Error("An EntitySet is required to be able to display a ListReport, please adjust your `entitySet` property to point to one.")}const i=t.getManifestWrapper();const a=i.getViewConfiguration();const o=i.hasMultipleEntitySets();const r=j(t,a);const s=x(r);const l=R(r);const c=s.some(t=>t.control.type==="ResponsiveTable");let u="";let v="";const h=p();const g=f(n);const m=d(g);const b=i.getFilterConfiguration();const P=(b===null||b===void 0?void 0:b.initialLayout)!==undefined?b===null||b===void 0?void 0:b.initialLayout.toLowerCase():"compact";const I=(b===null||b===void 0?void 0:b.layout)!==undefined?b===null||b===void 0?void 0:b.layout.toLowerCase():"compact";const T=b.useSemanticDateRange!==undefined?b.useSemanticDateRange:true;const V=b.showClearButton!==undefined?b.showClearButton:false;const w=q(t,r);if(w){v=w.chartId;u=w.tableId}const E=i.useHiddenFilterBar();const M=(i.isFilterBarHidden()||E)&&v==="";const S=A(t,s);const D=S.selectionFields;const k=S.sPropertyInfo;const B=L(s,l,t);const H=N(t,r);const G=H?undefined:C(e,t);const Q=T?W(F(e,t)):{};const U=K(t);if(o){O(r,g)}const X=s.map(t=>t.annotation.id).concat(l.map(t=>t.id));const Y=J(r);const Z=[...M&&!E?[]:[g],...i.getVariantManagement()!==z.Control?X:[],...H?[H.id]:[],...Y.variantManagementId?[Y.variantManagementId]:[]];const _=H&&i.getStickyMultiTabHeaderConfiguration()?H.id:undefined;return{mainEntitySet:n,mainEntityType:`${n}/`,multiViewsControl:H,stickySubheaderProvider:_,singleTableId:u,singleChartId:v,multiDimensionalGridIds:Y,dynamicListReportId:h,headerActions:U,showPinnableToggle:c,filterBar:{propertyInfo:k,selectionFields:D,hideBasicSearch:B,showClearButton:V},views:r,filterBarId:M&&!E?"":g,filterConditions:{selectionVariant:G,defaultSemanticDates:Q},variantManagement:{id:m,targetControlIds:Z.join(",")},hasMultiVisualizations:$(t),templateType:i.getTemplateType(),useSemanticDateRange:T,filterInitialLayout:P,filterLayout:I,kpiDefinitions:y(t),hideFilterBar:M,useHiddenFilterBar:E}};l.convertPage=U;function q(t,e){let n="",i="";if(t.getManifestWrapper().hasMultipleVisualizations()||t.getTemplateType()===M.AnalyticalListPage){for(const t of e){const e=t;if(e.chartControlId||e.tableControlId){i=e.chartControlId??i;n=e.tableControlId??n;break}}}else{for(const t of e){const e=t;if(!n&&e.tableControlId){n=e.tableControlId||""}if(!i&&e.chartControlId){i=e.chartControlId||""}if(i&&n){break}}}if(n||i){return{chartId:i,tableId:n}}return undefined}function J(t){for(const i of t){var e,n;const t=i===null||i===void 0?void 0:(e=i.primaryVisualization)===null||e===void 0?void 0:(n=e.visualizations)===null||n===void 0?void 0:n[0];if((t===null||t===void 0?void 0:t.type)===E.MultiDimensionalGrid){return{id:t.id,variantManagementId:t.variantManagementId}}}return{id:undefined,variantManagementId:undefined}}return l},false);
//# sourceMappingURL=ListReportConverter.js.map