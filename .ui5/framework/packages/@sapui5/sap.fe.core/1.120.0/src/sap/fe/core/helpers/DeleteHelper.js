/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/controllerextensions/editFlow/draft","sap/m/CheckBox","sap/m/MessageToast","sap/m/Text"],function(e,t,n,o,s){"use strict";var l;(function(e){e["deletableContexts"]="deletableContexts";e["draftsWithDeletableActive"]="draftsWithDeletableActive";e["unSavedContexts"]="unSavedContexts";e["draftsWithNonDeletableActive"]="draftsWithNonDeletableActive";e["draftsToDeleteBeforeActive"]="draftsToDeleteBeforeActive"})(l||(l={}));var i;(function(e){e["CHECKBOX"]="checkBox";e["TEXT"]="text"})(i||(i={}));function E(e,t,n,o){const s=[...n];o.forEach(e=>{const t=s.indexOf(e);if(t!==-1){s.splice(t,1)}});e.setProperty(t,[]);return s}function a(e,t){let n=e.getProperty("selectedContexts")||[];if(t.type===l.deletableContexts){n=E(e,l.deletableContexts,n,e.getProperty(l.deletableContexts)||[]);const t=e.getProperty(l.draftsWithDeletableActive)||[];const o=t.map(e=>e.draft);n=E(e,l.draftsWithDeletableActive,n,o)}else{const o=e.getProperty(t.type)||[];n=E(e,t.type,n,o)}e.setProperty("selectedContexts",n);e.setProperty("numberOfSelectedContexts",n.length)}function r(e,t,n,s,l){const{internalModelContext:i,entitySetName:E}=e;if(i){if(i.getProperty("deleteEnabled")!=undefined){t.forEach(e=>{if(e.selected){a(i,e)}})}i.setProperty("deleteEnabled",t.some(e=>!e.selected))}if(n.length===1){o.show(s.getText("C_TRANSACTION_HELPER_DELETE_TOAST_SINGULAR",undefined,E))}else{o.show(s.getText("C_TRANSACTION_HELPER_DELETE_TOAST_PLURAL",undefined,E))}if(e.parentControl!==undefined&&e.parentControl.getMetadata().getName()!=="sap.ui.mdc.MultiValueField"){x.setFocusAfterDelete(e.parentControl,n.length,l)}}async function _(e,t,n){var o;const s=(o=e.getRowBinding())===null||o===void 0?void 0:o.getCount();const l=(s??0)+t;let i;if(n!==-1&&s!==undefined&&s>0){if(n===l-1){i=s-1}else{i=n-t+1}await e.focusRow(i,false)}else{e.focus()}}function T(e){const t=e.getObject()["DraftAdministrativeData"];return t&&t["InProcessByUser"]||""}function c(e,t,n){let o="";if(t===1&&n.length===1){const t=T(n[0]);o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_SINGLE_OBJECT_LOCKED",[t])}else if(n.length==1){const s=T(n[0]);o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_ONE_OBJECT_LOCKED",[t,s])}else if(n.length>1){o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_LOCKED",[n.length,t])}return o}function f(e,t,n){let o="";if(n===t){if(t===1){o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_ONLY_DRAFT_OF_NON_DELETABLE_ACTIVE")}else{o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_ONLY_DRAFTS_OF_NON_DELETABLE_ACTIVE")}}else if(t===1){o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_DRAFT_OF_NON_DELETABLE_ACTIVE")}else{o=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_DRAFTS_OF_NON_DELETABLE_ACTIVE")}return o}function C(e){const t=e.getObject()["DraftAdministrativeData"];let n="";if(t){n=t["LastChangedByUserDescription"]||t["LastChangedByUser"]||""}return n}function N(e,t,n,o){let s="",l="",i=false;if(t===1&&n.length===1){const t=C(n[0]);s=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_CHANGES",[t]);i=true}else if(t===n.length){s=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_CHANGES_MULTIPLE_OBJECTS");i=true}else if(o===n.length){if(n.length===1){const t=C(n[0]);s=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_SINGULAR",[t])}else{s=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_UNSAVED_AND_FEW_OBJECTS_LOCKED_PLURAL")}i=true}else if(o>n.length){if(n.length===1){const t=C(n[0]);l=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_SINGULAR",[t])}else{l=e.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_UNSAVED_PLURAL")}}return{infoTxt:s,optionTxt:l,optionWithoutTxt:i}}function d(e,t,n){const{numberOfSelectedContexts:o,entitySetName:l,lockedContexts:i=[],draftsWithNonDeletableActive:E=[]}=e;const a=o-(i.length+t-E.length);let r="";if(a>0&&(t===0||E.length===t)){if(i.length>0){if(a===1){r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_ALL_REMAINING_NON_DELETABLE_SINGULAR")}else{r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_ALL_REMAINING_NON_DELETABLE_PLURAL")}}else if(a===1){r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_SINGLE_AND_ONE_OBJECT_NON_DELETABLE",undefined,l)}else{r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_MULTIPLE_AND_ALL_OBJECT_NON_DELETABLE",undefined,l)}}else if(a===1){r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_ONE_OBJECT_NON_DELETABLE",[o],l)}else if(a>1){r=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO_AND_FEW_OBJECTS_NON_DELETABLE",[a,o],l)}return r?new s({text:r}):undefined}function A(e,t){return t.reduce((e,t)=>t.selected&&t.type!==l.draftsToDeleteBeforeActive?e.concat(t.contexts):e,e)}function g(e){const t=[];return e.reduce((e,t)=>t.selected&&t.type===l.draftsToDeleteBeforeActive?e.concat(t.contexts):e,t)}function D(e,t,n,o,E,a){const{numberOfSelectedContexts:r,draftsWithDeletableActive:_,unSavedContexts:T,lockedContexts:c,draftsWithNonDeletableActive:f}=e;let C="";if(_.length>0){const e=[];_.forEach(n=>{e.push(n.draft);t.push(n.siblingInfo.targetContext)});if(e.length>0){a.push({type:l.draftsToDeleteBeforeActive,contexts:e,selected:true})}}if(c.length>0){C=x.getLockedObjectsText(o,r,c)||"";E.push(new s({text:C}))}const N=r!=n-f.length+c.length;const d=N&&x.getNonDeletableText(e,n,o);if(d){E.push(d)}if(T.length>0){const e=x.getUnsavedContextsText(o,r,T,n)||{};if(e.infoTxt){E.push(new s({text:e.infoTxt}))}if(e.optionTxt||e.optionWithoutTxt){a.push({type:l.unSavedContexts,contexts:T,text:e.optionTxt,selected:true,control:i.CHECKBOX})}}if(f.length>0){const e=x.getNonDeletableActivesOfDraftsText(o,f.length,n)||"";if(e){a.push({type:l.draftsWithNonDeletableActive,contexts:f,text:e,selected:true,control:n>0?i.CHECKBOX:i.TEXT})}}}function O(e,t){if(e.length===1){const n=e[0];if(n.text){t.push(new s({text:n.text}))}}else if(e.length>1){e.forEach(e=>{if(e.control==="text"&&e.text){t.push(new s({text:e.text}))}});e.forEach(e=>{if(e.control==="checkBox"&&e.text){t.push(new n({text:e.text,selected:true,select:function(t){const n=t.getSource();const o=n.getSelected();e.selected=o}}))}})}}function L(e,t){const{draftsWithDeletableActive:n}=e;const o=n.find(e=>e.siblingInfo.targetContext===t);return o!==null&&o!==void 0&&o.draft?o.draft:t}function u(e,t,n){const{numberOfSelectedContexts:o,entitySetName:s,parentControl:E,description:a,lockedContexts:r,draftsWithNonDeletableActive:_,unSavedContexts:T}=e;const c=t.length+_.length+T.length;const f=o-(r.length+c-_.length);const C=[];if(o===1&&o===t.length){const o=E;const r=o&&o.getParent().getIdentifierColumn();let _;if(r){const o=a&&a.path;let l=t[0];let i=l.getObject();if(!i||Object.keys(i).length===0){l=L(e,l);i=l.getObject()}const E=r?i[r]:undefined;const T=o&&i[o];if(E){if(T&&a&&r!==a.path){_=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTINFO",[E,T],s)}else{_=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_ONLY",[E],s)}}else{_=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",undefined,s)}}else{_=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",undefined,s)}C.push({type:l.deletableContexts,contexts:t,text:_,selected:true,control:i.TEXT})}else if(T.length!==c&&o>0&&(t.length>0||T.length>0&&_.length>0)){if(o>t.length&&f+r.length>0){let e="";if(c===1){e=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR_NON_DELETABLE",undefined,s)}else{e=n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL_NON_DELETABLE",undefined,s)}C.unshift({type:l.deletableContexts,contexts:t,text:e,selected:true,control:i.TEXT})}else{const e=c===1?n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_SINGULAR",undefined,s):n.getText("C_TRANSACTION_HELPER_CONFIRM_DELETE_WITH_OBJECTTITLE_PLURAL",undefined,s);C.push({type:l.deletableContexts,contexts:t,text:e,selected:true,control:i.TEXT})}}return C}async function I(n,o,s,l,i,E,a){try{const r=x.getConfirmedDeletableContext([],n);const _=r[r.length-1].getIndex()??-1;const T=g(n);const{beforeDeleteCallBack:c,parentControl:f}=o;if(c){await c({contexts:r})}if(r&&r.length){try{const s=r.length===1?true:false;const c=[];await Promise.allSettled(T.map(async function(n){try{return await t.deleteDraft(n,i,s)}catch(t){e.error(`FE : core : DeleteHelper : Error while discarding draft with path : ${n.getPath()}`);c.push(t)}}));let f=r;if(a){const e=[...r];e.forEach((t,n)=>{if(t===undefined){return}for(let o=n+1;o<e.length;o++){const n=e[o];if(n&&t.isAncestorOf(n)){e[o]=undefined}}});f=e.filter(e=>e!==undefined)}await Promise.all(f.map(async function(e){if(E&&!e.getProperty("IsActiveEntity")){return t.deleteDraft(e,i,s)}if(e.hasPendingChanges()){e.resetChanges()}return e.delete()}));x.afterDeleteProcess(o,n,r,l,_);if(c.length>0){throw Error(`FE : core : DeleteHelper : Errors on draft delete : ${c}`)}}catch(e){await s.showMessageDialog({control:f});throw e}}}catch(e){await s.showMessages();throw e}}async function h(e,n){const o=n.map(e=>{const n=e.getModel().getMetaModel().getMetaContext(e.getCanonicalPath());const o=n.getProperty("@Org.OData.Capabilities.V1.DeleteRestrictions/Deletable/$Path");const s=!o&&n.getProperty("@Org.OData.Capabilities.V1.DeleteRestrictions/Deletable")!==false;const l={context:e,isDraftRoot:!!n.getProperty("@com.sap.vocabularies.Common.v1.DraftRoot"),isDraftNode:!!n.getProperty("@com.sap.vocabularies.Common.v1.DraftNode"),isActive:true,hasActive:false,hasDraft:false,locked:false,deletable:o?e.getProperty(o):s,siblingPromise:Promise.resolve(undefined),siblingInfo:undefined,siblingDeletable:false};if(l.isDraftRoot){var i;l.locked=!!((i=e.getObject("DraftAdministrativeData"))!==null&&i!==void 0&&i.InProcessByUser);l.hasDraft=e.getProperty("HasDraftEntity")}if(l.isDraftRoot){l.isActive=e.getProperty("IsActiveEntity");l.hasActive=e.getProperty("HasActiveEntity");if(!l.isActive&&l.hasActive){l.siblingPromise=t.computeSiblingInformation(e,e).then(async e=>{l.siblingInfo=e;if(o){var t;l.siblingDeletable=await(e===null||e===void 0?void 0:(t=e.targetContext)===null||t===void 0?void 0:t.requestProperty(o))}else{l.siblingDeletable=s}})}}return l});await Promise.all(o.map(e=>e.siblingPromise));const s=[{key:"draftsWithDeletableActive",value:o.filter(e=>e.isDraftRoot&&!e.isActive&&e.hasActive&&e.siblingDeletable)},{key:"draftsWithNonDeletableActive",value:o.filter(e=>e.isDraftRoot&&!e.isActive&&e.hasActive&&!e.siblingDeletable)},{key:"lockedContexts",value:o.filter(e=>e.isDraftRoot&&e.isActive&&e.hasDraft&&e.locked)},{key:"unSavedContexts",value:o.filter(e=>e.isDraftRoot&&e.isActive&&e.hasDraft&&!e.locked)},{key:"deletableContexts",value:o.filter(e=>!e.isDraftRoot&&!e.isDraftNode&&e.deletable||e.isDraftRoot&&e.isActive&&!e.hasDraft&&e.deletable||e.isDraftRoot&&!e.isActive&&!e.hasActive||e.isDraftNode&&e.deletable)}];for(const{key:t,value:n}of s){e.setProperty(t,n.map(e=>t==="draftsWithDeletableActive"?{draft:e.context,siblingInfo:e.siblingInfo}:e.context))}}const x={getNonDeletableText:d,deleteConfirmHandler:I,getOptionsForDeletableTexts:u,updateContentForDeleteDialog:O,updateDraftOptionsForDeletableTexts:D,getConfirmedDeletableContext:A,getLockedObjectsText:c,getUnsavedContextsText:N,getNonDeletableActivesOfDraftsText:f,afterDeleteProcess:r,updateDeleteInfoForSelectedContexts:h,DeleteOptionTypes:l,DeleteDialogContentControl:i,setFocusAfterDelete:_};return x},false);
//# sourceMappingURL=DeleteHelper.js.map