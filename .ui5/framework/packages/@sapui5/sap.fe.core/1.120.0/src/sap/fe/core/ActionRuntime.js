/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/controls/Any","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/ActionHelper","sap/ui/core/message/Message","./controls/AnyElement","./converters/ConverterContext","./converters/MetaModelConverter","./converters/objectPage/HeaderAndFooterAction"],function(e,t,n,o,i,s,a,l,r,d,c,u){"use strict";var g=u.getHiddenExpression;var f=u.getEditButtonEnabled;var p=c.convertTypes;var v=a.getIsActionCriticalExpression;var b=s.isEntitySet;var m=o.transformRecursively;var y=o.isConstant;var A=o.equal;var h=o.constant;var E=o.compileExpression;var C=o.compileConstant;const M={_addMessageForActionParameter:function(e,t){e.addMessages(t.map(e=>{const t=e.actionParameterInfo.field.getBinding(e.actionParameterInfo.isMultiValue?"items":"value");return new l({message:e.message,type:"Error",processor:t===null||t===void 0?void 0:t.getModel(),persistent:true,target:t===null||t===void 0?void 0:t.getResolvedPath()})}))},validateProperties:async function(e,t,n){await Promise.allSettled(t.map(e=>e.validationPromise));const o=t.filter(e=>e.field.getRequired());const i=e.getMessageModel().getData();const s=o.filter(e=>{const t=e.field.getId();const n=i.filter(e=>e.getControlIds().some(e=>e.includes(t)));if(n.length>0){return false}else if(e.isMultiValue){return e.value===undefined||!e.value.length}else{const t=e.field.getValue();return t===undefined||t===null||t===""}});if(s.length){this._addMessageForActionParameter(e,s.map(e=>{var t;return{actionParameterInfo:e,message:n.getText("C_OPERATIONS_ACTION_PARAMETER_DIALOG_MISSING_MANDATORY_MSG",[((t=e.field.getParent())===null||t===void 0?void 0:t.getAggregation("label")).getText()])}}))}const a=t.find(e=>e.hasError||e.field.getValueState()==="Error"||s.includes(e));if(a){a.field.focus();return false}else{return true}},setActionEnablement:async function(e,n,o,i){const s=[];for(const a in n){let l=[];e.setProperty(a,false);const r=n[a];for(const t of o){const n=t;if(n){const t=n.getObject();if(i==="chart"){if(r===null&&!!t[`#${a}`]||n.getObject(r)){e.setProperty(a,true);break}}else if(i==="table"){l=this._setActionEnablementForTable(n,e,a,r,l)}}}if(i==="table"){if(!o.length){e.setProperty(`dynamicActions/${a}`,{bEnabled:false,aApplicable:[],aNotApplicable:[]});s.push(t.setContextsBasedOnOperationAvailable(e,[]))}else if(o.length&&typeof r==="string"){s.push(t.setContextsBasedOnOperationAvailable(e,l))}}}return Promise.all(s)},setActionEnablementAfterPatch:function(e,t,n){const o=n===null||n===void 0?void 0:n.getObject();const i=(o===null||o===void 0?void 0:o.controls)||{};for(const n in i){if(i[n]&&i[n].controlId){const o=e.byId(n);if(o&&o.isA("sap.ui.mdc.Table")){const e=o.getRowBinding();if(e==t){M.setActionEnablement(o.getBindingContext("internal"),JSON.parse(o.data("operationAvailableMap").customData),o.getSelectedContexts(),"table")}}}}},updateEditButtonVisibilityAndEnablement(n){var o,s;const a=(o=n.getViewData())===null||o===void 0?void 0:o.viewLevel,l=(s=n.getModel("ui"))===null||s===void 0?void 0:s.getProperty("/isEditable");if(a>1&&l!==true){var r,c,u;const o=n.getBindingContext();const s=t.getAppComponent(n);const a=i.getMetaPathForContext(o);const l=i.getRootEntitySetPath(a);const p=o===null||o===void 0?void 0:(r=o.getModel().getMetaModel())===null||r===void 0?void 0:r.getContext(o===null||o===void 0?void 0:o.getPath());const v=d===null||d===void 0?void 0:d.createConverterContextForMacro(l,p,s.getDiagnostics(),e,undefined);const m=v.getEntitySet();const y=v.getEntityType();let h;const C=b(m)&&((c=m.annotations.UI)===null||c===void 0?void 0:(u=c.UpdateHidden)===null||u===void 0?void 0:u.valueOf());if(C!==true){h=i.isUpdateHidden(m,y)}const M=f(v);const P=i.getDraftRootPath(o);const x=i.getStickyRootPath(o);const B=P||x;const I=n.getBindingContext("internal");if(B){const e=n.getModel().bindContext(B).getBoundContext();if(h!==undefined){const t=E(A(g(v,h),false));this.updateEditModelContext(t,n,e,"rootEditVisible",I)}if(M){this.updateEditModelContext(M,n,e,"rootEditEnabled",I)}}}},updateEditModelContext:function(e,t,n,o,i){if(e){var s,a,l;const d=new r({anyText:e});d.setBindingContext(null);t.addDependent(d);d.getBinding("anyText");const c=(s=d.getModel())===null||s===void 0?void 0:(a=s.bindContext(n.getPath(),n,{$$groupId:"$auto.Heroes"}))===null||a===void 0?void 0:a.getBoundContext();d.setBindingContext(c);d===null||d===void 0?void 0:(l=d.getBinding("anyText"))===null||l===void 0?void 0:l.attachChange(e=>{const t=e.getSource().getExternalValue();i.setProperty(o,t)})}},_setActionEnablementForTable:function(e,n,o,i,s){n.setProperty(`dynamicActions/${o}`,{bEnabled:false,aApplicable:[],aNotApplicable:[]});const a=[],l=[],r=`${n.getPath()}/dynamicActions/${o}/bEnabled`;if(typeof i==="object"&&i!==null&&i!==undefined){if(e){const t=e.getObject();const o=m(i,"PathInModel",function(e){return t?h(t[e.path]):h(false)},true);const s=E(o);if(s==="true"){n.getModel().setProperty(r,true);a.push(e)}else{l.push(e)}}t.setDynamicActionContexts(n,o,a,l)}else{const a=e===null||e===void 0?void 0:e.getObject();if(i===null&&!!a[`#${o}`]){n.getModel().setProperty(r,true)}else if(e!==undefined){s.push(t.requestProperty(e,o,i,r))}}return s},getIsActionCritical:function(e,t){let o=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];let i=true;const s=p(e);const a=s.resolvePath(t);const l=a.target;if(!l){return i}const r=v(l,s);if(y(r)){i=C(r,false,undefined,true)}else if(o.length>0){const e=new n({anyBoolean:E(r)});e.setModel(o[0].getModel());e.setBindingContext(o[0]);i=e.getBinding("anyBoolean").getExternalValue();e.destroy()}return i}};return M},false);
//# sourceMappingURL=ActionRuntime.js.map