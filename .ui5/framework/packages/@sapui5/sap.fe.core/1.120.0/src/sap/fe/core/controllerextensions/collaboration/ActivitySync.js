/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/ActivityBase","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/converters/MetaModelConverter","sap/m/MessageBox"],function(t,e,n,o,i,s){"use strict";var r={};var c=o.getActivityKeyFromPath;var a=o.CollaborationUtils;var l=o.Activity;var d=n.isCollaborationConnected;var u=n.initializeCollaboration;var g=n.endCollaboration;var f=n.broadcastCollaborationMessage;const p="/collaboration/myActivities";const y="/collaboration/activeUsers";const h="/collaboration/activities";const C="/collaboration/asyncMsgQueue";const P="/collaboration/retainedMessages";const v="/collaboration/asyncMsgTimerId";const A="$auto.sync";const M=500;function m(t,e){const n=t.getProperty(p);if(!n){return false}else{return n.includes(e)}}function b(t,e){const n=t.getProperty(p)??[];if(!n.includes(e)){n.push(e)}t.setProperty(p,n)}function x(t,e){const n=t.getProperty(p);if(!n||e===undefined){return false}const o=Array.isArray(e)?e:[e];const i=n.filter(t=>!o.includes(t));t.setProperty(p,i);return i.length!==n.length}function E(t){const e=t.getProperty(p);if(!e){return undefined}else{return e.join("|")}}function B(t,e,n){if(!I(t)){return}const o=t.getModel("internal");const i=o.getProperty(C);i.forEach(t=>{if(t.path.startsWith(e)){t.path=t.path.replace(e,n)}});const s=o.getProperty(p);if(s){const i=[];const r=[];s.forEach(t=>{if(t.startsWith(e)){const o=t.replace(e,n);i.push(o)}else{r.push(t)}});o.setProperty(p,r);if(i.length!==0){L(t,{action:l.Lock,content:i})}}}r.updateLocksForContextPath=B;function D(t){let e=t.getProperty(v);if(e!==undefined){clearTimeout(e)}e=setTimeout(()=>{const e=t.getProperty(C);const n=[];const o=t.getProperty(P)??[];if(!e){return}e.forEach(e=>{if(o.includes(e.path)){n.push(e)}else{F(t,e.action,e.path)}});t.setProperty(C,n);t.setProperty(v,undefined);if(n.length){D(t)}},M);t.setProperty(v,e)}function k(t,e){const n=t.getModel("internal");const o=Array.isArray(e)?e:[e];const i=n.getProperty(P);o.forEach(t=>{if(!i.includes(t)){i.push(t)}})}r.retainAsyncMessages=k;function O(t,e){const n=t.getModel("internal");const o=n.getProperty(P);const i=Array.isArray(e)?e:[e];n.setProperty(P,o.filter(t=>!i.includes(t)))}r.releaseAsyncMessages=O;const I=function(t){const e=t.getModel("internal");return d(e)};r.isConnected=I;const L=function(t,e){if(I(t)){const n=t.getModel("internal");if(e.action===l.Lock||e.action===l.Unlock){T(n,e.action,e.content)}else{F(n,e.action,e.content,e.triggeredActionName,e.refreshListBinding,e.actionRequestedProperties)}}};r.send=L;function F(t,e,n,o,i,s){const r=(Array.isArray(n)?n.join("|"):n)??"";const c=s===null||s===void 0?void 0:s.join("|");if(e===l.Lock){const e=(Array.isArray(n)?n[0]:n)??"";if(m(t,e)){return}else{b(t,e)}}else if(e===l.Unlock){const e=x(t,n);if(!e){return}}f(e,r,t,o,i,c)}function T(t,e,n){if(n===undefined){return}const o=t.getProperty(C);const i=Array.isArray(n)?n:[n];const s=o.filter(t=>!i.includes(t.path));i.forEach(t=>{s.push({path:t,action:e})});t.setProperty(C,s);D(t)}const S=function(t){return t.getModel().getMetaModel().getObject("/@com.sap.vocabularies.Common.v1.WebSocketBaseURL")};const w=function(t){const e=(t===null||t===void 0?void 0:t.getBindingContext)&&t.getBindingContext();return!!(e&&S(e))};r.isCollaborationEnabled=w;const R=async function(t){const e=t.getModel("internal");const n=a.getMe(t);if(!n){return}const o=t.getBindingContext();const i=S(o);const s=o.getModel().getServiceUrl();if(!i){return}const r=await o.requestProperty("DraftAdministrativeData/DraftUUID");if(!r){return}const c=u(n,i,r,s,e,e=>{q(e,t)},t);if(c){e.setProperty(p,[]);e.setProperty(C,[]);e.setProperty(P,[])}};r.connect=R;const U=function(t){const e=t.getModel("internal");g(e)};r.disconnect=U;function q(t,e){var n,o;const i=e.getModel("internal");let s=i.getProperty(y);let r;let d;const u=H(e,t.clientContent);t.userAction=t.userAction||t.clientAction;const g={id:t.userID,name:t.userDescription,initials:a.formatInitials(t.userDescription),color:a.getUserColor(t.userID,s,[])};let p=g;switch(t.userAction){case l.Join:case l.JoinEcho:if(s.findIndex(t=>t.id===g.id)===-1){s.unshift(g);i.setProperty(y,s)}if(t.userAction===l.Join){f(l.JoinEcho,E(i),i)}if(t.userAction===l.JoinEcho){if(t.clientContent){t.userAction=l.Lock;q(t,e)}}break;case l.Leave:s=s.filter(t=>t.id!==g.id||t.me);i.setProperty(y,s);const C=i.getProperty(h)||{};const P=function(t){if(Array.isArray(t)){return t.filter(t=>t.id!==g.id)}else{for(const e in t){t[e]=P(t[e])}return t}};P(C);i.setProperty(h,C);break;case l.Change:j(e,t);break;case l.Create:W(e,t);break;case l.Delete:J(e,t);break;case l.Activate:_(e,t.clientContent,a.getText("C_COLLABORATIONDRAFT_ACTIVATE",g.name));break;case l.Discard:_(e,t.clientContent,a.getText("C_COLLABORATIONDRAFT_DISCARD",g.name));break;case l.Action:Q(e,t);break;case l.Lock:p=g;p.key=c(t.clientContent);let v="";const A=u.split("/");for(let t=1;t<A.length-1;t++){v+=`/${A[t]}`;if(!i.getProperty(h+v)){i.setProperty(h+v,{})}}r=i.getProperty(h+u);r=(n=r)!==null&&n!==void 0&&n.slice?r.slice():[];r.push(p);i.setProperty(h+u,r);break;case l.Unlock:r=i.getProperty(h+u);d=c(t.clientContent);i.setProperty(h+u,(o=r)===null||o===void 0?void 0:o.filter(t=>t.key!==d));break}}function _(e,n,o){U(e);s.information(o);e.getBindingContext().getBinding().resetChanges().then(function(){V(n,e)}).catch(function(){t.error("Pending Changes could not be reset - still navigating to active instance");V(n,e)})}function j(t,e){const n=e.clientContent.split("|");const o=t.getModel().getMetaModel();const i=t.getModel("internal");const s=z(t);const r=s.getBindingContext();const c=n.map(async e=>N(t,e));s.getController().editFlow.updateDocument(r,Promise.all(c))}async function N(e,n){const o=e.getModel().getMetaModel();const s=o.getMetaContext(n);const r=i.getInvolvedDataModelObjects(s);const c=n.substring(0,n.lastIndexOf("/"));const l=G(e,c);const d=c.substring(0,c.lastIndexOf("("));const u=d.substring(0,d.lastIndexOf("/"));const g=u?G(e,u):undefined;if(!l&&!g){return}try{const t=[];const i=a.getAppComponent(e).getSideEffectsService();if(l){const e=o.getMetaPath(l.getPath());const s=o.getMetaPath(n).replace(e,"").slice(1);t.push(i.requestSideEffects([s],l,A))}const s=i.computeFieldGroupIds(r.targetEntityType.fullyQualifiedName,r.targetObject.fullyQualifiedName);if(s.length){const n=e.getController();const o=n._sideEffects.getSideEffectsMapForFieldGroups(s,l||g);Object.keys(o).forEach(e=>{const i=o[e];t.push(n._sideEffects.requestSideEffects(i.sideEffects,i.context,A,undefined,true))})}await Promise.all(t)}catch(e){t.error("Failed to update data after change:"+e);throw e}}function J(t,e){const n=z(t);const o=n.getBindingContext();const i=o.getPath();const r=e.clientContent.split("|");const c=r.find(t=>i.startsWith(t));if(c){s.information(a.getText("C_COLLABORATIONDRAFT_DELETE",e.userDescription),{onClose:()=>{const e=o.getModel().getKeepAliveContext(c);e.setKeepAlive(false);const i=K(t,r[0]);n.getController().editFlow.updateDocument(n.getBindingContext(),i);n.getController()._routing.navigateBackFromContext(e)}})}else{const e=K(t,r[0]);n.getController().editFlow.updateDocument(n.getBindingContext(),e)}}function W(t,e){const n=z(t);const o=e.clientContent.split("|");const i=K(t,o[0]);n.getController().editFlow.updateDocument(n.getBindingContext(),i)}async function K(e,n){const o=a.getAppComponent(e);const i=n.substring(0,n.lastIndexOf("/"));const s=G(e,i);if(s){try{const t=[];const e=s.getModel().getMetaModel();const i=e.getMetaPath(n);const r=e.getMetaPath(s.getPath());const c=i.replace(`${r}/`,"");const a=o.getSideEffectsService();t.push(a.requestSideEffects([c],s,A));t.push(a.requestSideEffectsForNavigationProperty(c,s,A,true));await Promise.all(t)}catch(e){t.error("Failed to update data after collection update:"+e)}}}function Q(t,e){var n;const o=z(t);const i=e.clientContent.split("|");const s=e.clientTriggeredActionName||"";const r=(n=e.clientRequestedProperties)===null||n===void 0?void 0:n.split("|");const c=e.clientRefreshListBinding==="true";let a=[];if(c){a.push(K(t,i[0]))}else{a=i.map(e=>$(t,e,s,r))}o.getController().editFlow.updateDocument(o.getBindingContext(),Promise.all(a))}async function $(t,e,n,o){const s=G(t,e);if(!s){return}const r=a.getAppComponent(t);const c=r.getSideEffectsService();const l=c.getODataActionSideEffects(n,s);const d=[];if(l){var u;if((u=l.pathExpressions)!==null&&u!==void 0&&u.length){d.push(c.requestSideEffects(l.pathExpressions,s,A))}}if(o&&o.length>0){const n=t.getModel().getMetaModel();const r=H(t,e);const a=i.getInvolvedDataModelObjects(n.getContext(r));const l=a.targetEntityType.entityProperties.map(t=>t.name).filter(t=>o.includes(t));if(l.length>0){d.push(c.requestSideEffects(l,s,A))}}await Promise.all(d)}function G(t,e){if(!e){return undefined}const n=[];while(!e.endsWith(")")){n.unshift(e);e=e.substring(0,e.lastIndexOf("/"))}n.unshift(e);const o=e.substring(0,e.lastIndexOf("("));let i;let s=z(t).getBindingContext();while(s&&!i){var r;if(n.includes(s.getPath())){i=s}s=(r=s.getBinding())===null||r===void 0?void 0:r.getContext()}if(i){return i}const c=z(t).getBindingContext().getModel();const a=c.getAllBindings().find(t=>{const e=t.isRelative()?t.getResolvedPath():t.getPath();return t.isA("sap.ui.model.odata.v4.ODataListBinding")&&e===o});i=a===null||a===void 0?void 0:a.getAllCurrentContexts().find(t=>n.includes(t.getPath()));return i}function V(t,e){const n=z(e);const o=e.getModel().bindContext(t).getBoundContext();n.getController().routing.navigate(o)}function z(t){const n=a.getAppComponent(t);return e.getCurrentPageView(n)}function H(t,e){let n="";if(e){const o=e.split("|")[0];n=t.getModel().getMetaModel().getMetaPath(o)}return n}return{connect:R,disconnect:U,isConnected:I,isCollaborationEnabled:w,send:L,retainAsyncMessages:k,releaseAsyncMessages:O,updateLocksForContextPath:B}},false);
//# sourceMappingURL=ActivitySync.js.map