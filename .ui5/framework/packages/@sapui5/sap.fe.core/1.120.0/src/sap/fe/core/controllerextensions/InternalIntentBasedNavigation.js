/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/FPMHelper","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/navigation/SelectionVariant","sap/ui/core/Core","sap/ui/core/mvc/ControllerExtension","sap/ui/core/mvc/OverrideExecution","../converters/helpers/Aggregation","./editFlow/NotApplicableContextDialog"],function(t,e,o,n,i,a,r,s,l,c,p,g,u,f,d,v){"use strict";var h,y,m,b,O,C,P,A,S,M,x,_,j,w,N,E,D,I,$,F,V;var B=d.AggregationHelper;var R=c.getResourceModel;var T=a.publicExtension;var H=a.privateExtension;var L=a.methodOverride;var k=a.finalExtension;var z=a.extensible;var W=a.defineUI5Class;var U=i.convertTypes;function J(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;q(t,e)}function q(t,e){q=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,o){e.__proto__=o;return e};return q(t,e)}function G(t,e,o,n,i){var a={};Object.keys(n).forEach(function(t){a[t]=n[t]});a.enumerable=!!a.enumerable;a.configurable=!!a.configurable;if("value"in a||a.initializer){a.writable=true}a=o.slice().reverse().reduce(function(o,n){return n(t,e,o)||o},a);if(i&&a.initializer!==void 0){a.value=a.initializer?a.initializer.call(i):void 0;a.initializer=undefined}if(a.initializer===void 0){Object.defineProperty(t,e,a);a=null}return a}let K=(h=W("sap.fe.core.controllerextensions.InternalInternalBasedNavigation"),y=L(),m=T(),b=k(),O=T(),C=k(),P=T(),A=z(f.Instead),S=T(),M=k(),x=H(),_=T(),j=k(),w=T(),N=k(),E=T(),D=k(),I=T(),$=k(),h(F=(V=function(a){J(c,a);function c(){return a.apply(this,arguments)||this}var u=c.prototype;u.onInit=function t(){this._oAppComponent=this.base.getAppComponent();this._oMetaModel=this._oAppComponent.getModel().getMetaModel();this._oNavigationService=this._oAppComponent.getNavigationService();this._oView=this.base.getView()};u.navigate=function t(o,i,a){const r=t=>{const n=a&&a.navigationContexts,r=n&&!Array.isArray(n)?[n]:n,l=a&&a.semanticObjectMapping,c=a&&a.additionalNavigationParameters,u={semanticObject:o,action:i},f=this.base.getView(),d=f.getController();if(t){this._oView.setBindingContext(t)}if(o&&i){let t=[],n=new p;if(r&&r.length){r.forEach(e=>{if(e.isA&&e.isA("sap.ui.model.odata.v4.Context")){let o=e.getObject();const n=this._oMetaModel.getMetaPath(e.getPath());o=this.removeSensitiveData(o,n);const i=this.prepareContextForExternalNavigation(o,e);u["propertiesWithoutConflict"]=i.propertiesWithoutConflict;t.push(i.semanticAttributes)}else if(!(e&&Array.isArray(e.data))&&typeof e==="object"){t.push(this.removeSensitiveData(e.data,e.metaPath))}else if(e&&Array.isArray(e.data)){t=this.removeSensitiveData(e.data,e.metaPath)}})}if(t&&t.length){n=this._oNavigationService.mixAttributesAndSelectionVariant(t,n.toJSONString())}const v=this._oView.getModel(),h=this.getEntitySet(),y=h?this._oNavigationService.constructContextUrl(h,v):undefined;if(y){n.setFilterContextUrl(y)}if(c){this._applyOutboundParams(n,c)}d.intentBasedNavigation.adaptNavigationContext(n,u);if(l){this._applySemanticObjectMappings(n,l)}this._removeTechnicalParameters(n);const m=d._intentBasedNavigation.getNavigationMode();const b=a&&a.refreshStrategies||{},O=f.getModel("internal");if(O){if((f&&f.getViewData()).refreshStrategyOnAppRestore){const t=f.getViewData().refreshStrategyOnAppRestore||{};e(b,t)}const t=s.getRefreshStrategyForIntent(b,o,i);if(t){O.setProperty("/refreshStrategyOnAppRestore",t)}}const C=function(){sap.ui.require(["sap/m/MessageBox"],function(t){const e=g.getLibraryResourceBundle("sap.fe.core");t.error(e.getText("C_COMMON_HELPER_NAVIGATION_ERROR_MESSAGE"),{title:e.getText("C_COMMON_SAPFE_ERROR")})})};this._oNavigationService.navigate(o,i,n.toJSONString(),undefined,C,undefined,m)}else{throw new Error("Semantic Object/action is not provided")}};const c=this.base.getView().getBindingContext();const u=c&&c.getModel().getMetaModel();if(this.getView().getViewData().converterType==="ObjectPage"&&u&&!l.isStickySessionSupported(u)){n.processDataLossOrDraftDiscardConfirmation(r.bind(this),Function.prototype,this.base.getView().getBindingContext(),this.base.getView().getController(),true,n.NavigationType.ForwardNavigation)}else{r()}};u.prepareContextForExternalNavigation=function t(e,o){const n={},i=o.getPath(),a=o.getModel().getMetaModel(),r=a.getMetaPath(i),s=r.split("/").filter(Boolean);function l(t,e){for(const o in t){if(t[o]===null||typeof t[o]!=="object"){if(!n[o]){n[o]=[]}n[o].push(e)}else{const n=t[o];l(n,`${e}/${o}`)}}}l(e,r);const c=s[0],p=a.getObject(`/${c}/@sapui.name`),g={};let u,f,d;for(const t in n){const i=n[t];let s;if(i.length>1){for(let n=0;n<=i.length-1;n++){const s=i[n];let l=s.replace(s===r?r:`${r}/`,"");l=(l===""?l:`${l}/`)+t;const c=a.getObject(`${s}/@sapui.name`);if(c===p){u=l}if(s===r){f=l}d=l;e[`${r}/${l}`.split("/").filter(function(t){return t!=""}).join(".")]=o.getProperty(l)}s=u||f||d;e[t]=o.getProperty(s);u=undefined;f=undefined;d=undefined}else{const n=i[0];let a=n.replace(n===r?r:`${r}/`,"");a=(a===""?a:`${a}/`)+t;e[t]=o.getProperty(a);g[t]=`${r}/${a}`.split("/").filter(function(t){return t!=""}).join(".")}}for(const t in e){if(e[t]!==null&&typeof e[t]==="object"){delete e[t]}}return{semanticAttributes:e,propertiesWithoutConflict:g}};u.getNavigationMode=function t(){return undefined};u.navigateWithConfirmationDialog=async function t(e,o,n){var i;let a=true;if(n!==null&&n!==void 0&&n.notApplicableContexts&&((i=n.notApplicableContexts)===null||i===void 0?void 0:i.length)>=1){const t=this.base.getView().getModel().getMetaModel();const e=t.getMetaPath(n.notApplicableContexts[0].getPath());const o=U(t);const i=o.resolvePath(e).target;const r=new v({title:"",entityType:i.entityType,resourceModel:R(this.getView()),notApplicableContexts:n.notApplicableContexts});n.navigationContexts=n.applicableContexts;a=await r.open(this.getView())}if(a){this.navigate(e,o,n)}};u._removeTechnicalParameters=function t(e){e.removeSelectOption("@odata.context");e.removeSelectOption("@odata.metadataEtag");e.removeSelectOption("SAP__Messages")};u.getEntitySet=function t(){return this._oView.getViewData().entitySet};u.removeSensitiveData=function t(e,o){if(e){const{transAggregations:t,customAggregates:s}=this._getAggregates(o,this.base.getView(),this.base.getAppComponent().getDiagnostics());const l=Object.keys(e);if(l.length){delete e["@odata.context"];delete e["@odata.metadataEtag"];delete e["SAP__Messages"];for(const c of l){if(e[c]&&typeof e[c]==="object"){this.removeSensitiveData(e[c],`${o}/${c}`)}if(c.includes("@odata.type")){delete e[c];continue}this._deleteAggregates([...t,...s],c,e);const l=this._getPropertyAnnotations(c,o,e,this._oMetaModel);if(l){var n,i,a,r;if((n=l.PersonalData)!==null&&n!==void 0&&n.IsPotentiallySensitive||(i=l.UI)!==null&&i!==void 0&&i.ExcludeFromNavigationContext||(a=l.Analytics)!==null&&a!==void 0&&a.Measure){delete e[c]}else if((r=l.Common)!==null&&r!==void 0&&r.FieldControl){const t=l.Common.FieldControl;if(t["$EnumMember"]&&t["$EnumMember"].split("/")[1]==="Inapplicable"||t["$Path"]&&this._isFieldControlPathInapplicable(t["$Path"],e)){delete e[c]}}}}}}return e};u._deleteAggregates=function t(e,o,n){if(e&&e.includes(o)){delete n[o]}};u._getPropertyAnnotations=function t(e,o,n,a){if(n[e]&&o&&!o.includes("undefined")){var r;const t=a.createBindingContext(`${o}/${e}`);const n=i.getInvolvedDataModelObjects(t);return n===null||n===void 0?void 0:(r=n.targetObject)===null||r===void 0?void 0:r.annotations}return null};u._getAggregates=function t(e,o,n){const i=this._getConverterContext(e,o,n);const a=new B(i.getEntityType(),i);const r=a.isAnalyticsSupported();let s,l;if(r){var c,p;s=a.getTransAggregations();if((c=s)!==null&&c!==void 0&&c.length){s=s.map(t=>t.Name||t.Value)}l=a.getCustomAggregateDefinitions();if((p=l)!==null&&p!==void 0&&p.length){l=l.map(t=>t.qualifier)}}s=s?s:[];l=l?l:[];return{transAggregations:s,customAggregates:l}};u._getConverterContext=function t(e,n,i){const a=n.getViewData();let r=a.entitySet;const s=a.contextPath;if(s&&(!r||r.includes("/"))){r=a===null||a===void 0?void 0:a.fullContextPath.split("/")[1]}return o.getConverterContextForPath(e,n.getModel().getMetaModel(),r,i)};u._isFieldControlPathInapplicable=function t(e,o){let n=false;const i=e.split("/");if(i.length>1){n=o[i[0]]&&o[i[0]].hasOwnProperty(i[1])&&o[i[0]][i[1]]===0}else{n=o[e]===0}return n};u._applySemanticObjectMappings=function t(e,o){const n=typeof o==="string"?JSON.parse(o):o;for(let t=0;t<n.length;t++){const o=n[t]["LocalProperty"]&&n[t]["LocalProperty"]["$PropertyPath"]||n[t]["@com.sap.vocabularies.Common.v1.LocalProperty"]&&n[t]["@com.sap.vocabularies.Common.v1.LocalProperty"]["$Path"];const i=n[t]["SemanticObjectProperty"]||n[t]["@com.sap.vocabularies.Common.v1.SemanticObjectProperty"];const a=e.getSelectOption(o);if(a){e.removeSelectOption(o);e.massAddSelectOption(i,a)}}return e};u.storeFocusInfoInHistory=function t(){let e=null;const o=g.getCurrentFocusedControlId();const n=o?g.byId(o):undefined;const i=n&&r.getMdcTable(n);if(n!==null&&n!==void 0&&n.isA("sap.m.Button")){e={type:"Control",controlId:o}}else if(i){var a;e={type:"Row",tableId:i.getId(),contextPathFocus:(a=n.getBindingContext())===null||a===void 0?void 0:a.getPath()}}history.replaceState(Object.assign({},history.state,{focusInfo:e}),"")};u.navigateOutbound=function e(o,n){var i,a;this.storeFocusInfoInHistory();let r;const s=this.base.getAppComponent().getManifestEntry("sap.app"),l=(i=s.crossNavigation)===null||i===void 0?void 0:(a=i.outbounds)===null||a===void 0?void 0:a[o];if(!l){t.error("Outbound is not defined in manifest!!");return}const c=l.semanticObject,p=l.action,g=l.parameters&&this.getOutboundParams(l.parameters);if(n){r=[];Object.keys(n).forEach(function(t){let e;if(Array.isArray(n[t])){const i=n[t];for(let n=0;n<i.length;n++){var o;e={};e[t]=i[n];(o=r)===null||o===void 0?void 0:o.push(e)}}else{var i;e={};e[t]=n[t];(i=r)===null||i===void 0?void 0:i.push(e)}})}if(r||g){n={navigationContexts:{data:r||g}}}this.base._intentBasedNavigation.navigate(c,p,n)};u._applyOutboundParams=function t(e,o){const n=Object.keys(o);const i=e.getSelectOptionsPropertyNames();n.forEach(function(t){if(!i.includes(t)){e.addSelectOption(t,"I","EQ",o[t])}});return e};u.getOutboundParams=function t(e){const o={};if(e){const t=Object.keys(e)||[];if(t.length>0){t.forEach(function(t){const n=e[t];if(n.value&&n.value.value&&n.value.format==="plain"){if(!o[t]){o[t]=n.value.value}}})}}return o};u.onChevronPressNavigateOutBound=function t(e,o,n,i){const a=e.getAppComponent().getRoutingService().getOutbounds();const r=a[o];let s;if(r&&r.semanticObject&&r.action){const t={intents:{}};const o={};let a;if(n){if(n.isA&&n.isA("sap.ui.model.odata.v4.Context")){a=l.getMetaPathForContext(n);n=[n]}else{a=l.getMetaPathForContext(n[0])}o[a]="self";t["_feDefault"]=o}if(i){const e=`${r.semanticObject}-${r.action}`;t.intents[e]={};t.intents[e][i]="self"}if(r&&r.parameters){const t=r.parameters&&this.getOutboundParams(r.parameters);if(Object.keys(t).length>0){s=t}}e._intentBasedNavigation.navigate(r.semanticObject,r.action,{navigationContexts:n,refreshStrategies:t,additionalNavigationParameters:s});return Promise.resolve()}else{throw new Error(`outbound target ${o} not found in cross navigation definition of manifest`)}};return c}(u),G(V.prototype,"onInit",[y],Object.getOwnPropertyDescriptor(V.prototype,"onInit"),V.prototype),G(V.prototype,"navigate",[m,b],Object.getOwnPropertyDescriptor(V.prototype,"navigate"),V.prototype),G(V.prototype,"prepareContextForExternalNavigation",[O,C],Object.getOwnPropertyDescriptor(V.prototype,"prepareContextForExternalNavigation"),V.prototype),G(V.prototype,"getNavigationMode",[P,A],Object.getOwnPropertyDescriptor(V.prototype,"getNavigationMode"),V.prototype),G(V.prototype,"navigateWithConfirmationDialog",[S,M],Object.getOwnPropertyDescriptor(V.prototype,"navigateWithConfirmationDialog"),V.prototype),G(V.prototype,"getEntitySet",[x],Object.getOwnPropertyDescriptor(V.prototype,"getEntitySet"),V.prototype),G(V.prototype,"removeSensitiveData",[_,j],Object.getOwnPropertyDescriptor(V.prototype,"removeSensitiveData"),V.prototype),G(V.prototype,"navigateOutbound",[w,N],Object.getOwnPropertyDescriptor(V.prototype,"navigateOutbound"),V.prototype),G(V.prototype,"getOutboundParams",[E,D],Object.getOwnPropertyDescriptor(V.prototype,"getOutboundParams"),V.prototype),G(V.prototype,"onChevronPressNavigateOutBound",[I,$],Object.getOwnPropertyDescriptor(V.prototype,"onChevronPressNavigateOutBound"),V.prototype),V))||F);return K},false);
//# sourceMappingURL=InternalIntentBasedNavigation.js.map