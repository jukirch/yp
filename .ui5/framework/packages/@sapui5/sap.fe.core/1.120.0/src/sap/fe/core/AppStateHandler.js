/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/fe/core/helpers/ClassSupport","sap/fe/core/helpers/ToES6Promise","sap/fe/navigation/library","sap/ui/base/Object","./controllerextensions/BusyLocker","./helpers/ModelHelper"],function(t,e,n,o,a,i,r,p){"use strict";var s,l;var c=n.defineUI5Class;function u(t,e){t.prototype=Object.create(e.prototype);t.prototype.constructor=t;f(t,e)}function f(t,e){f=Object.setPrototypeOf?Object.setPrototypeOf.bind():function t(e,n){e.__proto__=n;return e};return f(t,e)}const d=a.NavType;const S="skipMerge";let h=(s=c("sap.fe.core.AppStateHandler"),s(l=function(n){u(a,n);function a(e){var o;o=n.call(this)||this;o._mCurrentAppState={};o.oAppComponent=e;o.sId=`${e.getId()}/AppStateHandler`;o.nbSimultaneousCreateRequest=0;o.bNoRouteChange=false;t.info("APPSTATE : Appstate handler initialized");return o}var i=a.prototype;i.getId=function t(){return this.sId};i.createAppState=async function n(o){if(!this.oAppComponent.getEnvironmentCapabilities().getCapabilities().AppState||r.isLocked(this)){return}const{replaceHash:a=true,skipMerge:i=false}=o||{};const s=this.oAppComponent.getNavigationService(),l=this.oAppComponent.getRouterProxy(),c=l.getHash(),u=this.oAppComponent.getRootControl().getController(),f=p.isStickySessionSupported(this.oAppComponent.getMetaModel());if(!u.viewState){throw new Error(`viewState controller extension not available for controller: ${u.getMetadata().getName()}`)}let d=await u.viewState.retrieveViewState();if(i){d={...d,...{skipMerge:i}}}const S={appState:d};let h=null;if(d&&!e(this._mCurrentAppState,d)){this._mCurrentAppState=d;try{this.nbSimultaneousCreateRequest++;h=await s.storeInnerAppStateAsync(S,true,true);t.info("APPSTATE: Appstate stored");if(a===true){const e=s.replaceInnerAppStateKey(c,h);this.nbSimultaneousCreateRequest--;if(this.nbSimultaneousCreateRequest===0&&e!==c){l.navToHash(e,undefined,undefined,undefined,!f);this.bNoRouteChange=true}t.info("APPSTATE: navToHash")}}catch(e){t.error(e)}}else{h=l.findAppStateInHash(c)}return{appStateData:S,appStateKey:h}};i._createNavigationParameters=function t(e,n){return Object.assign({},e,{selectionVariantDefaults:e.oDefaultedSelectionVariant,selectionVariant:e.oSelectionVariant,requiresStandardVariant:!e.bNavSelVarHasDefaultsOnly,navigationType:n})};i._checkIfLastSeenRecord=function t(e){const n=e&&e.getBindingContext("internal");if(n&&n.getProperty("fclColumnClosed")===true){const t=n.getProperty("technicalKeysOfLastSeenRecord");const o=e===null||e===void 0?void 0:e.getBindingContext();const a=o&&o.getPath()||"";const i=o===null||o===void 0?void 0:o.getModel().getMetaModel();const r=i===null||i===void 0?void 0:i.getMetaPath(a);const p=i===null||i===void 0?void 0:i.getObject(`${r}/$Type/$Key`);for(const e of p){const a=o.getObject()[e];if(a!==t[e]){n.setProperty("fclColumnClosed",false);return true}}}return false};i._getAppStateData=function t(e,n,o){let a="",i=0;const r=o===d.hybrid?e.iAppState:e;if(r!==null&&r!==void 0&&r.appState){for(i;i<Object.keys(r.appState).length;i++){if(Object.keys(r.appState)[i]===n){a=Object.keys(r.appState)[i];break}}}if(r!==null&&r!==void 0&&r.appState){return{[Object.keys(r.appState)[i]]:r.appState[a]||{}}}};i.applyAppState=async function e(n,a){if(!this.oAppComponent.getEnvironmentCapabilities().getCapabilities().AppState||r.isLocked(this)){return Promise.resolve()}const i=this._checkIfLastSeenRecord(a);if(i===true){return Promise.resolve()}r.lock(this);r.lock(this.oAppComponent.getRootControl());const p=this.oAppComponent.getNavigationService();return o(p.parseNavigation()).catch(function(e){if(!e){e=[]}t.warning("APPSTATE: Parse Navigation failed",e[0]);return[{},e[1],e[2]]}).then(e=>{var o;t.info("APPSTATE: Parse Navigation done");const a=e[0]||{},i=e[2]||d.initial,r=this.oAppComponent.getRootControl().getController();const p=this._getAppStateData(a,n,i);const s=a===null||a===void 0?void 0:(o=a.appState)===null||o===void 0?void 0:o[S];this._mCurrentAppState=i===d.iAppState||i===d.hybrid?p:undefined;if(!r.viewState){throw new Error(`viewState extension required for controller ${r.getMetadata().getName()}`)}if((!a||Object.keys(a).length===0)&&i==d.iAppState){if(!r.viewState._getInitialStateApplied()){r.viewState._setInitialStateApplied()}return{}}return r.viewState.applyViewState(this._mCurrentAppState,this._createNavigationParameters(a,i),s)}).catch(function(e){t.error("appState could not be applied",e);throw e}).finally(()=>{r.unlock(this);r.unlock(this.oAppComponent.getRootControl())})};i.checkIfRouteChangedByIApp=function t(){return this.bNoRouteChange};i.resetRouteChangedByIApp=function t(){if(this.bNoRouteChange){this.bNoRouteChange=false}};return a}(i))||l);return h},true);
//# sourceMappingURL=AppStateHandler.js.map