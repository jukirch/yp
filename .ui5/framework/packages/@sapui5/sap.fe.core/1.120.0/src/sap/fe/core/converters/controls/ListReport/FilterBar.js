/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/converters/controls/Common/Table","sap/fe/core/converters/controls/ListReport/VisualFilters","sap/fe/core/converters/helpers/ConfigurableObject","sap/fe/core/converters/helpers/IssueManager","sap/fe/core/converters/helpers/Key","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/PropertyHelper","sap/m/library","../Common/DataVisualization"],function(t,e,n,i,o,a,r,l,s,c,u){"use strict";var d={};var v=u.getSelectionVariant;var p=c.StandardDynamicDateRangeKeys;var f=s.getAssociatedUnitPropertyPath;var g=s.getAssociatedTimezonePropertyPath;var h=s.getAssociatedTextPropertyPath;var y=s.getAssociatedCurrencyPropertyPath;var m=l.getTargetNavigationPath;var P=l.getRelativePaths;var b=l.enhanceDataModelPath;var F=r.isNavigationProperty;var S=r.isMultipleNavigationProperty;var T=r.isEntitySet;var D=r.isComplexType;var E=o.KeyHelper;var C=i.IssueType;var O=i.IssueSeverity;var x=i.IssueCategory;var I=n.insertCustomElements;var A=n.Placement;var N=n.OverrideType;var R=e.getVisualFilters;var U=t.isFilteringCaseSensitive;var M=t.getTypeConfig;var L=t.getSelectionVariantConfiguration;var j;(function(t){t["Default"]="Default";t["Slot"]="Slot"})(j||(j={}));const k="Edm.String";const w="sap.ui.model.odata.type.String";function V(t){const e={};t.Data.forEach(n=>{if(n.$Type==="com.sap.vocabularies.UI.v1.DataField"){var i,o,a,r;e[n.Value.path]={group:t.fullyQualifiedName,groupLabel:((i=t.Label)===null||i===void 0?void 0:i.toString())??((o=t.annotations)===null||o===void 0?void 0:(a=o.Common)===null||a===void 0?void 0:(r=a.Label)===null||r===void 0?void 0:r.toString())??t.qualifier}}});return e}function $(t){return t.reduce((t,e)=>{e.propertyNames.forEach(e=>{t[e]=true});return t},{})}function q(t,e){if(e&&t.length>0){return t.every(t=>t.enableAnalytics&&e===t.annotation.collection)}return false}function H(t,e){const n=[];return t.map(t=>{const i=t.control.filters;const o=[];for(const t in i){if(Array.isArray(i[t].paths)){const a=i[t].paths;a.forEach(t=>{if(t&&t.annotationPath&&!n.includes(t.annotationPath)){n.push(t.annotationPath);const i=L(t.annotationPath,e);if(i){o.push(i)}}})}}return o}).reduce((t,e)=>t.concat(e),[])}const B=function(t,e){const n=e.split("/");let i;let o="";while(n.length){let e=n.shift();i=i?`${i}/${e}`:e;const a=t.resolvePath(i);if(S(a)){e+="*"}o=o?`${o}/${e}`:e}return o};const K=function(t,e,n,i,o){var a,r,l;if(e&&e.targetType===undefined&&(i||((a=e.annotations)===null||a===void 0?void 0:(r=a.UI)===null||r===void 0?void 0:(l=r.Hidden)===null||l===void 0?void 0:l.valueOf())!==true)){var s,c,u,d,v,p,f,g;const i=o.getAnnotationEntityType(e),a={key:E.getSelectionFieldKeyFromPath(n),annotationPath:o.getAbsoluteAnnotationPath(n),conditionPath:B(t,n),availability:((s=e.annotations)===null||s===void 0?void 0:(c=s.UI)===null||c===void 0?void 0:(u=c.HiddenFilter)===null||u===void 0?void 0:u.valueOf())===true?"Hidden":"Adaptation",label:((d=e.annotations.Common)===null||d===void 0?void 0:(v=d.Label)===null||v===void 0?void 0:v.toString())??e.name,group:i.name,groupLabel:(i===null||i===void 0?void 0:(p=i.annotations)===null||p===void 0?void 0:(f=p.Common)===null||f===void 0?void 0:(g=f.Label)===null||g===void 0?void 0:g.toString())??i.name};W(a);return a}return undefined};const W=function(t){if(t.key==="DraftAdministrativeData::CreationDateTime"||t.key==="DraftAdministrativeData::LastChangeDateTime"){const e=[p.TO,p.TOMORROW,p.NEXTWEEK,p.NEXTMONTH,p.NEXTQUARTER,p.NEXTYEAR];t.settings={operatorConfiguration:[{path:"key",equals:e.join(","),exclude:true}]}}};const G=function(t,e,n,i,o){const a={};if(n){n.forEach(n=>{const r=n.name;const l=(e?`${e}/`:"")+r;const s=K(t,n,l,i,o);if(s){a[l]=s}})}return a};const X=function(t,e,n,i){let o={};if(e){e.forEach(e=>{let a={};const r=b(i.getDataModelObjectPath(),e);const l=r.targetObject;if(l===undefined||!n&&r.navigationProperties.find(t=>{var e,n,i;return((e=t.annotations)===null||e===void 0?void 0:(n=e.UI)===null||n===void 0?void 0:(i=n.Hidden)===null||i===void 0?void 0:i.valueOf())===true})){return}if(F(l)){a=G(t,e,l.targetType.entityProperties,n,i)}else if(D(l.targetType)){a=G(t,e,l.targetType.properties,n,i)}else{a=G(t,m(r,true),[l],n,i)}o={...o,...a}})}return o};const J=function(t,e,n,i){let o=t[e];if(o){delete t[e]}else{o=K(i,i.resolvePath(e),e,true,n)}if(!o){var a;(a=n.getDiagnostics())===null||a===void 0?void 0:a.addIssue(x.Annotation,O.High,C.MISSING_SELECTIONFIELD)}if(o){var r,l;o.availability=o.availability==="Hidden"?"Hidden":"Default";o.isParameter=!!((r=i.annotations)!==null&&r!==void 0&&(l=r.Common)!==null&&l!==void 0&&l.ResultContext)}return o};const z=function(t,e,n,i,o){const a=[];const r={};const l=e.entityProperties;o===null||o===void 0?void 0:o.forEach(t=>{r[t.value]=true});if(t&&t.length>0){t===null||t===void 0?void 0:t.forEach(t=>{const r=t.PropertyName;const l=r===null||r===void 0?void 0:r.value;const s={};o===null||o===void 0?void 0:o.forEach(t=>{s[t.value]=true});if(l&&!(l in i)){if(!(l in s)){const t=Z(l,n,e);if(t){a.push(t)}}}})}else if(l){l.forEach(t=>{var o,l;const s=(o=t.annotations)===null||o===void 0?void 0:(l=o.Common)===null||l===void 0?void 0:l.FilterDefaultValue;const c=t.name;if(!(c in i)){if(s&&!(c in r)){const t=Z(c,n,e);if(t){a.push(t)}}}})}return a};function Q(t){var e,n;const i=t.getDataModelObjectPath();const o=i.startingEntitySet.entityType;const a=!!((e=o.annotations)!==null&&e!==void 0&&(n=e.Common)!==null&&n!==void 0&&n.ResultContext)&&!i.targetEntitySet;const r=a&&t.getConverterContextFor(`/${i.startingEntitySet.name}`);return r?o.entityProperties.map(function(t){return J({},t.name,r,o)}):[]}const Y=function(t,e,n){const i=e.length===0||e.every(t=>!t.applySupported.enableSearch);const o=t.length===0||t.every(t=>(t.enableAnalytics||t.control.type==="TreeTable")&&!t.enableBasicSearch);const a=n.getContextPath();if(a&&i&&o){return true}else{return false}};d.getFilterBarHideBasicSearch=Y;const _=function(t,e){const n=e.getManifestWrapper().getFilterConfiguration();const i=(n===null||n===void 0?void 0:n.filterFields)||{};const o=X(t,Object.keys(i).map(t=>i[t].property??E.getPathFromSelectionFieldKey(t)),true,e);const a={};for(const n in i){const r=i[n];const l=r.property??E.getPathFromSelectionFieldKey(n);const s=o[l];const c=r.type==="Slot"?j.Slot:j.Default;const u=r&&r!==null&&r!==void 0&&r.visualFilter?R(t,e,n,i):undefined;if(r.template||r.type===j.Slot){if(r.settings){r.settings.isCustomFilter=true}else{r.settings={isCustomFilter:true}}}a[n]={key:n,type:c,slotName:(r===null||r===void 0?void 0:r.slotName)||n,annotationPath:s===null||s===void 0?void 0:s.annotationPath,conditionPath:r.property?E.getPathFromSelectionFieldKey(n):(s===null||s===void 0?void 0:s.conditionPath)||l,template:r.template,label:r.label,position:r.position||{placement:A.After},availability:r.availability||"Default",settings:r.settings,visualFilter:u,required:r.required}}return a};d.getManifestFilterFields=_;const Z=function(t,e,n){return J({},t,e,n)};d.getFilterField=Z;const tt=function(t,e){let n=[];if(t&&t[e]){n=t[e].map(function(t){return t.value})}return n};d.getFilterRestrictions=tt;const et=function(t){const e={};if(t&&t.FilterExpressionRestrictions){t.FilterExpressionRestrictions.forEach(function(t){var n;if((n=t.Property)!==null&&n!==void 0&&n.value&&t.AllowedExpressions){var i;if(e[(i=t.Property)===null||i===void 0?void 0:i.value]){var o;e[(o=t.Property)===null||o===void 0?void 0:o.value].push(t.AllowedExpressions.toString())}else{var a;e[(a=t.Property)===null||a===void 0?void 0:a.value]=[t.AllowedExpressions.toString()]}}})}return e};d.getFilterAllowedExpression=et;const nt=function(){return{name:"$search",path:"$search",dataType:w,maxConditions:1}};const it=function(){return{name:"$editState",path:"$editState",groupLabel:"",group:"",dataType:w,hiddenFilter:false}};const ot=function(t){var e;const n=t.getEntitySet();return T(n)?(e=n.annotations.Capabilities)===null||e===void 0?void 0:e.SearchRestrictions:undefined};const at=function(t,e){var n,i,o;const a=(n=t.getEntitySet())===null||n===void 0?void 0:(i=n.annotations)===null||i===void 0?void 0:(o=i.Capabilities)===null||o===void 0?void 0:o.NavigationRestrictions;const r=a&&a.RestrictedProperties;return r&&r.find(function(t){return t&&t.NavigationProperty&&t.NavigationProperty.value===e})};d.getNavigationRestrictions=at;const rt=function(t){var e;return{key:t.key,annotationPath:t.annotationPath,conditionPath:t.conditionPath,name:t.conditionPath,label:t.label,hiddenFilter:t.availability==="Hidden",display:"Value",isParameter:t.isParameter,caseSensitive:t.caseSensitive,availability:t.availability,position:t.position,type:t.type,template:t.template,menu:t.menu,required:t.required,isCustomFilter:(e=t.settings)===null||e===void 0?void 0:e.isCustomFilter}};const lt=function(t){const e=["SingleValue","MultiValue","SingleRange","MultiRange","SearchExpression","MultiRangeOrSearchExpression"];t.sort(function(t,n){return e.indexOf(t)-e.indexOf(n)});return t[0]};d.getSpecificAllowedExpression=lt;const st=function(t,e){var n,i,o,a,r,l;const s=t===null||t===void 0?void 0:(n=t.Common)===null||n===void 0?void 0:n.Text,c=s&&(t&&(t===null||t===void 0?void 0:(i=t.Common)===null||i===void 0?void 0:(o=i.Text)===null||o===void 0?void 0:(a=o.annotations)===null||a===void 0?void 0:(r=a.UI)===null||r===void 0?void 0:r.TextArrangement)||e&&(e===null||e===void 0?void 0:(l=e.UI)===null||l===void 0?void 0:l.TextArrangement));if(c){if(c.valueOf()==="UI.TextArrangementType/TextOnly"){return"Description"}else if(c.valueOf()==="UI.TextArrangementType/TextLast"){return"ValueDescription"}return"DescriptionValue"}return s?"DescriptionValue":"Value"};d.displayMode=st;const ct=function(t,e,n){var i;let o=rt(e);const a=e.annotationPath;if(!a){return o}const r=t.getConverterContextFor(a).getDataModelObjectPath().targetObject;const l=r===null||r===void 0?void 0:r.annotations;const s=t===null||t===void 0?void 0:(i=t.getDataModelObjectPath().targetObject)===null||i===void 0?void 0:i.annotations;const c=n.formatOptions;const u=n.constraints;o=Object.assign(o,{formatOptions:c,constraints:u,display:st(l,s)});return o};d.fetchPropertyInfo=ct;const ut=function(t){let e=true;switch(t.filterExpression){case"SearchExpression":case"SingleRange":case"SingleValue":e=false;break;default:break}if(t.type&&t.type.indexOf("Boolean")>0){e=false}return e};d.isMultiValue=ut;const dt=function(t){return(t.$Type==="com.sap.vocabularies.UI.v1.DataField"||t.$Type==="com.sap.vocabularies.UI.v1.DataFieldWithUrl"||t.$Type==="com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath")&&t.Value.path.includes("/")};const vt=function(t,e,n){var i;const o=(i=t.Value)===null||i===void 0?void 0:i.$target;if(o){const t=h(o)||y(o)||f(o)||g(o);const i=t?b(e.getDataModelObjectPath(),t).navigationProperties:undefined;if(i!==null&&i!==void 0&&i.length){const t=i[0].name;if(!n.includes(t)){n.push(t)}}}};const pt=function(t,e,n){var i,o,a;switch(e.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":switch((i=e.Target)===null||i===void 0?void 0:(o=i.$target)===null||o===void 0?void 0:o.$Type){case"com.sap.vocabularies.UI.v1.FieldGroupType":(a=e.Target.$target.Data)===null||a===void 0?void 0:a.forEach(e=>{pt(t,e,n)});break;default:break}break;case"com.sap.vocabularies.UI.v1.DataField":case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":case"com.sap.vocabularies.UI.v1.DataFieldWithNavigationPath":if(dt(e)){const i=P(b(n.getDataModelObjectPath(),e.Value.path)).join("/");if(!t.includes(i)){t.push(i)}}vt(e,n,t);break;default:break}return t};const ft=function(t){var e,n,i;let o=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];let r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";let l=arguments.length>3&&arguments[3]!==undefined?arguments[3]:false;let s=arguments.length>4?arguments[4]:undefined;const c=H(o,t);const u=$(c);const d=t.getEntityType();const p=r&&((e=t.getEntityTypeAnnotation(r))===null||e===void 0?void 0:e.annotation)||((n=d.annotations)===null||n===void 0?void 0:(i=n.UI)===null||i===void 0?void 0:i.SelectionFields)||[];let f=[];if(o.length===0&&!!s){var g;(g=t.getEntityTypeAnnotation(s).annotation)===null||g===void 0?void 0:g.forEach(e=>{f=pt(f,e,t)})}if(a.isDraftRoot(t.getEntitySet())){f.push("DraftAdministrativeData/CreationDateTime","DraftAdministrativeData/CreatedByUser","DraftAdministrativeData/LastChangeDateTime","DraftAdministrativeData/LastChangedByUser")}const h={...G(d,"",d.entityProperties,l,t),...X(d,f,false,t),...X(d,t.getManifestWrapper().getFilterConfiguration().navigationProperties,l,t)};let y=[];const m=v(d,t);if(m){y=m.SelectOptions}const P=(p===null||p===void 0?void 0:p.reduce((e,n)=>{const i=n.value;if(!(i in u)){let n;if(r.startsWith("@com.sap.vocabularies.UI.v1.SelectionFields")){n=""}else{n=r.split("/@com.sap.vocabularies.UI.v1.SelectionFields")[0]}const o=n?n+"/"+i:i;const a=J(h,o,t,d);if(a){a.group="";a.groupLabel="";e.push(a)}}return e},[]))||[];const b=z(y,d,t,u,p);return{excludedFilterProperties:u,entityType:d,annotatedSelectionFields:p,filterFields:h,propertyInfoFields:P,defaultFilterFields:b}};const gt=function(t){const e=M(t,t===null||t===void 0?void 0:t.type);if((t===null||t===void 0?void 0:t.type)===k&&(e.constraints.nullable===undefined||e.constraints.nullable===true)){e.formatOptions.parseKeepsEmptyString=false}return e};d.fetchTypeConfig=gt;const ht=function(t,e,n,i){let o=ct(e,t,i[t.key]),a="";if(t.conditionPath){a=t.conditionPath.replace(/\+|\*/g,"")}if(o){o=Object.assign(o,{maxConditions:!o.isParameter&&ut(o)?-1:1,required:t.required??(o.isParameter||n.includes(a)),caseSensitive:U(e),dataType:i[t.key].type})}return o};d.assignDataTypeToPropertyInfo=ht;const yt=function(t,e,n){var i;const o=[];const r={};if(n){t=t.concat(n)}t.forEach(function(t){if(t.annotationPath){const n=e.getConverterContextFor(t.annotationPath);const i=n.getDataModelObjectPath().targetObject;o.push(i===null||i===void 0?void 0:i.type);const a=gt(i);r[t.key]=a}else{o.push(k);r[t.key]={type:w}}});const l=e.getEntitySet();const s=T(l)?(i=l.annotations.Capabilities)===null||i===void 0?void 0:i.FilterRestrictions:undefined;const c={};c.RequiredProperties=tt(s,"RequiredProperties")||[];c.NonFilterableProperties=tt(s,"NonFilterableProperties")||[];c.FilterAllowedExpressions=et(s);const u=e.getContextPath();const d=u.split("/");if(d.length>2){const t=d[d.length-1];d.splice(-1,1);const n=at(e,t);const i=n&&n.FilterRestrictions;c.RequiredProperties=c.RequiredProperties.concat(tt(i,"RequiredProperties")||[]);c.NonFilterableProperties=c.NonFilterableProperties.concat(tt(i,"NonFilterableProperties")||[]);c.FilterAllowedExpressions={...et(i)||{},...c.FilterAllowedExpressions}}const v=c.RequiredProperties;const p=c.NonFilterableProperties;const f=[];t.forEach(function(t){const n=t.conditionPath.replace(/\+|\*/g,"");if(!p.includes(n)){const n=ht(t,e,v,r);f.push(n)}});const g=e.getDataModelObjectPath();if(a.isObjectPathDraftSupported(g)){f.push(it())}const h=ot(e);const y=Boolean(h&&!h.Searchable);if(u&&y!==true){if(!h||h!==null&&h!==void 0&&h.Searchable){f.push(nt())}}return f};d.processSelectionFields=yt;const mt=function(t,e,n){return I(t,_(e,n),{availability:N.overwrite,label:N.overwrite,type:N.overwrite,position:N.overwrite,slotName:N.overwrite,template:N.overwrite,settings:N.overwrite,visualFilter:N.overwrite,required:N.overwrite})};d.insertCustomManifestElements=mt;const Pt=t=>{t.sort(function(t,e){const n=t.groupLabel!==undefined&&t.groupLabel!==null;const i=e.groupLabel!==undefined&&e.groupLabel!==null;if(!n&&!i){return 0}if(n&&!i){return-1}if(!n&&i){return 1}return t.groupLabel.localeCompare(e.groupLabel)})};d.sortPropertyInfosByGroupLabel=Pt;const bt=function(t){var e,n;let i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];let o=arguments.length>2&&arguments[2]!==undefined?arguments[2]:"";let a=arguments.length>3?arguments[3]:undefined;let r=arguments.length>4?arguments[4]:undefined;const l=ft(t,i,o,a,r);const s=Q(t);let c=l.propertyInfoFields;const u=l.entityType;c=s.concat(c);c=mt(c,u,t);const d=yt(c,t,l.defaultFilterFields);Pt(d);let v=JSON.stringify(d);v=v.replace(/\{/g,"\\{");v=v.replace(/\}/g,"\\}");const p=v;let f=JSON.parse(JSON.stringify(l.propertyInfoFields));f=s.concat(f);const g=l.excludedFilterProperties;const h=u===null||u===void 0?void 0:(e=u.annotations)===null||e===void 0?void 0:(n=e.UI)===null||n===void 0?void 0:n.FilterFacets;let y={};const m=t.getAnnotationsByTerm("UI","com.sap.vocabularies.UI.v1.FieldGroup");if(h===undefined||h.length<0){for(const t in m){y={...y,...V(m[t])}}}else{y=h.reduce((t,e)=>{for(let d=0;d<(e===null||e===void 0?void 0:(n=e.Target)===null||n===void 0?void 0:(i=n.$target)===null||i===void 0?void 0:(o=i.Data)===null||o===void 0?void 0:o.length);d++){var n,i,o,a,r,l,s,c,u;t[e===null||e===void 0?void 0:(a=e.Target)===null||a===void 0?void 0:(r=a.$target)===null||r===void 0?void 0:(l=r.Data[d])===null||l===void 0?void 0:(s=l.Value)===null||s===void 0?void 0:s.path]={group:e===null||e===void 0?void 0:(c=e.ID)===null||c===void 0?void 0:c.toString(),groupLabel:e===null||e===void 0?void 0:(u=e.Label)===null||u===void 0?void 0:u.toString()}}return t},{})}const P=l.filterFields;let b=f.concat(Object.keys(P).filter(t=>!(t in g)).map(t=>Object.assign(P[t],y[t])));const F=t.getContextPath();if(q(i,F)){const t=i[0].aggregates;if(t){const e=Object.keys(t).map(e=>t[e].relativePath);b=b.filter(t=>!e.includes(t.key))}}const S=mt(b,u,t);const T=U(t);S.forEach(t=>{t.caseSensitive=T});return{selectionFields:S,sPropertyInfo:p}};d.getSelectionFields=bt;const Ft=function(t,e,n){const i=tt(e,"RequiredProperties");const o=ot(t);const a=Boolean(o&&!o.Searchable);if(i.length>0||a||(n===null||n===void 0?void 0:n.FetchValues)===2){return true}return false};d.getExpandFilterFields=Ft;return d},false);
//# sourceMappingURL=FilterBar.js.map