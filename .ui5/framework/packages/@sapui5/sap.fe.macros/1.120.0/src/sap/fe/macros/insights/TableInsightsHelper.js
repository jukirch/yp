/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/CommonUtils","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/annotations/DataField","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/TitleHelper","sap/fe/core/templating/CriticalityFormatters","sap/fe/core/templating/PropertyHelper","sap/fe/macros/field/FieldTemplating","sap/ui/mdc/p13n/StateUtil","./CommonInsightsHelper"],function(t,e,n,o,a,i,r,s,l,c){"use strict";var u={};var v=c.createInsightsParams;var d=s.getTextBinding;var p=r.isSemanticKey;var g=r.isImageURL;var f=r.hasSemanticObject;var m=i.buildExpressionForCriticalityIcon;var h=i.buildExpressionForCriticalityColor;var y=a.getTitleBindingExpression;var C=o.pathInModel;var P=o.getExpressionFromAnnotation;var x=o.concat;var I=o.compileExpression;var T=n.isDataFieldTypes;var b=e.getInvolvedDataModelObjects;var S=e.convertTypes;function w(t,e){var n,o;const a=((n=t.annotations.Measures)===null||n===void 0?void 0:n.ISOCurrency)||((o=t.annotations.Measures)===null||o===void 0?void 0:o.Unit);if(!a){return}else{const t=C(e);return I(x(t," ",P(a)))}}function E(t){return"annotationPath"in t}function M(t,e,n){return e.columns.reduce(function(e,o){if(o.name in t&&E(o)){const i=n.resolvePath(o.annotationPath).target;if(o.label&&o.annotationPath.includes("@com.sap.vocabularies.UI.v1.LineItem")&&T(i)){const n=i.Value.$target;if(!(n&&g(n))&&!o.isMultiValue){var a;e.push({...t[o.name],annotationPath:o.annotationPath,formatOptions:(a=o.typeConfig)===null||a===void 0?void 0:a.formatOptions})}}}return e},[])}function U(t){var e;const n=(e=t.annotations.Common)===null||e===void 0?void 0:e.Text;if(n){var o,a;const t=(o=n.annotations)===null||o===void 0?void 0:(a=o.UI)===null||a===void 0?void 0:a.TextArrangement;return!t}return false}function D(e){var n;const o=e.content;const a=(n=o.getModel())===null||n===void 0?void 0:n.getMetaModel();const i=o.data("metaPath");const r={};o.getColumns().forEach(t=>{const e=t.getDataProperty();const n=a.getContext(i+"/"+e);const o=b(n);const s=t.getProperty("header");r[e]={property:e,context:n,objectPath:o,title:s}});const l=M(r,e.getTableDefinition(),S(a));return l.map(function(n){const o=b(n.context);const r=o.targetObject;const l=w(r,n.property);const c=l??d(o,{},false,"extension.formatters.sapfe.formatWithBrackets");const u={visible:false,value:c,title:n.title};if(p(r,o)&&!f(r)){u.value=y(o,s.getTextBindingExpression,n.formatOptions,undefined,t.getTargetView(e).getViewData(),"extension.formatters.sapfe.formatTitle");u.additionalText=U(r)?C(n.property):undefined;u.identifier=true}if(n.annotationPath){const t=F(n.annotationPath,i,a);if(t){u.state=t.state;u.showStateIcon=t.showStateIcon;u.customStateIcon=t.customStateIcon}}return u})}u.getInsightsRelevantColumns=D;function F(t,e,n){const o=b(n.getContext(t),n.getContext(e)),a=o.targetObject;if(a.Criticality){const t=a.CriticalityRepresentation!=="UI.CriticalityRepresentationType/WithoutIcon";return{state:h(a),showStateIcon:t,customStateIcon:t?m(a):""}}return undefined}async function O(t,e){const n=t.content;const o=await v("Table",t,n.getFilter(),e);if(!o){return}try{var a,i;const t=await l.retrieveExternalState(n);const e=(a=t.groupLevels)===null||a===void 0?void 0:(i=a[0])===null||i===void 0?void 0:i.name.split("::").pop();if(e){o.requestParameters.groupBy={property:e}}}catch{throw Error("Error retrieving control states")}o.parameters.isNavigationEnabled=B(t);o.entitySetPath=n.data("metaPath");o.requestParameters.sortQuery=t.getSortConditionsQuery();o.requestParameters.queryUrl=n.getRowBinding().getDownloadUrl();const r={cardTitle:n.getHeader(),insightsRelevantColumns:e};return{...o,content:r}}u.createTableCardParams=O;function B(e){var n,o,a,i;const r=e.content,s=t.getTargetView(e).getViewData(),l=r.data("metaPath"),c=(n=s.navigation)!==null&&n!==void 0&&n[l]?s.navigation[l]:(o=s.navigation)===null||o===void 0?void 0:o[l.replace("/","")];return!(c!==null&&c!==void 0&&(a=c.detail)!==null&&a!==void 0&&a.outbound||c!==null&&c!==void 0&&(i=c.display)!==null&&i!==void 0&&i.target)}return u},false);
//# sourceMappingURL=TableInsightsHelper.js.map