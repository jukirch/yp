/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ResourceModelHelper","sap/fe/macros/CommonHelper","sap/fe/macros/DelegateUtil","sap/fe/macros/chart/ChartHelper","sap/fe/macros/chart/ChartUtils","sap/fe/macros/filter/FilterUtils","sap/ui/core/Core","sap/ui/mdc/enums/ChartItemRoleType","sap/ui/mdc/odata/v4/util/DelegateUtil","sap/ui/mdc/odata/v4/vizChart/ChartDelegate","sap/ui/model/Filter","sap/ui/model/FilterOperator","../filterBar/FilterBarDelegate"],function(e,t,r,a,n,o,i,s,l,c,g,d,u,f,p,h,m){"use strict";var b=n.getResourceModel;var v=a.isMultiValueFilterExpression;var y=a.getSortRestrictionsInfo;var C=a.getFilterRestrictionsInfo;const _=Object.assign({},f);f.apiVersion=2;_._loadChart=async function(){await g.loadLibrary("sap.chart");return f._loadChart()};_._setChartNoDataText=function(e,t){let r="";const a=l.getAllFilterInfo(e),n=t.path.startsWith("/")?t.path.substr(1):t.path;const o=function(){if(e.data("multiViews")){return"M_TABLE_AND_CHART_NO_DATA_TEXT_MULTI_VIEW"}else{return"T_TABLE_AND_CHART_NO_DATA_TEXT_WITH_FILTER"}};if(e.getFilter()){if(a.search||a.filters&&a.filters.length){r=o()}else{r="T_TABLE_AND_CHART_NO_DATA_TEXT"}}else if(a.search||a.filters&&a.filters.length){r=o()}else{r="M_TABLE_AND_CHART_NO_FILTERS_NO_DATA_TEXT"}e.setNoDataText(b(e).getText(r,undefined,n))};_._handleProperty=function(t,r,a,n,i,s){const l=o.parseCustomData(t.data("applySupported"));const c=y(r);const g=r["@Org.OData.Capabilities.V1.FilterRestrictions"];const d=C(g);const u=this.getModel().getObject(this.getPath());const f=this.getModel().getObject(`${this.getPath()}@sapui.name`);const p=this.getModel();const h=t.getP13nMode();I(t,h);if(u&&u.$kind==="Property"){if(u.$isCollection){return}const r=p.getObject(`${this.getPath()}@`);const o=p.getObject("@sapui.name",p.getMetaContext(this.getPath()));const g=l&&l.GroupableProperties;const y=l&&l.AggregatableProperties;let C=g?A(g,o):false;let I=y?A(y,o):false;if(!g||g&&!g.length){C=r["@Org.OData.Aggregation.V1.Groupable"]}if(!y||y&&!y.length){I=r["@Org.OData.Aggregation.V1.Aggregatable"]}if(!C&&!I){return}D(n,f,C,I);const $=Object.keys(n);if(I){const e=_._createPropertyInfosForAggregatable(t,f,r,d,c,a,n);e.forEach(function(e){i.push(e)});if(h&&h.includes("Filter")){const e=Object.keys(a);const n=g.map(e=>e.$PropertyPath);if(e.includes(f)&&!n.includes(f)){var m,b;i=P(i,f,r,$.includes(f)?false:(d===null||d===void 0?void 0:(m=d.propertyInfo)===null||m===void 0?void 0:(b=m[f])===null||b===void 0?void 0:b.filterable)??true,d,c,t,s,u,false,$.includes(f)?false:true,undefined,true)}}}if(C){var v,T;const a=f||"",n=r["@com.sap.vocabularies.Common.v1.Text"]?r["@com.sap.vocabularies.Common.v1.Text"].$Path:null;let o=false;if(a&&a.includes("/")){e.error(`$expand is not yet supported. Property: ${a} from an association cannot be used`);return}if(n&&n.indexOf("/")>-1){e.error(`$expand is not yet supported. Text Property: ${n} from an association cannot be used`);o=true}i=P(i,f,r,$.includes(f)?false:(d===null||d===void 0?void 0:(v=d.propertyInfo)===null||v===void 0?void 0:(T=v[f])===null||T===void 0?void 0:T.filterable)??true,d,c,t,s,u,$.includes(f)?false:true,false,o)}}};function P(e,t,r,a,n,o,i,s,l,c,g,u,f){e.push({name:"_fe_groupable_"+t,propertyPath:t,label:r["@com.sap.vocabularies.Common.v1.Label"]||t,sortable:_._getSortable(i,o.propertyInfo[t],false),filterable:a,groupable:c,aggregatable:g,maxConditions:v(n.propertyInfo[t])?-1:1,sortKey:t,path:t,role:d.category,criticality:s,typeConfig:T(i,a,l),visible:f?!f:true,textProperty:!u&&r["@com.sap.vocabularies.Common.v1.Text"]?r["@com.sap.vocabularies.Common.v1.Text"].$Path:null,textFormatter:r["@com.sap.vocabularies.Common.v1.Text@com.sap.vocabularies.UI.v1.TextArrangement"]});return e}function T(e,t,r){let a;if(t){var n;a=e===null||e===void 0?void 0:(n=e.getTypeMap())===null||n===void 0?void 0:n.getTypeConfig(r.$Type)}return a}function I(e,t){var r,a,n;const o=e===null||e===void 0?void 0:(r=e.getModel())===null||r===void 0?void 0:(a=r.getMetaModel())===null||a===void 0?void 0:(n=a.getObject(`${e.data("targetCollectionPath")}@Org.OData.Capabilities.V1.FilterRestrictions`))===null||n===void 0?void 0:n.Filterable;if(o!==undefined&&!o){t=t.filter(e=>e!=="Filter");e.setP13nMode(t)}}function A(e,t){if(e.length){for(const a of e){var r;if((a===null||a===void 0?void 0:a.$PropertyPath)===t||(a===null||a===void 0?void 0:(r=a.Property)===null||r===void 0?void 0:r.$PropertyPath)===t){return true}}}}function D(e,t,r,a){const n=Object.keys(e);if(r&&a&&n.includes(t)){throw new Error("Same property can not be configured as groupable and aggregatable")}}_.formatText=function(e,t){const r=this.textFormatter;if(!r||r.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextFirst"){return`${t} (${e})`}else if(r.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextLast"){return`${e} (${t})`}else if(r.$EnumMember==="com.sap.vocabularies.UI.v1.TextArrangementType/TextOnly"){return t}return t?t:e};_.updateBindingInfo=function(e,t){const a=e.getBindingContext("internal");a.setProperty("isInsightsEnabled",true);_._setChartNoDataText(e,t);const n=sap.ui.getCore().byId(e.getFilter());const i=e.getConditions();if(!t){t={}}if(!t.parameters){t.parameters={}}if(n){const a=c.getFilterInfo(n,{});const i=o.parseCustomData(e.data("applySupported"));if(i&&i.enableSearch&&a.search){t.parameters.$search=r.normalizeSearchTerm(a.search)}else if(t.parameters.$search){delete t.parameters.$search}}const s=i?u.getParametersInfo(n,i):null;if(s){t.path=s}const g=l.getAllFilterInfo(e);if(g.filters){g.filters=r.getChartPropertiesWithoutPrefixes(g.filters)}t.filters=g.filters.length>0?new p({filters:g.filters,and:true}):undefined;t.sorter=this.getSorters(e);_._checkAndAddDraftFilter(e,t)};_.fetchProperties=function(e){const t=this._getModel(e);let r;if(!t){r=new Promise(t=>{e.attachModelContextChange({resolver:t},$,this)}).then(t=>this._createPropertyInfos(e,t))}else{r=this._createPropertyInfos(e,t)}return r.then(function(t){if(e.data){e.data("$mdcChartPropertyInfo",t);i.setCachedProperties(e,t)}return t})};function $(e,t){const r=e.getSource();const a=this._getModel(r);if(a){r.detachModelContextChange($);t.resolver(a)}}_._createPropertyInfos=async function(e,t){const r=`/${e.data("entitySet")}`;const a=t.getMetaModel();const n=await Promise.all([a.requestObject(`${r}/`),a.requestObject(`${r}@`)]);const i=[];const l=n[0];const c=n[1];const g=o.parseCustomData(e.data("customAgg"));x(g,e);let d;const u=[];for(const e in c){if(e.startsWith("@Org.OData.Aggregation.V1.CustomAggregate")){d=e.replace("@Org.OData.Aggregation.V1.CustomAggregate#","");const t=d.split("@");if(t.length==2&&t[1]=="com.sap.vocabularies.Common.v1.Label"){g[t[0]]=c[e]}}}const f=o.parseCustomData(e.data("transAgg"));const p={};for(const e in f){const t=f[e].propertyPath;p[t]=p[t]||{};p[t][f[e].aggregationMethod]={name:f[e].name,label:f[e].label}}for(const t in l){if(t.indexOf("$")!==0){u.push(s.fetchCriticality(a,a.createBindingContext(`${r}/${t}`)).then(_._handleProperty.bind(a.getMetaContext(`${r}/${t}`),e,c,p,g,i)))}}await Promise.all(u);return i};function x(t,r){const a=[],n=[];if(t&&Object.keys(t).length>=1){const t=r.getItems();for(const e in t){if(t[e].getType()==="groupable"){a.push(_.getInternalChartNameFromPropertyNameAndKind(t[e].getName(),"groupable"))}else if(t[e].getType()==="aggregatable"){n.push(_.getInternalChartNameFromPropertyNameAndKind(t[e].getName(),"aggregatable"))}}if(n.filter(function(e){return a.includes(e)}).length>=1){e.error("Dimension and Measure has the sameProperty Configured")}}}_._createPropertyInfosForAggregatable=function(e,r,a,n,o,i,s){const l=[];if(Object.keys(i).includes(r)){for(const e in i[r]){l.push({name:"_fe_aggregatable_"+i[r][e].name,propertyPath:r,label:i[r][e].label||`${a["@com.sap.vocabularies.Common.v1.Label"]} (${e})`||`${r} (${e})`,sortable:o.propertyInfo[r]?o.propertyInfo[r].sortable:true,filterable:false,groupable:false,aggregatable:true,path:r,aggregationMethod:e,maxConditions:v(n.propertyInfo[r])?-1:1,role:d.axis1,datapoint:null})}}if(Object.keys(s).includes(r)){for(const e in s){if(e===r){const r=t({},s[e],{name:"_fe_aggregatable_"+e,groupable:false,aggregatable:true,filterable:false,role:d.axis1,propertyPath:e,datapoint:null});l.push(r);break}}}return l};_.rebind=function(e,t){const r=t.parameters.$search;if(r){delete t.parameters.$search}f.rebind(e,t);if(r){const t=e.getControlDelegate().getInnerChart(e),a=t&&t.getBinding("data");a.suspend();a.setAggregation({search:r});const n={onBeforeRendering:function(){a.resume();t.removeEventDelegate(n)}};t.addEventDelegate(n)}e.fireEvent("bindingUpdated")};_._setChart=function(e,t){const r=e.getParent();t.setVizProperties(e.data("vizProperties"));t.detachSelectData(r.handleSelectionChange.bind(r));t.detachDeselectData(r.handleSelectionChange.bind(r));t.detachDrilledUp(r.handleSelectionChange.bind(r));t.attachSelectData(r.handleSelectionChange.bind(r));t.attachDeselectData(r.handleSelectionChange.bind(r));t.attachDrilledUp(r.handleSelectionChange.bind(r));t.setSelectionMode(e.getPayload().selectionMode.toUpperCase());f._setChart(e,t)};_._getBindingInfo=function(e){if(this._getBindingInfoFromState(e)){return this._getBindingInfoFromState(e)}const r=e.getDelegate().payload;const a=e.getModel()&&e.getModel().getMetaModel();const n=e.data("targetCollectionPath");const o=(a.getObject(`${n}/$kind`)!=="NavigationProperty"?"/":"")+r.contextPath;const i=t({},r.parameters,{entitySet:e.data("entitySet")});return{path:o,events:{dataRequested:e.getParent().onInternalDataRequested.bind(e.getParent())},parameters:i}};_.removeItemFromInnerChart=function(e,t){f.removeItemFromInnerChart.call(this,e,t);if(t.getType()==="groupable"){const t=this.getInnerChart(e);t.fireDeselectData()}};_._getSortable=function(e,t,r){if(r){if(e.data("draftSupported")==="true"){return false}else{return t?t.sortable:true}}return t?t.sortable:true};_._checkAndAddDraftFilter=function(e,t){if(e.data("draftSupported")==="true"){if(!t){t={}}if(!t.filters){t.filters=[];t.filters.push(new p("IsActiveEntity",h.EQ,true))}else{var r,a;(r=t.filters)===null||r===void 0?void 0:(a=r.aFilters)===null||a===void 0?void 0:a.push(new p("IsActiveEntity",h.EQ,true))}}};_.getInternalChartNameFromPropertyNameAndKind=function(e,t){return e.replace("_fe_"+t+"_","")};_.getPropertyFromNameAndKind=function(e,t,r){return r.getPropertyHelper().getProperty("_fe_"+t+"_"+e)};_.getFilterDelegate=function(){return Object.assign({apiVersion:2},m,{addItem:function(e,t){const r=_.getInternalChartNameFromPropertyNameAndKind(t,"groupable");return m.addItem(e,r).then(e=>{e===null||e===void 0?void 0:e.bindProperty("conditions",{path:"$filters>/conditions/"+t});return e})}})};return _},false);
//# sourceMappingURL=ChartDelegate.js.map