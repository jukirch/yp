/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/merge","sap/fe/core/CommonUtils","sap/fe/core/converters/ConverterContext","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/SemanticDateOperators","sap/fe/core/templating/DisplayModeFormatter","sap/fe/macros/CommonHelper","sap/fe/macros/DelegateUtil","sap/ui/core/Core","sap/ui/mdc/condition/Condition","sap/ui/mdc/condition/ConditionConverter","sap/ui/mdc/enums/ConditionValidated","sap/ui/mdc/odata/v4/TypeMap","sap/ui/mdc/p13n/StateUtil","sap/ui/mdc/util/FilterUtil","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/odata/v4/ODataUtils"],function(t,e,n,i,o,r,a,s,l,c,f,d,u,g,p,y,h,C,m,F,v,P){"use strict";var T=c.ODATA_TYPE_MAPPING;var b=a.getAllCustomAggregates;const S={getFilter:function(t){const e=S.getFilterInfo(t).filters;return e.length?new F(S.getFilterInfo(t).filters,false):undefined},getFilterField:function(t,e,n){return r.getFilterField(t,e,n)},buildProperyInfo:function(t,e){let n;const i={};const o=e.getConverterContextFor(t.annotationPath);const a=o.getDataModelObjectPath().targetObject;const s=r.fetchTypeConfig(a);n=r.fetchPropertyInfo(e,t,s);i[t.key]=s;n=r.assignDataTypeToPropertyInfo(n,e,[],i);return n},createConverterContext:function(t,r,a,s){const l=d.getCustomData(t,"entityType"),c=r||l;const f=t.isA?n.getTargetView(t):null;const u=a||t.getModel().getMetaModel();const g=s||f&&n.getAppComponent(f);const p=o.getInvolvedDataModelObjects(u.createBindingContext(c));let y;if(t.isA&&!t.isA("sap.ui.mdc.filterbar.vh.FilterBar")){y=f&&f.getViewData()||{}}return i.createConverterContextForMacro(p.startingEntitySet.name,u,g===null||g===void 0?void 0:g.getDiagnostics(),e,p.contextLocation,y)},getConvertedFilterFields:function(t,e,n,i,o,r,a){const s=this._getFilterMetaModel(t,i);const l=d.getCustomData(t,"entityType"),c=e||l;const f=this._getFieldsForTable(t,e);const u=this.createConverterContext(t,e,i,o);return this._getSelectionFields(t,e,l,c,f,s,u,n,r,a)},getBindingPathForParameters:function(t,n,i,o){const r=[];i=S.setTypeConfigToProperties(i);for(let a=0;a<o.length;a++){const s=o[a];if(n[s]&&n[s].length>0){const o=e({},n[s][0]);const a=m.getPropertyByKey(i,s);const l=a.typeConfig||h.getTypeConfig(a.dataType,a.formatOptions,a.constraints);const c=p.toType(o,l,t.getTypeMap());const f=T[l.className];r.push(`${s}=${encodeURIComponent(P.formatLiteral(c.values[0],f))}`)}}const a=t.data("entityType");const s=a.substring(0,a.length-1);const l=s.slice(0,s.lastIndexOf("/"));const c=s.substring(s.lastIndexOf("/")+1);return`${l}(${r.toString()})/${c}`},getEditStateIsHideDraft:function(t){let e=false;if(t&&t.$editState){const n=t.$editState.find(function(t){return t.operator==="DRAFT_EDIT_STATE"});if(n&&(n.values.includes("ALL_HIDING_DRAFTS")||n.values.includes("SAVED_ONLY"))){e=true}}return e},getFilterInfo:function(t,e,n){let i=e&&e.ignoredProperties||[];const o=e&&e.targetControl,r=o?o.data("entityType"):undefined;const a={};let s=t,l,c=[],f,d=e&&e.propertiesMetadata;if(typeof t==="string"){s=u.byId(t)}if(s){l=this._getSearchField(s,i);const t=this._getFilterConditions(e,n,s);let o=s.getPropertyInfoSet?s.getPropertyInfoSet():null;o=this._getFilterPropertiesMetadata(o,s);if(e&&e.targetControl&&e.targetControl.isA("sap.ui.mdc.Chart")){Object.keys(t).forEach(function(e){if(e==="$editState"){delete t["$editState"]}})}let u=s.data("parameters")||[];u=typeof u==="string"?JSON.parse(u):u;if(u&&u.length>0){f=S.getBindingPathForParameters(s,t,o,u);if(Object.keys(t).length){Object.keys(t).forEach(e=>{u.forEach(n=>{if(e===n){const i=t[e][0].values;a[n]=i[0]}})})}}if(t){if(r&&s.data("entityType")&&s.data("entityType")!==r){const t=s.getModel().getMetaModel();const e=s.getControlDelegate().fetchPropertiesForEntity(r,t,s);d=e;const n=this._getIgnoredProperties(o,e);if(n.length>0){i=i.concat(n)}}else if(!d){d=o}const e=m.getFilterInfo(s,t,S.setTypeConfigToProperties(d),i.concat(u)).filters;c=e?[e]:[]}}return{parameters:a,filters:c,search:l||undefined,bindingPath:f}},setTypeConfigToProperties:function(t){if(t&&t.length){t.forEach(function(t){if(t.typeConfig&&t.typeConfig.typeInstance&&t.typeConfig.typeInstance.getConstraints instanceof Function){return}if(t.path==="$editState"){t.typeConfig=h.getTypeConfig("sap.ui.model.odata.type.String",{},{})}else if(t.path==="$search"){t.typeConfig=h.getTypeConfig("sap.ui.model.odata.type.String",{},{})}else if(t.dataType||t.typeConfig&&t.typeConfig.className){t.typeConfig=h.getTypeConfig(t.dataType||t.typeConfig.className,t.formatOptions,t.constraints)}})}return t},getNotApplicableFilters:function(t,e){var n;const i=e.data("entityType"),o=t.data("entityType"),r=t.getModel().getMetaModel(),a=r.getObject(o),s=[],l=t.getConditions(),c=i===o,u=e.isA("sap.ui.mdc.Chart"),g=!u&&e.getParent().getTableDefinition().enableAnalytics,p=!u&&((n=e.control)===null||n===void 0?void 0:n.type)==="TreeTable",y=u?f.parseCustomData(d.getCustomData(e,"applySupported")).enableSearch:!(g||p)||e.getParent().getTableDefinition().enableBasicSearch;if(l&&(!c||g||u)){const n=c?[]:t.getControlDelegate().fetchPropertiesForEntity(i,r,t),o=n.reduce(function(t,e){t[e.name]=e;return t},{}),f=!u&&e.getParent().getTableDefinition().aggregates||{},d={};Object.keys(f).forEach(function(t){const e=f[t];d[e.relativePath]=e});const g=e.getModel().getMetaModel().getObject(e.data("targetCollectionPath")+"/");if(e.isA("sap.ui.mdc.Chart")){const t=e.getModel().getMetaModel().getObject(`${e.data("targetCollectionPath")}@`),n=b(t);Object.keys(n).forEach(function(t){if(!d[t]){const e=n[t];d[t]=e}})}for(const t in l){const e=l[t];let n=true;if(g[t]&&a[t]){n=g[t]["$Type"]===a[t]["$Type"]}if(Array.isArray(e)&&e.length>0&&((!o[t]||o[t].isCustomFilter&&o[t].annotationPath==undefined||o[t]&&!n)&&(!c||t==="$editState"&&u)||d[t])){s.push(t.replace(/\+|\*/g,""))}}}if(!y&&t.getSearch()){s.push("$search")}return s},async _getValueListInfo(t,e){var n;const i=(n=t.getModel())===null||n===void 0?void 0:n.getMetaModel();if(!i){return undefined}const o=t.data("entityType")??"";const r=await i.requestValueListInfo(o+e,true).catch(()=>null);return r===null||r===void 0?void 0:r[""]},_getConditionValidated:async function(e,n,i){if(!e){return y.NotValidated}try{const t=e.Parameters.filter(t=>["com.sap.vocabularies.Common.v1.ValueListParameterInOut".valueOf(),"com.sap.vocabularies.Common.v1.ValueListParameterOut".valueOf()].includes(t.$Type)).filter(t=>{var e;return((e=t.LocalDataProperty)===null||e===void 0?void 0:e.$PropertyPath)===n}).map(t=>t.ValueListProperty);const o=t[0]??n;const r=new F({path:o,operator:v.EQ,value1:i});const a=e.$model.bindList(`/${e.CollectionPath}`,undefined,undefined,r,{$select:o});const s=(await a.requestContexts()).length>0;if(s){return y.Validated}else{return y.NotValidated}}catch(e){t.error("FilterUtils: Error while retrieving ConditionValidated",e);return y.NotValidated}},async _clearFilterValue(t,e){const n=await C.retrieveExternalState(t);if(n.filter[e]){n.filter[e].forEach(t=>{t.filtered=false});await C.applyExternalState(t,{filter:{[e]:n.filter[e]}})}},setFilterValues:async function(e,n){for(var i=arguments.length,o=new Array(i>2?i-2:0),r=2;r<i;r++){o[r-2]=arguments[r]}let a=o===null||o===void 0?void 0:o[0];let s=o===null||o===void 0?void 0:o[1];if(!e){return}if(o.length===2&&(s===undefined||s===null||s==="")&&a&&Object.keys(v).includes(a)){t.warning(`An empty filter value cannot be applied with the ${a} operator`);return}if(s===undefined&&!l.getSemanticDateOperations().includes(a||"")){s=a??[];a=undefined}if(!a){a=v.EQ}const c=["string","number","boolean"];if(s!==undefined&&(!Array.isArray(s)&&!c.includes(typeof s)||Array.isArray(s)&&s.length>0&&!c.includes(typeof s[0]))){throw new Error("FilterUtils.js#_setFilterValues: Filter value not supported; only primitive values or an array thereof can be used.")}let f;if(s!==undefined){f=Array.isArray(s)?s:[s]}const d=await this._getValueListInfo(e,n);const u={};if(n){if(f&&f.length){if(a===v.BT){u[n]=[g.createCondition(a,f,null,null,y.NotValidated)]}else{u[n]=await Promise.all(f.map(async t=>{const e=a===v.EQ?await this._getConditionValidated(d,n,t):y.NotValidated;return g.createCondition(a,[t],null,null,e)}))}}else if(l.getSemanticDateOperations().includes(a||"")){u[n]=[g.createCondition(a,[],null,null,y.NotValidated)]}}await this._clearFilterValue(e,n);if(u[n]){await C.applyExternalState(e,{filter:u})}},conditionToModelPath:function(t){return t.replace(/\//g,"\\")},_getFilterMetaModel:function(t,e){return e||t.getModel().getMetaModel()},_getEntitySetPath:function(t){return t&&s.getEntitySetPath(t)},_getFieldsForTable:function(t,e){const i=[];if(e){const e=n.getTargetView(t);const o=e&&e.getController()&&e.getController()._getControls&&e.getController()._getControls("table");if(o){o.forEach(function(t){i.push(t.getParent().getTableDefinition())})}return i}return[]},_getSelectionFields:function(t,e,n,i,a,s,l,c,f,d){let u=r.getSelectionFields(l,a,undefined,c,d).selectionFields;if((f?f.getControlType(t)==="sap.ui.mdc.FilterBar":t.isA("sap.ui.mdc.FilterBar"))&&e!==n){const t=o.getInvolvedDataModelObjects(s.createBindingContext(i));const e=l.getConverterContextFor(n);const a=e.getEntityTypeAnnotation("@com.sap.vocabularies.UI.v1.SelectionFields").annotation||[];const c={};u.forEach(function(t){c[t.conditionPath]=true});a.forEach(function(e){const n=e.value;if(!c[n]){const e=r.getFilterField(n,l,t.startingEntitySet.entityType);if(e){u.push(e)}}})}if(u){const e=[];u.forEach(function(t){e.push(t.key)});u=this._getSelectionFieldsFromPropertyInfos(t,e,u)}return u},_getSelectionFieldsFromPropertyInfos:function(t,e,n){const i=t.getPropertyInfo&&t.getPropertyInfo()||[];i.forEach(function(t){if(t.name==="$search"||t.name==="$editState"){return}const i=n[e.indexOf(t.key)];if(e.indexOf(t.key)!==-1&&i.annotationPath){t.group=i.group;t.groupLabel=i.groupLabel;t.settings=i.settings;t.visualFilter=i.visualFilter;t.label=i.label;n[e.indexOf(t.key)]=t}if(e.indexOf(t.key)===-1&&!t.annotationPath){n.push(t)}});return n},_getSearchField:function(t,e){return t.getSearch&&e.indexOf("search")===-1?t.getSearch():null},_getFilterConditions:function(t,e,n){const i=e||n.getConditions();if(t&&t.targetControl&&t.targetControl.isA("sap.ui.mdc.Chart")){Object.keys(i).forEach(function(t){if(t==="$editState"){delete i["$editState"]}})}return i},_getFilterPropertiesMetadata:function(t,e){if(!(t&&t.length)){if(e.getPropertyInfo){t=e.getPropertyInfo()}else{t=null}}return t},_getIgnoredProperties:function(t,e){const n=[];t.forEach(function(t){const i=t.name;const o=e.find(t=>t.name===i);if(o&&(!t.isCustomFilter&&t.dataType!==o.dataType||t.isCustomFilter&&!e.find(e=>!e.isCustomFilter&&e.annotationPath==t.annotationPath))){n.push(i)}});return n},getFilters:function(t){const{parameters:e,filters:n,search:i}=this.getFilterInfo(t);return{parameters:e,filters:n,search:i}}};return S},false);
//# sourceMappingURL=FilterUtils.js.map