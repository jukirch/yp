/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/ActivitySync","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/TypeGuards","sap/fe/macros/internal/valuehelp/ValueListHelper","sap/m/inputUtils/highlightDOMElements","sap/ui/mdc/ValueHelpDelegate","sap/ui/mdc/condition/Condition","sap/ui/mdc/enums/ConditionValidated","sap/ui/mdc/odata/v4/TypeMap","sap/ui/mdc/p13n/StateUtil","sap/ui/model/FilterType","../internal/valuehelp/AdditionalValueHelper"],function(t,e,n,i,o,a,r,l,s,d,u,c,g,f,p){"use strict";var h=p.additionalValueHelper;var v=p.AdditionalValueGroupKey;var P=a.isPathAnnotationExpression;var m=o.convertTypes;var C=i.Activity;const y="sap.fe.core.controls.FilterBar";return Object.assign({},s,{apiVersion:2,isSearchSupported:function(t,e,n){return e.getFilterFields()==="$search"},updateBindingInfo:function(t,n,i){s.updateBindingInfo(t,n,i);if(n.getFilterFields()==="$search"){const t=n.getFilterValue();const o=e.normalizeSearchTerm(t);if(i.parameters){i.parameters.$search=o||undefined}}},updateBinding:async function(t,e,n,i){const o=t.getPayload();const a=this._getValueListPropertyFromPayloadQualifier(o);const r=i.getControl().isA("sap.ui.mdc.FilterField")||i.getControl().isA("sap.ui.mdc.MultiValueField");const l=i.getControl();const s=!r&&l.getValue();if((!s||l!==null&&l!==void 0&&l.hasPendingUserInput())&&i.isTypeahead()&&!o.isDefineConditionValueHelp){var d;const t=i.getBindingContext();const l=[];const s=i.getModel("internal").getProperty("/recommendationsData")||{};let c=[];if(!r){var u;c=h.getRelevantRecommendations(s,t,o.propertyPath,(u=i.getControl().getBinding("value"))===null||u===void 0?void 0:u.getPath())||[]}if(((d=c)===null||d===void 0?void 0:d.length)>0){l.push({propertyPath:a,values:c,groupKey:v.recommendation});this._updateBindingForRecommendations(o,e,n,l)}else{this._updateBinding(e,n)}}else{this._updateBinding(e,n)}},executeFilter:async function(t,e,n){e.getContexts(0,n);await this.checkListBindingPending(t,e,n);return e},checkListBindingPending:async function(t,e,n){const i=t.getPayload();let o=false;if(i.updateBindingDonePromise){const t=await i.updateBindingDonePromise;o=!t}else if(e&&!e.isSuspended()){const t=await e.requestContexts(0,n);o=t.length===0}return o},getTypeMap:function(t){return c},retrieveContent:function(t,e,n){const i=t.getPayload();return r.showValueList(i,e,n)},_getConditionPayloadList:function(t){const e=t.payload||{},n=Object.keys(e),i=n.length?e[n[0]]:[];return i},_getValueListPropertyFromPayloadQualifier:function(t){const e=t.qualifiers[t.valueHelpQualifier].vhParameters||[];const n=t.qualifiers[t.valueHelpQualifier].vhKeys||[];const i=t.valueHelpKeyPath;let o=[...n];const a=[];if(e.length>0){e.forEach(function(t){a.push(t.helpPath)});o=n.filter(t=>!a.includes(t))}return i&&o.includes(i)?i:""},_onConditionPropagationToFilterBar:async function(e,n,i,o,a){try{var r;const t=await g.retrieveExternalState(a);const l=t.items;const s=i.getPropertyHelper().getProperties();const c=(r=i.getModel())===null||r===void 0?void 0:r.getMetaModel();const f=`/${o.propertyPath.split("/")[1]}`;for(const i of e){const e=this._getConditionPayloadList(i);for(const i of n){const n=i.source.split("conditions/").pop()||"";const a=o.propertyPath.lastIndexOf("/");const r=a>0?`${o.propertyPath.substring(0,a)}/${n}`:n;const g=c===null||c===void 0?void 0:c.getReducedPath(r,f);const p=s.find(t=>t.annotationPath===g);if(p&&l!==null&&l!==void 0&&l.find(t=>t.name===p.name)){for(const n of e){const e=d.createCondition("EQ",[n[i.helpPath]],null,null,u.Validated);t.filter[p.conditionPath]||=[];t.filter[p.conditionPath].push(e)}}}}g.applyExternalState(i,t)}catch(e){const n=e instanceof Error?e.message:String(e);t.error(`ValueHelpDelegate: ${n}`)}},_onConditionPropagationToBindingContext:function(e,n,i,o){const a=i.getModel().getMetaModel();for(const r of e){const e=this._getConditionPayloadList(r),l=e.length===1?e[0]:undefined;if(e.length>1){t.warning("ValueHelpDelegate: ParameterOut in multi-value-field not supported")}if(l){this._onConditionPropagationUpdateProperty(a,l,n,i,o)}}},_onConditionPropagationUpdateProperty:function(t,i,o,a,r){const l=m(t);const s=t.getMetaContext(a.getPath()).getPath();const d=a.isTransient()!==true&&!a.isInactive();const u=[];for(const t of o){if(a.getProperty(t.source)!==i[t.helpPath]){this._updatePropertyViaOutParameter(l,s,i,t,a,d)}u.push(t.source)}if(n.isConnected(r)){let t;if(a.getBinding().isA("sap.ui.model.odata.v4.ODataListBinding")){t=a.getBinding()}else{const n=e.getTargetView(r);t=n.getBindingContext().getBinding()}t.attachEventOnce("patchCompleted",()=>{n.send(r,{action:C.Change,content:u.map(t=>a.getPath()+"/"+t)})})}},_updatePropertyViaOutParameter:function(t,e,n,i,o,a){var r,l,s,d,u,c;const g=`${e}/${i.source}`;const f=t.resolvePath(g).target;const p=f===null||f===void 0?void 0:(r=f.annotations)===null||r===void 0?void 0:(l=r.Common)===null||l===void 0?void 0:l.FieldControl;const h=P(p)?o.getProperty(p.path)===1:false;if(h&&a){const t=i.source.lastIndexOf("/");const e=t>0?i.source.substring(0,t):i.source;o.requestSideEffects([e])}else{o.setProperty(i.source,n[i.helpPath])}const v=P(f===null||f===void 0?void 0:(s=f.annotations)===null||s===void 0?void 0:(d=s.Common)===null||d===void 0?void 0:d.Text)?f===null||f===void 0?void 0:(u=f.annotations)===null||u===void 0?void 0:(c=u.Common)===null||c===void 0?void 0:c.Text.path:undefined;if(v!==undefined&&a){const t=v.lastIndexOf("/");const e=t>0?v.substring(0,t):v;o.requestSideEffects([e])}},getFilterConditions:function(t,e,n){if(this.getInitialFilterConditions){return this.getInitialFilterConditions(t,e,n&&n.control||e&&e.getControl())}return{}},onConditionPropagation:async function(t,e,n){const i=t.getPayload();if(e!=="ControlChange"||i.isDefineConditionValueHelp){return}const o=i.qualifiers[i.valueHelpQualifier];const a=(o===null||o===void 0?void 0:o.vhParameters)!==undefined?r.getOutParameters(o.vhParameters):[],l=t.getControl(),s=l.getParent();let d=l.getConditions();d=d.filter(function(t){const e=t.payload||{};return e[i.valueHelpQualifier]});const u=t.getParent();if(u.isA(y)){await this._onConditionPropagationToFilterBar(d,a,s,i,u)}else{const e=l.getBindingContext();if(e){this._onConditionPropagationToBindingContext(d,a,e,t)}}},_createInitialFilterCondition:function(e,n){let i;if(e===undefined||e===null){t.error("ValueHelpDelegate: value of the property could not be requested")}else if(e===""){if(n){i=d.createCondition("Empty",[],null,null,u.Validated)}}else{i=d.createCondition("EQ",[e],null,null,u.Validated)}return i},_getInitialFilterConditionsFromBinding:async function(e,n,i,o){const a=n.getBindingContext();if(!a){t.error("ValueHelpDelegate: No BindingContext");return e}let r="";if(a.getBinding().getPath()!=="$Parameter"){var l;const t=(l=n.getModel())===null||l===void 0?void 0:l.getMetaModel();const e=t.getMetaPath(a.getPath());r=o.propertyPath.replace(e+"/","");const i=r.lastIndexOf("/");r=i>0?`${r.substring(0,i)}/`:""}const s=i.map(t=>r+t.source);const d=await a.requestProperty(s);for(let t=0;t<i.length;t++){const n=i[t];const o=this._createInitialFilterCondition(d[t],n.initialValueFilterEmpty);if(o){e[n.helpPath]=[o]}}return e},_getInitialFilterConditionsFromFilterBar:async function(t,e,n){const i=e.getParent();const o=await g.retrieveExternalState(i);for(const e of n){const n=this._getConditionsFromInParameter(e,o);if(n){t[e.helpPath]=n}}return t},_getConditionsFromInParameter:function(t,e){const n=t.source;const i=Object.keys(e.filter).find(t=>("/"+n).endsWith("/"+t));return i&&e.filter[i]},_partitionInParameters:function(t){const e={constant:[],binding:[],filter:[]};for(const n of t){if(n.constantValue!==undefined){e.constant.push(n)}else if(n.source.indexOf("$filter")===0){e.filter.push(n)}else{e.binding.push(n)}}return e},_tableAfterRenderDelegate:{onAfterRendering:function(t){const e=t.srcControl,n=e.$().find("tbody .sapMText"),i=e.getParent();l(n,i.getFilterValue(),true)}},getInitialFilterConditions:async function(e,n,i){if(n!==null&&n!==void 0&&n.isA("sap.ui.mdc.valuehelp.content.MTable")){const t=n.getTable();t===null||t===void 0?void 0:t.removeEventDelegate(this._tableAfterRenderDelegate);t===null||t===void 0?void 0:t.addEventDelegate(this._tableAfterRenderDelegate,this)}const o=e.getPayload();const a={};if(o.isDefineConditionValueHelp){return a}if(!i){t.error("ValueHelpDelegate: Control undefined");return a}const l=o.qualifiers[o.valueHelpQualifier];const s=(l===null||l===void 0?void 0:l.vhParameters)!==undefined?r.getInParameters(l.vhParameters):[];const d=this._partitionInParameters(s);const u=i.getBindingContext();for(const t of d.constant){const e=this._createInitialFilterCondition(t.constantValue,u?t.initialValueFilterEmpty:false);if(e){a[t.helpPath]=[e]}}if(d.binding.length){await this._getInitialFilterConditionsFromBinding(a,i,d.binding,o)}if(d.filter.length){await this._getInitialFilterConditionsFromFilterBar(a,i,d.filter)}return a},createConditionPayload:function(t,e,n,i){const o=t.getPayload();const a=o.qualifiers[o.valueHelpQualifier],r={},l={};const s=e.getControl();const d=s===null||s===void 0?void 0:s.isA("sap.ui.mdc.MultiValueField");if(!a.vhKeys||a.vhKeys.length===1||d){return undefined}a.vhKeys.forEach(function(t){const e=i.getObject(t);if(e!=null){r[t]=(e===null||e===void 0?void 0:e.length)===0?"":e}});if(Object.keys(r).length){l[o.valueHelpQualifier]=[r]}return l},isFilterableListItemSelected:function(t,e,n,i){var o;const a=t.getPayload();if(a.isValueListWithFixedValues!==true&&((o=e.getConfig())===null||o===void 0?void 0:o.maxConditions)===1){return false}const r=n.getBindingContext();i=i.filter(t=>t.validated===u.Validated);const l=i.find(function(t){var n;const i=t.payload,o=a.valueHelpQualifier||"";if(!i&&Object.keys(a.qualifiers)[0]===o){const n=e.getKeyPath();return(r===null||r===void 0?void 0:r.getObject(n))===(t===null||t===void 0?void 0:t.values[0])}const l=(i===null||i===void 0?void 0:(n=i[o])===null||n===void 0?void 0:n[0])||{},s=Object.keys(l);if(s.length){return s.every(function(t){return l[t]===(r===null||r===void 0?void 0:r.getObject(t))})}return false});return l?true:false},_updateBindingForRecommendations:async function(t,e,n,i){let o;t.updateBindingDonePromise=new Promise(function(t){o=t});try{h.sortAndFilterOthers(e,n,i);h.resumeValueListBindingAndResetChanges(e);const t=await h.requestForAdditionalValueContextData(i,e,n);const o=h.removeDuplicateAdditionalValues(t,[...i]);h.createAdditionalValueTransientContexts(t,o.reverse(),e)}catch(t){}if(o){o(true)}},_updateBinding:async function(t,e){const n=t.getRootBinding()||t;if(!n.isSuspended()){n.suspend()}if(e.parameters){t.changeParameters(e.parameters)}t.filter(e.filters,f.Application);t.sort(e.sorter);if(n.isSuspended()){n.resume();n.resetChanges()}},checkIfAdditionalValuesExists:function(t,e){var n;if(e.isDefineConditionValueHelp){return false}const i=t.getBindingContext();const o=t.getModel("internal").getProperty("/recommendationsData")||{};const a=h.getRelevantRecommendations(o,i,e.propertyPath,(n=t.getControl().getBinding("value"))===null||n===void 0?void 0:n.getPath())||[];if((a===null||a===void 0?void 0:a.length)>0){return true}return false},showTypeahead:function(t,e){if(!e.getControl().isA("sap.ui.mdc.FilterField")&&!e.getControl().isA("sap.ui.mdc.MultiValueField")){var n,i;const o=e===null||e===void 0?void 0:e.getFilterValue();const a=e===null||e===void 0?void 0:(n=e.getControl())===null||n===void 0?void 0:n.getValue();const r=e===null||e===void 0?void 0:(i=e.getControl())===null||i===void 0?void 0:i.getAdditionalValue();if(a||r){return e.getControl().hasPendingUserInput()&&(o!==""||this.checkIfAdditionalValuesExists(e,t.getPayload()))}else{if(o){return true}return this.checkIfAdditionalValuesExists(e,t.getPayload())}}return true},getFirstMatch:function(t,e,n){if(e.isA("sap.ui.mdc.valuehelp.content.MTable")){const t=e.getListBinding();return t.getAllCurrentContexts()[0]}return s.getFirstMatch(t,e,n)}})},false);
//# sourceMappingURL=ValueHelpDelegate.js.map