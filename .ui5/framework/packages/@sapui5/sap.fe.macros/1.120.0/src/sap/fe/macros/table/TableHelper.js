/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/converters/MetaModelConverter","sap/fe/core/converters/controls/Common/DataVisualization","sap/fe/core/formatters/TableFormatter","sap/fe/core/helpers/BindingToolkit","sap/fe/core/helpers/SizeHelper","sap/fe/core/helpers/StableIdHelper","sap/fe/core/helpers/TypeGuards","sap/fe/core/library","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/PropertyHelper","sap/fe/core/templating/UIFormatters","sap/fe/macros/CommonHelper","sap/fe/macros/field/FieldTemplating","sap/fe/macros/internal/helpers/ActionHelper","sap/fe/macros/table/TableSizeHelper","sap/ui/mdc/enums/FieldEditMode"],function(e,t,n,i,a,o,r,l,s,c,d,u,v,f,g,p,b){"use strict";var h=f.formatValueRecursively;var m=u.getEditMode;var $=d.isImageURL;var I=d.hasText;var A=c.getTargetObjectPath;var y=c.getContextRelativeTargetObjectPath;var F=l.isPathAnnotationExpression;var C=r.generate;var S=a.ref;var O=a.pathInModel;var T=a.isPathInModelExpression;var x=a.isConstant;var P=a.ifElse;var D=a.getExpressionFromAnnotation;var E=a.formatResult;var N=a.fn;var U=a.constant;var w=a.compileExpression;var j=n.getUiControl;var M=t.getInvolvedDataModelObjects;const B=s.CreationMode;const R={_isStaticAction:function(e,t){let n;if(e){if(Array.isArray(e)){const i=this._getActionOverloadEntityType(t.toString());if(i){n=e.find(function(e){return e.$IsBound&&e.$Parameter[0].$Type===i})}else{n=e[0]}}else{n=e}}return!!n&&typeof n!=="string"&&n.$IsBound&&!!n.$Parameter[0].$isCollection},_getActionOverloadEntityType:function(e){if(e&&e.indexOf("(")>-1){const t=e.split("(");return t[t.length-1].replaceAll(")","")}return undefined},_isActionOverloadOnDifferentType:function(e,t){const n=this._getActionOverloadEntityType(e);return!!n&&t!==n},getFieldsRequestedByPresentationVariant:function(e){var t;return((t=e.RequestAtLeast)===null||t===void 0?void 0:t.map(e=>e.value))||[]},getNavigationAvailableFieldsFromLineItem:function(e){const t=[];(e.getObject()||[]).forEach(function(e){var n;if(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"&&!e.Inline&&!e.Determining&&(n=e.NavigationAvailable)!==null&&n!==void 0&&n.$Path){t.push(e.NavigationAvailable.$Path)}});return t},getNavigationAvailableMap:function(e){const t={};e===null||e===void 0?void 0:e.forEach(e=>{if("SemanticObject"in e){const n=`${e.SemanticObject}-${e.Action}`;if(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"&&!e.Inline&&e.RequiresContext){if(e.NavigationAvailable!==undefined){t[n]=F(e.NavigationAvailable)?e.NavigationAvailable.path:e.NavigationAvailable}}}});return JSON.stringify(t)},getUiLineItem:function(e){return j(e,`@${"com.sap.vocabularies.UI.v1.LineItem"}`)},getUiLineItemObject:function(e,t){var n;const i=t.resolvePath(e.getPath()).target;if(!i)return undefined;const a=t.resolvePath(e.getPath()).target.Visualizations;const o=a?a===null||a===void 0?void 0:(n=a.find(e=>e.value.indexOf("@"+"com.sap.vocabularies.UI.v1.LineItem")===0))===null||n===void 0?void 0:n.$target:i;return(o===null||o===void 0?void 0:o.term)==="com.sap.vocabularies.UI.v1.LineItem"?o:undefined},createBindingToLoadProperties:function(e){const t=e.map(e=>O(e));return w(E(t,"sap.fe.core.formatters.StandardFormatter#loadProperties"))},create$Select:function(e){const t=[];const n=R.getUiLineItem(e.metaPath);function i(e){if(e&&!t.includes(e)&&e.indexOf("/")!==0){t.push(e)}}function a(e){if(e!==null&&e!==void 0&&e.length){e.forEach(i)}}if(n.getPath().includes(`@${"com.sap.vocabularies.UI.v1.LineItem"}`)){var o,r,l,s,c,d,u,v,f,g,p;const t=M(e.metaPath).targetObject;const b=(e.tableDefinition.operationAvailableProperties||"").split(",");const h=R._filterNonApplicableProperties(b,e.collection);const m=e.collectionEntity.entityType||e.collectionEntity.targetType;const $=(((o=m.annotations.Common)===null||o===void 0?void 0:o.SemanticKey)||[]).map(e=>e.value);if((t===null||t===void 0?void 0:t.$Type)==="com.sap.vocabularies.UI.v1.PresentationVariantType"){a(R.getFieldsRequestedByPresentationVariant(t))}a(R.getNavigationAvailableFieldsFromLineItem(n));a(h);a($);i((r=e.contextObjectPath.targetEntitySet)===null||r===void 0?void 0:(l=r.annotations)===null||l===void 0?void 0:(s=l.Capabilities)===null||s===void 0?void 0:(c=s.DeleteRestrictions)===null||c===void 0?void 0:(d=c.Deletable)===null||d===void 0?void 0:d.path);i((u=e.contextObjectPath.targetEntitySet)===null||u===void 0?void 0:(v=u.annotations)===null||v===void 0?void 0:(f=v.Capabilities)===null||f===void 0?void 0:(g=f.UpdateRestrictions)===null||g===void 0?void 0:(p=g.Updatable)===null||p===void 0?void 0:p.path)}return t.join(",")},getColumnWidth:function(e,t,n,a,o,r,l){if(t.width){return t.width}if(e.enableAutoColumnWidth===true){let s;s=this.getColumnWidthForImage(o)||this.getColumnWidthForDataField(e,t,n,a,o,l)||undefined;if(s){return r?`${s}rem`:s}s=w(E([O("/editMode","ui"),O("tablePropertiesAvailable","internal"),t.name,r,this._shouldIncludeHeaderInColumnwidhCalculation(e,t)],i.getColumnWidth));return s}return undefined},getColumnWidthForImage:function(e){var t,n,i,a,o,r,l,s,c,d,u,v;let f=null;const g=(t=e.targetObject)===null||t===void 0?void 0:(n=t.Value)===null||n===void 0?void 0:(i=n.$target)===null||i===void 0?void 0:i.annotations;const p=(a=e.targetObject)===null||a===void 0?void 0:(o=a.Value)===null||o===void 0?void 0:(r=o.$target)===null||r===void 0?void 0:r.type;if((l=e.targetObject)!==null&&l!==void 0&&l.Value&&m((s=e.targetObject.Value)===null||s===void 0?void 0:s.$target,e,false,false,e.targetObject)===b.Display){var h,A;const t=I(e.targetObject.Value.$target);if(p==="Edm.Stream"&&!t&&g!==null&&g!==void 0&&(h=g.Core)!==null&&h!==void 0&&(A=h.MediaType)!==null&&A!==void 0&&A.includes("image/")){f=6.2}}else if(g&&($((c=e.targetObject)===null||c===void 0?void 0:(d=c.Value)===null||d===void 0?void 0:d.$target)||g!==null&&g!==void 0&&(u=g.Core)!==null&&u!==void 0&&(v=u.MediaType)!==null&&v!==void 0&&v.includes("image/"))){f=6.2}return f},_shouldIncludeHeaderInColumnwidhCalculation(e,t){return t.widthIncludingColumnHeader!==undefined?t.widthIncludingColumnHeader:e.widthIncludingColumnHeader},getColumnWidthForDataField:function(e,t,n,i,a,r){var l,s;const c=(l=a.targetObject)===null||l===void 0?void 0:l.annotations;const d=(s=a.targetObject)===null||s===void 0?void 0:s.$Type;let u=null;if(d==="com.sap.vocabularies.UI.v1.DataFieldForAction"||d==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||d==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation"&&n.Target.$AnnotationPath.indexOf(`@${"com.sap.vocabularies.UI.v1.FieldGroup"}`)===-1){var v;let l;l=o.getButtonWidth(i)||o.getButtonWidth(n===null||n===void 0?void 0:(v=n.Label)===null||v===void 0?void 0:v.toString())||o.getButtonWidth(c===null||c===void 0?void 0:c.Label);const s=p.getWidthForDataFieldForAnnotation(a.targetObject,this._shouldIncludeHeaderInColumnwidhCalculation(e,t)).propertyWidth;if(s>l){u=s}else if(i||c&&(c.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"||c.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAction")){l+=1.8;u=l}u=u??this.getColumnWidthForChart(e,t,n,l,r)}return u},getColumnWidthForChart(e,t,n,i,a){var r,l;let s,c=null;if(((r=n.Target)===null||r===void 0?void 0:(l=r.$AnnotationPath)===null||l===void 0?void 0:l.indexOf(`@${"com.sap.vocabularies.UI.v1.Chart"}`))!==-1){switch(this.getChartSize(e,t)){case"XS":s=4.4;break;case"S":s=4.6;break;case"M":s=5.5;break;case"L":s=6.9;break;default:s=5.3}i+=1.8;if(!this.getShowOnlyChart(e,t)&&(a!==null&&a!==void 0&&a.title.length||a!==null&&a!==void 0&&a.description.length)){const e=a.title.length>a.description.length?a.title:a.description;const t=o.getButtonWidth(e)+7;const n=t>i?t:i;c=n}else if(i>s){c=i}else{c=s}}return c},getMarginClass:function(e,t,n,i){let a,o="";if(JSON.stringify(e[e.length-1])==JSON.stringify(t)){if(n=="com.sap.vocabularies.UI.v1.VisualizationType/Rating"){o="sapUiNoMarginBottom sapUiNoMarginTop"}}else if(n==="com.sap.vocabularies.UI.v1.VisualizationType/Rating"){o="sapUiNoMarginTop"}else{o="sapUiTinyMarginBottom"}if(i&&i!=="true"&&i!=="false"){const e=i.substring(i.indexOf("{=")+2,i.lastIndexOf("}"));a="{= "+e+" ? '"+o+"' : "+"''"+" }";return a}else{return o}},getVBoxVisibility:function(e,t,n){let a=true;const o=[];if(n[`@${"com.sap.vocabularies.UI.v1.Hidden"}`]){return t}for(const n of e){const e=n[`@${"com.sap.vocabularies.UI.v1.Hidden"}`];if(e===undefined||e===false){o.push(false);continue}if(e===true){o.push(true);continue}if(e.$Path){o.push(O(e.$Path));a=false;continue}if(typeof e==="object"){return t}}const r=U(o.length>0&&a!==true);const l=U(o.length>0&&!o.includes(false)&&a);return w(P(r,E(o,i.getVBoxVisibility),P(l,U(false),U(true))))},formatHiddenFilters:function(e){if(e){try{return JSON.stringify(e)}catch(e){return undefined}}return undefined},getElementStableId:function(e,t,n){var i;if(!e){return undefined}const a=n.targetObject;let o;switch(a.$Type){case"com.sap.vocabularies.UI.v1.DataFieldForAnnotation":o=a.Target.value;break;case"com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation":case"com.sap.vocabularies.UI.v1.DataFieldForAction":case"com.sap.vocabularies.UI.v1.DataFieldWithUrl":o=a;break;default:o=((i=a.Value)===null||i===void 0?void 0:i.path)??"";break}return C([e,t,o])},getColumnStableId:function(e,t){return R.getElementStableId(e,"C",t)},getFieldGroupLabelStableId:function(e,t){return R.getElementStableId(e,"FGLabel",t)},_filterNonApplicableProperties:function(e,t){return e&&e.filter(function(e){return t.getObject(`./${e}`)})},getRowsBindingInfo:function(e){const t=M(e.collection,e.contextPath);const n=y(t)||A(t);const i={ui5object:true,suspended:false,path:v.addSingleQuotes(n),parameters:{$count:true},events:{}};if(e.tableDefinition.enable$select){const t=R.create$Select(e);if(t){i.parameters.$select=`'${t}'`}}if(e.tableDefinition.enable$$getKeepAliveContext){i.parameters.$$getKeepAliveContext=true}i.parameters.$$groupId=v.addSingleQuotes("$auto.Workers");i.parameters.$$updateGroupId=v.addSingleQuotes("$auto");i.parameters.$$ownRequest=true;i.parameters.$$patchWithoutSideEffects=true;i.events.patchSent=v.addSingleQuotes(".editFlow.handlePatchSent");i.events.patchCompleted=v.addSingleQuotes("API.onInternalPatchCompleted");i.events.dataReceived=v.addSingleQuotes("API.onInternalDataReceived");i.events.dataRequested=v.addSingleQuotes("API.onInternalDataRequested");i.events.change=v.addSingleQuotes("API.onContextChange");i.events.createActivate=v.addSingleQuotes("API.handleCreateActivate");return v.objectToString(i)},validateCreationRowFields:function(e){if(!e){return false}return Object.keys(e).length>0&&Object.keys(e).every(function(t){return e[t]["validity"]})},pressEventDataFieldForActionButton:function(e,t,n,i,a){let o=arguments.length>5&&arguments[5]!==undefined?arguments[5]:false;let r=arguments.length>6?arguments[6]:undefined;let l=arguments.length>7?arguments[7]:undefined;if(!t)return undefined;const s=t.Action,c=e.contextObjectPath.targetEntityType.fullyQualifiedName,d=typeof a!=="string"&&(this._isStaticAction(a,s)||this._isActionOverloadOnDifferentType(s.toString(),c)),u={contexts:!d?O("selectedContexts","internal"):null,bStaticAction:d?d:undefined,entitySetName:n,applicableContexts:!d?O(`dynamicActions/${t.Action}/aApplicable/`,"internal"):null,notApplicableContexts:!d?O(`dynamicActions/${t.Action}/aNotApplicable/`,"internal"):null,isNavigable:o,enableAutoScroll:r,defaultValuesExtensionFunction:l};u.invocationGrouping=(t===null||t===void 0?void 0:t.InvocationGrouping)==="UI.OperationGroupingType/ChangeSet"?"ChangeSet":"Isolated";u.controlId=e.id;u.operationAvailableMap=i;u.label=t.Label;return w(N("API.onActionPress",[S("$event"),S("$controller"),t.Action,u]))},isDataFieldForActionEnabled:function(e,t,n,i,a,o){if(!o)return false;const r=this._isStaticAction(i,t);if(this._isActionOverloadOnDifferentType(t.toString(),o.fullyQualifiedName)){const n=e&&JSON.parse(e.operationAvailableMap);if(n!==null&&n!==void 0&&n.hasOwnProperty(t)){return`{= \${internal>dynamicActions/${t}/bEnabled} }`}return true}if(!n||r){return true}let l="";const s=g.getNumberOfContextsExpression(a??"multiselect");const c=`\${internal>dynamicActions/${t}/bEnabled}`;l=`${s} && ${c}`;return`{= ${l}}`},isDataFieldForIBNEnabled:function(t,n,i,a){var o;let r=null;if(F(a)){r=a.path}const l=t===null||t===void 0?void 0:(o=t.tableDefinition)===null||o===void 0?void 0:o.enableAnalytics;if(!i){const i=t.collection.getPath();const o=t.collection.getModel();if(a===false&&!l){e.warning("NavigationAvailable as false is incorrect usage");return false}else if(r&&!l&&F(n===null||n===void 0?void 0:n.NavigationAvailable)&&o.getObject(i+"/$Partner")===n.NavigationAvailable.path.split("/")[0]){return`{= \${${r.substring(r.indexOf("/")+1,r.length)}}}`}return true}let s="",c,d;if(a===true||l){s="%{internal>numberOfSelectedContexts} >= 1"}else if(a===false){e.warning("NavigationAvailable as false is incorrect usage");return false}else{c="%{internal>numberOfSelectedContexts} >= 1";d=`\${internal>ibn/${n.SemanticObject}-${n.Action}/bEnabled}`;s=c+" && "+d}return`{= ${s}}`},pressEventForCreateButton:function(e,t){const n=e.creationMode.name;let i;const a=t?"${$source>}.getParent()":"${$source>}.getParent().getParent().getParent()";let o=a+".getRowBinding() || "+a+".data('rowsBindingInfo').path";switch(n){case B.External:i={creationMode:v.addSingleQuotes(B.External),outbound:v.addSingleQuotes(e.createOutbound)};break;case B.CreationRow:i={creationMode:v.addSingleQuotes(B.CreationRow),creationRow:"${$source>}",createAtEnd:e.creationMode.createAtEnd!==undefined?e.creationMode.createAtEnd:false};o="${$source>}.getParent().getRowBinding()";break;case B.NewPage:case B.Inline:i={creationMode:v.addSingleQuotes(n),createAtEnd:e.creationMode.createAtEnd!==undefined?e.creationMode.createAtEnd:false,tableId:v.addSingleQuotes(e.id),selectedContexts:"${internal>selectedContexts}"};if(e.createNewAction){i.newAction=v.addSingleQuotes(e.createNewAction)}break;case B.InlineCreationRows:return v.generateFunction(".editFlow.createEmptyRowsAndFocus",a);default:return undefined}return v.generateFunction(".editFlow.createDocument",o,v.objectToString(i))},getIBNData:function(e){if(e){const t={semanticObject:v.addSingleQuotes(e.semanticObject),action:v.addSingleQuotes(e.action)};return v.objectToString(t)}},_getExpressionForDeleteButton:function(e,t){if(typeof e==="string"){return v.addSingleQuotes(e,true)}else{const n=D(e);if(x(n)||T(n)){const e=h(n,t);return w(e)}}},pressEventForDeleteButton:function(e,t,n,i){const a="${internal>deletableContexts}";let o,r;if(n!==null&&n!==void 0&&n.Title){o=this._getExpressionForDeleteButton(n.Title.Value,i)}if(n!==null&&n!==void 0&&n.Description){r=this._getExpressionForDeleteButton(n.Description.Value,i)}const l={id:v.addSingleQuotes(e.id),entitySetName:v.addSingleQuotes(t),numberOfSelectedContexts:"${internal>selectedContexts}.length",unSavedContexts:"${internal>unSavedContexts}",lockedContexts:"${internal>lockedContexts}",draftsWithDeletableActive:"${internal>draftsWithDeletableActive}",draftsWithNonDeletableActive:"${internal>draftsWithNonDeletableActive}",controlId:"${internal>controlId}",title:o,description:r,selectedContexts:"${internal>selectedContexts}"};return v.generateFunction(".editFlow.deleteMultipleDocuments",a,v.objectToString(l))},setHeaderLabelVisibility:function(e,t){if(!t){if(e.$Type.indexOf("DataFieldForAction")>-1&&e.Inline){return false}if(e.$Type.indexOf("DataFieldForIntentBasedNavigation")>-1&&e.Inline){return false}return true}return t.some(function(e){if((e.$Type==="com.sap.vocabularies.UI.v1.DataField"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation")&&e[`@${"com.sap.vocabularies.UI.v1.Hidden"}`]!==true){return true}})},getTextOnActionField:function(e,t){if(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAction"||e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){return e.Label}if(e.$Type==="com.sap.vocabularies.UI.v1.DataFieldForAnnotation"&&t.context.getObject("Target/$AnnotationPath").indexOf("@"+"com.sap.vocabularies.UI.v1.FieldGroup")>-1){const e="Target/$AnnotationPath/Data/";const n=[];for(const i in t.context.getObject(e)){if(t.context.getObject(`${e+i}/$Type`)==="com.sap.vocabularies.UI.v1.DataFieldForAction"||t.context.getObject(`${e+i}/$Type`)==="com.sap.vocabularies.UI.v1.DataFieldForIntentBasedNavigation"){n.push(t.context.getObject(`${e+i}/Label`))}}if(n.length>1){return n.reduce(function(e,t){return e.length>t.length?e:t})}else{return n.length===0?undefined:n.toString()}}return undefined},_getResponsiveTableColumnSettings:function(e,t){if(e.tableType==="ResponsiveTable"){return t.settings}return null},getChartSize:function(e,t){const n=this._getResponsiveTableColumnSettings(e,t);if(n&&n.microChartSize){return n.microChartSize}return"XS"},getShowOnlyChart:function(e,t){const n=this._getResponsiveTableColumnSettings(e,t);if(n&&n.showMicroChartLabel){return!n.showMicroChartLabel}return true},getDelegate:function(e,t,n){let i;if(t==="true"){if(e.control.type==="TreeTable"){throw new Error("TreeTable not supported in Analytical ListPage")}i={name:"sap/fe/macros/table/delegates/ALPTableDelegate",payload:{collectionName:n}}}else if(e.control.type==="TreeTable"){i={name:"sap/fe/macros/table/delegates/TreeTableDelegate",payload:{hierarchyQualifier:e.control.hierarchyQualifier,initialExpansionLevel:e.annotation.initialExpansionLevel}}}else{i={name:"sap/fe/macros/table/delegates/TableDelegate"}}return JSON.stringify(i)},setIBNEnablement:function(e,t,n){for(const i in t){e.setProperty(`ibn/${i}`,{bEnabled:false,aApplicable:[],aNotApplicable:[]});const a=[],o=[];const r=t[i];for(let t=0;t<n.length;t++){const l=n[t];if(l.getObject(r)){e.getModel().setProperty(`${e.getPath()}/ibn/${i}/bEnabled`,true);a.push(l)}else{o.push(l)}}e.getModel().setProperty(`${e.getPath()}/ibn/${i}/aApplicable`,a);e.getModel().setProperty(`${e.getPath()}/ibn/${i}/aNotApplicable`,o)}},enableFastCreationRow:async function(t,n,i,a,o){let r,l;if(t){try{await o;if(t.getModel("ui").getProperty("/isEditable")&&!i.isDeleted()){r=a.bindList(n,i,[],[],{$$updateGroupId:"doNotSubmit",$$groupId:"doNotSubmit"});r.refreshInternal=function(){};l=r.create();t.setBindingContext(l);try{await l.created()}catch(t){e.trace("transient fast creation context deleted")}}}catch(t){e.error("Error while computing the final UI state",t)}}}};R.getNavigationAvailableMap.requiresIContext=true;R.getTextOnActionField.requiresIContext=true;return R},false);
//# sourceMappingURL=TableHelper.js.map