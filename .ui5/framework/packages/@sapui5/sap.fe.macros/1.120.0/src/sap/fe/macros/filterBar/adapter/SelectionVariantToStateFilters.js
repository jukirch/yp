/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/fe/core/CommonUtils","sap/fe/core/helpers/BindingToolkit","sap/fe/core/templating/DisplayModeFormatter","sap/fe/core/templating/FilterHelper","sap/fe/macros/filter/FilterFieldHelper","sap/ui/mdc/enums/ConditionValidated","sap/ui/mdc/util/FilterUtil"],function(t,e,n,o,r,i,a){"use strict";var s=r.maxConditions;var l=o.getConditions;var p=n.ODATA_TYPE_MAPPING;var c=e.EDM_TYPE_MAPPING;const d=["$search","$editState"];const u={getStateFiltersFromSV:function(t,e,n){const{contextPath:o}=e;const r={};n.forEach(function(n){if(!d.includes(n.name)){let i=[];const{conditionPath:a,annotationPath:s}=n;const l=a.replaceAll("*","");const p=l.substring(0,l.lastIndexOf("/"));const c=l.substring(l.lastIndexOf("/")+1);const d={propertyName:c,navPath:p,propertyContextPath:`${o}${p?p+"/":""}`,propertyMetadata:n,selectionVariant:t,filterBarInfo:e};if(n.isParameter&&s){d.propertyContextPath=s.substring(0,s.lastIndexOf("/")+1);i=u._getConditionsForParameter(d)}else if(a.includes("/")){i=u._getConditionsForNavProperty(d)}else{i=u._getConditionsForProperty(d)}if(i.length>0){r[a]=i}}});return r},getStateToApply:(t,e)=>{const n=Object.keys(e).reduce((e,n)=>{const o=a.getPropertyByKey(t,n);if(o.hiddenFilter===undefined||!o.hiddenFilter){e.push({name:n})}return e},[]);return{filter:e,items:n}},_getPropertyFilterConfigurationSetting:function(t,e){var n;return(e===null||e===void 0?void 0:(n=e[t])===null||n===void 0?void 0:n.settings)??{}},_getConditionsForParameter:function(t){let e=[];const{propertyMetadata:n,selectionVariant:o}=t;const r=n.name;const i=u._getSelectOptionName(o,r,true);if(i){e=u._getPropertyConditions(t,i,true)}return e},_getConditionsForProperty:function(t){const{propertyMetadata:e,selectionVariant:n}=t;const o=e.name;const r=u._getSelectOptionName(n,o);let i=[];if(r){i=u._getPropertyConditions(t,r,false)}return i},_getConditionsForNavProperty:function(t){const{filterBarInfo:e,selectionVariant:n,propertyName:o,navPath:r}=t;const{contextPath:i}=e;let a=[];let s=`${i.substring(1)}${r}`.replaceAll("/",".");let l=u._getSelectOptionName(n,o,false,s);if(!l){s=r.replaceAll("/",".");l=u._getSelectOptionName(n,o,false,s)}if(l){a=u._getPropertyConditions(t,l,false)}return a},_getSelectOptionName:function(t,e,n,o){const r=[];const i=t.getSelectOptionsPropertyNames();if(n){r.push(`$Parameter.${e}`);r.push(e);if(e.startsWith("P_")){r.push(`$Parameter.${e.slice(2,e.length)}`);r.push(e.slice(2,e.length))}else{r.push(`$Parameter.P_${e}`);r.push(`P_${e}`)}}else{r.push(e);r.push(`$Parameter.${e}`);if(e.startsWith("P_")){const t=e.slice(2,e.length);r.push(`$Parameter.${t}`);r.push(t)}else{const t=`P_${e}`;r.push(`$Parameter.${t}`);r.push(t)}}let a="";r.some(t=>{const e=o?`${o}.${t}`:t;return i.includes(e)?a=e:false});return a},_getMaxConditions(t){const{filterBarInfo:e,propertyContextPath:n,propertyName:o}=t;const{metaModel:r}=e;const i=`${n}${o}`;const a=r.createBindingContext(i);let l=0;if(a){l=s(o,{context:a})}return l},_getPropertyConditions:function(e,n,o){const{filterBarInfo:r,propertyMetadata:i,selectionVariant:a,propertyContextPath:s,propertyName:l}=e;const p=a.getSelectOption(n);const{metaModel:c}=r;const d=u._getMaxConditions(e);let f=[];if(p!==null&&p!==void 0&&p.length&&d!==0){const n=u._getSemanticDateOperators(e,o);const r=s.substring(0,s.length-1);const a=o?["EQ"]:t.getOperatorsForProperty(l,r,c);f=this._getConditionsFromSelectOptions(p,i,a,n,d===1)}return f},_getSemanticDateOperators:function(e,n){const{filterBarInfo:o,propertyMetadata:r,propertyName:i,propertyContextPath:a}=e;const s=r.name;let l=[];const{useSemanticDateRange:c,filterFieldsConfig:d,metaModel:f}=o;if(c){if(n){l=["EQ"]}else{const e=a.substring(0,a.length-1),n=u._getPropertyFilterConfigurationSetting(s,d);l=t.getOperatorsForProperty(i,e,f,p[r.dataType],c,n)}}return l},_getConditionsFromSelectOptions:function(t,e,n,o,r){let i=[];if(t.length){i=r?u._addConditionFromSelectOption(e,n,o,i,t[0]):t.reduce(u._addConditionFromSelectOption.bind(null,e,n,o),i)}return i},_addConditionFromSelectOption:function(t,e,n,o,r){const{hasValueHelp:i,dataType:a}=t;const s=u._getEdmType(a);const p=l(r,s,!!i);if(r.SemanticDates&&n.length&&n.includes(r.SemanticDates.operator)){const t=u._addSemanticDatesToConditions(r.SemanticDates);if(Object.keys(t).length>0){o.push(t)}}else if(p){if(e.length===0||e.includes(p.operator)){if(i){u._adjustValueHelpCondition(p)}o.push(p)}}return o},_addSemanticDatesToConditions:t=>{const e=[];if(t.high){e.push(t.high)}if(t.low){e.push(t.low)}return{values:e,operator:t.operator,isEmpty:undefined}},_getEdmType:t=>{const e=Object.fromEntries(Object.entries(c).map(t=>{let[e,n]=t;return[n.type,e]}));return e[t]},_adjustValueHelpCondition:t=>{t.validated=i.Validated;if(t.operator==="Empty"){t.operator="EQ";t.values=[""]}else if(t.operator==="NotEmpty"){t.operator="NE";t.values=[""]}delete t.isEmpty}};return u},false);
//# sourceMappingURL=SelectionVariantToStateFilters.js.map