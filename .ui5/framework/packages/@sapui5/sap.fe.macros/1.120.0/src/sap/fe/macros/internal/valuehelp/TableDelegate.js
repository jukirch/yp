/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/base/util/deepEqual","sap/fe/core/CommonUtils","sap/fe/core/converters/controls/ListReport/FilterBar","sap/fe/core/converters/MetaModelConverter","sap/fe/core/helpers/MetaModelFunction","sap/fe/core/helpers/ModelHelper","sap/fe/core/templating/DataModelPathHelper","sap/fe/core/templating/DisplayModeFormatter","sap/fe/core/templating/PropertyHelper","sap/fe/core/type/EDM","sap/fe/macros/DelegateUtil","sap/fe/macros/internal/valuehelp/TableDelegateHelper","sap/ui/core/Core","sap/ui/mdc/odata/v4/TableDelegate","sap/ui/mdc/odata/v4/TypeMap","sap/ui/mdc/odata/v4/util/DelegateUtil","sap/ui/mdc/util/FilterUtil","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter"],function(e,t,n,o,a,r,i,s,l,p,c,f,d,g,u,y,h,v,m,b,P){"use strict";var C=d.isSortableProperty;var M=d.isFilterableProperty;var I=d.getPath;var T=c.isTypeFilterable;var D=p.getLabel;var O=p.getAssociatedUnitPropertyPath;var $=p.getAssociatedTimezonePropertyPath;var x=p.getAssociatedTextPropertyPath;var F=p.getAssociatedCurrencyPropertyPath;var B=l.getDisplayMode;var j=s.getTargetObjectPath;var E=s.enhanceDataModelPath;var w=r.isMultiValueFilterExpression;var S=r.getSortRestrictionsInfo;var A=r.getFilterRestrictionsInfo;var R=a.getInvolvedDataModelObjects;var U=o.fetchTypeConfig;const _=Object.assign({},u);_.fetchProperties=async function(e){const t=await this._getModel(e);const n=await this._createPropertyInfos(e,t);_.createInternalBindingContext(e);f.setCachedProperties(e,n);e.getBindingContext("internal").setProperty("tablePropertiesAvailable",true);return n};_.createInternalBindingContext=function(e){let t=e;while(t&&!t.isA("sap.ui.mdc.valuehelp.Dialog")){t=t.getParent()}const n=e.getModel("internal");if(t&&n){const o=t.getBindingContext("internal");let a;if(o){a=o.getPath()+`::VHDialog::${t.getId()}::table`}else{a=`/buildingblocks/${e.getId()}`;n.setProperty("/buildingblocks",{...n.getProperty("/buildingblocks")})}const r=n.bindContext(a).getBoundContext();e.setBindingContext(r,"internal")}};function k(e){const t=V(e);const n={};if(t!==null&&t!==void 0&&t.targetObject){var o,a,r,i,s;const l=t.targetObject;const p=j(t,true);const c=e.targetObject;const f=j(e,true);const d=(o=c.annotations)===null||o===void 0?void 0:(a=o.Common)===null||a===void 0?void 0:a.Text,g=d===null||d===void 0?void 0:(r=d.annotations)===null||r===void 0?void 0:(i=r.UI)===null||i===void 0?void 0:(s=i.TextArrangement)===null||s===void 0?void 0:s.toString(),u=d&&g&&B(c);if(u==="Description"){n[p]=l}else if(u&&u!=="Value"||!d){n[f]=c;n[p]=l}}return n}_._createPropertyInfos=function(e,t){const n=e.getDelegate().payload;const o=[];const a=`/${n.collectionName}`;const r=t.getMetaModel();return r.requestObject(`${a}@`).then(function(t){const n=S(t);const r=t["@Org.OData.Capabilities.V1.FilterRestrictions"];const i=A(r);const s=f.getCustomData(e,"columns");const l={};const p=R(e.getModel().getMetaModel().getContext(a));s.customData.forEach(function(t){const a={name:t.path,label:t.label,sortable:C(n,t),filterable:M(i,t),maxConditions:N(i,t),typeConfig:T(t.$Type)?e.getTypeMap().getTypeConfig(t.$Type):undefined};const r=E(p,t.path);const s=r.targetObject;if(s){const n=j(r,true);let o;if(T(s.type)){const n=U(s);o=y.getTypeConfig(n.type??"",n.formatOptions,n.constraints)??e.getTypeMap().getTypeConfig(t.$Type)}const i=k(r);const p=Object.keys(i);if(p.length){a.propertyInfos=p;a.sortable=false;a.filterable=false;p.forEach(e=>{l[e]=i[e]});if(!p.find(e=>i[e]===s)){l[n]=s}}else{a.path=t.path}a.typeConfig=a.typeConfig?o:undefined}else{a.path=t.path}o.push(a)});const c=H(l,o,n,i);return o.concat(c)})};_.updateBindingInfo=function(e,t){u.updateBindingInfo.apply(this,[e,t]);if(!e){return}const o=e.getDelegate().payload;if(o&&t){t.path=t.path||o.collectionPath||`/${o.collectionName}`;t.model=t.model||o.model}if(!t){t={}}const a=g.byId(e.getFilter()),r=e.isFilteringEnabled();let s;let l,p;const c=[];const d=f.getCachedProperties(e);if(r){s=e.getConditions();l=v.getFilterInfo(e,s,d,[]);if(l.filters){c.push(l.filters)}}if(a){s=a.getConditions();if(s){const n=h.getParameterNames(a);_._updatePropertyInfo(d,e,s,o);p=v.getFilterInfo(a,s,d,n);if(p.filters){c.push(p.filters)}const r=h.getParametersInfo(a,s);if(r){t.path=r}}t.parameters.$search=n.normalizeSearchTerm(a.getSearch())||undefined}t.parameters.$$sharedRequest=false;this._applyDefaultSorting(t,e.getDelegate().payload);t.parameters.$select=d===null||d===void 0?void 0:d.reduce(function(e,t){if(t.path&&t.path.indexOf("/")===-1){e=e?`${e},${t.path}`:t.path}return e},"");t.parameters.$count=true;if(i.isDraftSupported(e.getModel().getMetaModel(),t.path)){c.push(new m("IsActiveEntity",b.EQ,true))}t.filters=new m(c,true)};_.getTypeMap=function(){return y};_._getModel=async function(e){const t=e.getDelegate().payload;let n=e.getModel(t.model);if(!n){await new Promise(t=>{e.attachEventOnce("modelContextChange",t)});n=e.getModel(t.model)}return n};_._applyDefaultSorting=function(e,t){if(e.parameters&&e.parameters.$search==undefined&&e.sorter&&e.sorter.length==0){const n=t?t.defaultSortPropertyName:undefined;if(n){e.sorter.push(new P(n,false))}}};_._updatePropertyInfo=function(e,t,n,o){const a=Object.keys(n),r=t.getModel().getMetaModel();a.forEach(function(n){if(e.findIndex(function(e){return e.path===n})===-1){const a={path:n,typeConfig:t.getTypeMap().getTypeConfig(r.getObject(`/${o.collectionName}/${n}`).$Type)};e.push(a)}})};_.updateBinding=function(n,o,a){let r=false;const i=n.getBindingContext("internal");const s="pendingManualBindingUpdate";const l=i===null||i===void 0?void 0:i.getProperty(s);let p=n.getRowBinding();u.updateBinding.apply(_,[n,o,a]);if(!p){p=n.getRowBinding()}if(p){const e=p.getFilters("Application");r=t(o.filters,e[0])&&p.getQueryOptionsFromParameters().$search===o.parameters.$search&&!l}if(r&&n.getFilter()){i===null||i===void 0?void 0:i.setProperty(s,true);p.requestRefresh(p.getGroupId()).finally(function(){i===null||i===void 0?void 0:i.setProperty(s,false)}).catch(function(t){e.error("Error while refreshing a filterBar VH table",t)})}n.fireEvent("bindingUpdated")};function H(e,t,n,o){const a={},r=[];Object.keys(e).forEach(i=>{const s=e[i],l=t.find(e=>e.path===i);if(!l){const e=`Property::${i}`;a[i]=e;const t={name:e,label:D(s),path:i,sortable:C(n,s),filterable:M(o,s)};t.maxConditions=N(o,t);if(T(s.type)){const e=U(s);t.typeConfig=y.getTypeConfig(e.type??"",e.formatOptions,e.constraints)}r.push(t)}});t.forEach(e=>{if(e.propertyInfos){var t;e.propertyInfos=(t=e.propertyInfos)===null||t===void 0?void 0:t.map(e=>a[e]??e)}});return r}function N(e,t){var n;const o=I(t);return(n=e.propertyInfo)!==null&&n!==void 0&&n.hasOwnProperty(o)&&o&&w(e.propertyInfo[o])?-1:1}function V(e){const t=e.targetObject;const n=x(t)||F(t)||O(t)||$(t);if(!n){return undefined}const o=E(e,n);const a=o.targetObject;if(!a){return undefined}return o}return _},false);
//# sourceMappingURL=TableDelegate.js.map