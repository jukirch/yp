/*!
 * SAP UI development toolkit for HTML5 (SAPUI5)
 *      (c) Copyright 2009-2023 SAP SE. All rights reserved
 */
sap.ui.define(["sap/base/Log","sap/fe/core/CommonUtils","sap/fe/core/controllerextensions/collaboration/ActivitySync","sap/fe/core/controllerextensions/collaboration/CollaborationCommon","sap/fe/core/controllerextensions/editFlow/draft","sap/fe/core/helpers/KeepAliveHelper","sap/fe/core/helpers/ModelHelper","sap/fe/core/helpers/ResourceModelHelper","sap/fe/macros/CommonHelper","sap/fe/macros/controls/FieldWrapper","sap/fe/macros/field/FieldAPI","sap/m/IllustratedMessage","sap/m/IllustratedMessageType","sap/m/Label","sap/m/library","sap/m/MessageBox","sap/m/ResponsivePopover","sap/ui/core/Core","sap/ui/core/IconPool","sap/ui/Device","sap/ui/model/Filter","sap/ui/unified/FileUploaderParameter","sap/ui/util/openWindow"],function(e,t,n,o,i,a,r,s,l,c,d,g,u,f,p,m,h,v,C,S,P,E,_){"use strict";var T=s.getResourceModel;var F=o.getActivityKeyFromPath;var y=o.Activity;function A(e){let n=e.getBindingContext().getBinding();if(!n.isA("sap.ui.model.odata.v4.ODataListBinding")){const o=t.getTargetView(e);n=o.getBindingContext().getBinding()}return n}const O={uploadPromises:undefined,creatingInactiveRow:false,onDataFieldWithNavigationPath:function(n,o,a){if(o._routing){let e=n.getBindingContext();const s=t.getTargetView(n),l=e.getModel().getMetaModel(),c=function(t){if(t){e=t}o._routing.navigateToTarget(e,a,true)};if(s.getViewData().converterType==="ObjectPage"&&!r.isStickySessionSupported(l)){i.processDataLossOrDraftDiscardConfirmation(c,Function.prototype,e,s.getController(),true,i.NavigationType.ForwardNavigation)}else{c()}}else{e.error("FieldRuntime: No routing listener controller extension found. Internal navigation aborted.","sap.fe.macros.field.FieldRuntime","onDataFieldWithNavigationPath")}},isDraftIndicatorVisible:function(e,t,n,o,i){if(o!==undefined&&n!==undefined&&(!o||n)&&!i){return e===t}else{return false}},onValidateFieldGroup:function(e,t){const n=O._getExtensionController(e);n._sideEffects.handleFieldGroupChange(t)},_fetchRecommendations:function(e,n){const o=t.getTargetView(e);const i=e.getBindingContext();let a;const r=i===null||i===void 0?void 0:i.getBinding();if(r.isA("sap.ui.model.odata.v4.ODataListBinding")){a=i}else{a=o.getBindingContext()}const s=O._getExtensionController(n);s.recommendations.fetchAndApplyRecommendationsOnFieldChange(e,[a])},handleChange:function(t,o){const i=o.getSource(),a=i&&i.getBindingContext().isTransient(),r=o.getParameter("promise")||Promise.resolve(),s=o.getSource(),l=o.getParameter("valid"),c=this.getFieldStateOnChange(o).state["validity"],g=o.getSource();const u=O._getExtensionController(t);r.then(function(){o.oSource=s;o.mParameters={valid:l};d.handleChange(o,t);u._sideEffects.handleFieldChange(o,c,r);O._fetchRecommendations(g,t);return}).catch(function(){o.oSource=s;o.mParameters={valid:false};u._sideEffects.prepareSideEffectsForField(o,c,r);e.debug("Prerequisites on Field for the SideEffects and Recommendations have been rejected");d.handleChange(o,t)});u.editFlow.syncTask(r);if(a){return}const f=n.isConnected(g);if(f&&c){var p,m;const e=A(g);const t=[...((p=g.getBindingInfo("value")||g.getBindingInfo("selected"))===null||p===void 0?void 0:p.parts)||[],...((m=g.getBindingInfo("additionalValue"))===null||m===void 0?void 0:m.parts)||[]].filter(e=>(e===null||e===void 0?void 0:e.path)!==undefined&&e.path.indexOf("@@")<0).map(function(e){var t;return`${(t=g.getBindingContext())===null||t===void 0?void 0:t.getPath()}/${e.path}`});n.retainAsyncMessages(g,t);const o=()=>{if(e.hasPendingChanges()){e.attachEventOnce("patchCompleted",function(){n.send(g,{action:y.Change,content:t});n.releaseAsyncMessages(g,t)})}else{n.releaseAsyncMessages(g,t)}};if(i.isA("sap.ui.mdc.Field")){r.then(()=>{o();return}).catch(()=>{o()})}else{o()}}},handleLiveChange:function(e){d.handleLiveChange(e)},_sendCollaborationMessageForFileUploader(e,t){if(n.isConnected(e)){var o,i;const a=(o=e.getParent())===null||o===void 0?void 0:o.getProperty("propertyPath");const r=`${(i=e.getBindingContext())===null||i===void 0?void 0:i.getPath()}/${a}`;n.send(e,{action:t,content:r})}},handleOpenUploader:function(e){const t=e.getSource();O._sendCollaborationMessageForFileUploader(t,y.Lock)},handleCloseUploader:function(e){const t=e.getSource();O._sendCollaborationMessageForFileUploader(t,y.Unlock)},getFieldStateOnChange:function(e){let t=e.getSource(),n={};const o=function(e){return e&&e.getDataState()?e.getDataState().getInvalidValue()===undefined:true};if(t.isA("sap.fe.macros.field.FieldAPI")){t=t.getContent()}if(t.isA(c.getMetadata().getName())&&t.getEditMode()==="Editable"){t=t.getContentEdit()[0]}if(t.isA("sap.ui.mdc.Field")){let i=e.getParameter("valid")||e.getParameter("isValid");if(i===undefined){if(t.getMaxConditions()===1){const e=t.getBindingInfo("value");i=o(e&&e.binding)}if(t.getValue()===""&&!t.getProperty("required")){i=true}}n={fieldValue:t.getValue(),validity:!!i}}else{const e=t.getBinding("uploadUrl")||t.getBinding("value")||t.getBinding("selected");n={fieldValue:e&&e.getValue(),validity:o(e)}}return{field:t,state:n}},_fnFixHashQueryString:function(e){if(e&&e.indexOf("?")!==-1){e=e.split("?")[0]}return e},_fnGetLinkInformation:function(e,n,o,i,a){const r=n&&n.getModel();const s=r&&r.getMetaModel();const l=i||e&&e.getValue();const c=n&&t.getTargetView(n);const d=c&&c.getBindingContext("internal");const g=c&&t.getAppComponent(c);const u=g&&g.getShellServices();const f=u&&u.getLinksWithCache([[{semanticObject:l}]]);const p=s&&s.getObject(`${o}@com.sap.vocabularies.Common.v1.SemanticObjectUnavailableActions`);return{SemanticObjectName:l,SemanticObjectFullPath:o,MetaModel:s,InternalModelContext:d,ShellServiceHelper:u,GetLinksPromise:f,SemanticObjectUnavailableActions:p,fnSetActive:a}},_fnQuickViewHasNewCondition:function(e,t){if(e&&e.path&&e.path===t.SemanticObjectFullPath){const n=e[!t.SemanticObjectUnavailableActions?"HasTargetsNotFiltered":"HasTargets"];t.fnSetActive(!!n);return true}else{return false}},_fnQuickViewSetNewConditionForConditionalWrapper:function(e,t){if(t[e.SemanticObjectName]){let n,o;const i=Object.keys(t[e.SemanticObjectName]);for(const a in i){n=i[a];o=t[e.SemanticObjectName]&&t[e.SemanticObjectName][n];if(O._fnQuickViewHasNewCondition(o,e)){break}}}},_fnUpdateSemanticObjectsTargetModel:function(n,o,i,a){const r=n&&n.getSource();let s;if(i.isA("sap.m.ObjectStatus")){s=e=>i.setActive(e)}if(i.isA("sap.m.ObjectIdentifier")){s=e=>i.setTitleActive(e)}const l=i&&i.getParent();if(l&&l.isA("sap.fe.macros.controls.ConditionalWrapper")){s=e=>l.setCondition(e)}if(s!==undefined){const n=O._fnGetLinkInformation(r,i,a,o,s);n.fnSetActive=s;const l=O._fnFixHashQueryString(t.getAppComponent(i).getShellServices().getHash());t.updateSemanticTargets([n.GetLinksPromise],[{semanticObject:n.SemanticObjectName,path:n.SemanticObjectFullPath}],n.InternalModelContext,l).then(function(e){if(e){O._fnQuickViewSetNewConditionForConditionalWrapper(n,e)}return}).catch(function(t){e.error("Cannot update Semantic Targets model",t)})}},_checkControlHasModelAndBindingContext(e){if(!e.getModel()||!e.getBindingContext()){return false}else{return true}},_checkCustomDataValueBeforeUpdatingSemanticObjectModel(e,t,n){let o;let i;const a=function(e){return!(e!==null&&typeof e==="object")};n=n.filter(e=>e.getKey()!=="sap-ui-custom-settings");for(const r in n){o=n[r].getValue();if(!o&&a(o)){i=n[r].getBinding("value");if(i){i.attachEventOnce("change",function(n){O._fnUpdateSemanticObjectsTargetModel(n,null,e,t)})}}else if(a(o)){O._fnUpdateSemanticObjectsTargetModel(null,o,e,t)}}},LinkModelContextChange:function(e,t,n){const o=e.getSource();if(O._checkControlHasModelAndBindingContext(o)){const e=`${n}/${t}`;const i=o.getDependents().length?o.getDependents()[0]:undefined;const a=i===null||i===void 0?void 0:i.getCustomData();if(a&&a.length>0){O._checkCustomDataValueBeforeUpdatingSemanticObjectModel(o,e,a)}}},openExternalLink:function(e){const t=e.getSource();if(t.data("url")&&t.getProperty("text")!==""){_(t.data("url"),"_self")}},createPopoverWithNoTargets:function(e){const t=e.getId();const n={title:T(e).getText("M_ILLUSTRATEDMESSAGE_TITLE"),description:T(e).getText("M_ILLUSTRATEDMESSAGE_DESCRIPTION"),enableFormattedText:true,illustrationSize:"Dot",illustrationType:u.Tent};const o=new g(`${t}-illustratedmessage`,n);const i={horizontalScrolling:false,showHeader:S.system.phone,placement:p.PlacementType.Auto,content:[o],afterClose:function(e){if(e.getSource()){e.getSource().destroy()}}};return new h(`${t}-popover`,i)},openLink:async function(n,o){try{const i=await n.getTriggerHref();if(!i){try{const e=await n.retrieveLinkItems();if((e===null||e===void 0?void 0:e.length)===0&&n.getPayload().hasQuickViewFacets==="false"){const e=O.createPopoverWithNoTargets(n);n.addDependent(e);e.openBy(o)}else{await n.open(o)}}catch(t){e.error(`Cannot retrieve the QuickView Popover dialog: ${t}`)}}else{const n=t.getTargetView(o);const r=t.getAppComponent(n);const s=r.getShellServices();const l=s.parseShellHash(i);const c={target:{semanticObject:l.semanticObject,action:l.action},params:l.params};a.storeControlRefreshStrategyForHash(n,l);if(t.isStickyEditMode(o)!==true){s.toExternal(c,r)}else{try{const e=await s.hrefForExternalAsync(c,r);_(e)}catch(t){e.error(`Error while retireving hrefForExternal : ${t}`)}}}}catch(t){e.error(`Error triggering link Href: ${t}`)}},pressLink:async function(e){const t=e.getSource();const n=t.isA("sap.m.ObjectIdentifier")?t.findElements(false,e=>e.isA("sap.m.Link"))[0]:t;if(t.getDependents()&&t.getDependents().length>0&&n.getProperty("text")!==""){const e=t.getDependents()[0];if(e&&e.isA("sap.ui.mdc.Link")){await O.openLink(e,n)}}return n},uploadStream:function(e,t){const o=t.getSource(),i=O._getExtensionController(e),a=o.getParent(),r=a.getUploadUrl();if(r!==""){var s,l;a.setUIBusy(true);o.setUploadUrl(r);o.removeAllHeaderParameters();const e=(s=o.getModel())===null||s===void 0?void 0:s.getHttpHeaders()["X-CSRF-Token"];if(e){const t=new E;t.setName("x-csrf-token");t.setValue(e);o.addHeaderParameter(t)}const t=(l=o.getBindingContext())===null||l===void 0?void 0:l.getProperty("@odata.etag");if(t){const e=new E;e.setName("If-Match");e.setValue(n.isConnected(o)?"*":t);o.addHeaderParameter(e)}const c=new E;c.setName("Accept");c.setValue("application/json");o.addHeaderParameter(c);const d=new Promise((e,t)=>{this.uploadPromises=this.uploadPromises||{};this.uploadPromises[o.getId()]={resolve:e,reject:t};o.upload()});i.editFlow.syncTask(d)}else{m.error(T(e).getText("M_FIELD_FILEUPLOADER_ABORTED_TEXT"))}},handleUploadComplete:function(e,o,i,a){const r=Number(e.getParameter("status")),s=e.getSource(),l=s.getParent();l.setUIBusy(false);const c=s.getBindingContext();if(r===0||r>=400){this._displayMessageForFailedUpload(e);this.uploadPromises[s.getId()].reject()}else{var d,g;const t=(d=e.getParameter("headers"))===null||d===void 0?void 0:d.etag;if(t){c===null||c===void 0?void 0:c.setProperty("@odata.etag",t,null)}if(o!==null&&o!==void 0&&o.path){c===null||c===void 0?void 0:c.setProperty(o.path,s.getValue())}(g=l.avatar)===null||g===void 0?void 0:g.refreshAvatarCacheBusting();this._callSideEffectsForStream(e,l,a);this.uploadPromises[s.getId()].resolve()}delete this.uploadPromises[s.getId()];const u=n.isConnected(s);if(!u||!c){return}const f=[`${c.getPath()}/${i}`];if(o!==null&&o!==void 0&&o.path){f.push(`${c.getPath()}/${o.path}`)}let p=c.getBinding();if(!p.isA("sap.ui.model.odata.v4.ODataListBinding")){const e=t.getTargetView(s);p=e.getBindingContext().getBinding()}if(p.hasPendingChanges()){p.attachEventOnce("patchCompleted",()=>{n.send(l,{action:y.Change,content:f});n.send(l,{action:y.Unlock,content:f})})}else{n.send(l,{action:y.Change,content:f});n.send(l,{action:y.Unlock,content:f})}},_displayMessageForFailedUpload:function(e){const t=e.getParameter("responseRaw")||e.getParameter("response");let n,o;try{o=t&&JSON.parse(t);n=o.error&&o.error.message}catch(o){n=t||T(e.getSource()).getText("M_FIELD_FILEUPLOADER_ABORTED_TEXT")}m.error(n)},removeStream:function(e,o,i,a){const r=e.getSource();const s=r.getParent();const l=s.getBindingContext();l.setProperty(i,null);l.setProperty(i,undefined,null);this._callSideEffectsForStream(e,s,a);const c=n.isConnected(r);if(c){let e=l.getBinding();if(!e.isA("sap.ui.model.odata.v4.ODataListBinding")){const n=t.getTargetView(r);e=n.getBindingContext().getBinding()}const a=[`${l.getPath()}/${i}`];if(o!==null&&o!==void 0&&o.path){a.push(`${l.getPath()}/${o.path}`)}n.send(r,{action:y.Lock,content:a});e.attachEventOnce("patchCompleted",function(){n.send(r,{action:y.Change,content:a});n.send(r,{action:y.Unlock,content:a})})}},_callSideEffectsForStream:function(e,t,n){const o=O._getExtensionController(n);if(t&&t.getBindingContext().isTransient()){return}if(t){e.oSource=t}o._sideEffects.handleFieldChange(e,this.getFieldStateOnChange(e).state["validity"])},getIconForMimeType:function(e){return C.getIconForMimeType(e)},retrieveTextFromValueList:function(t,n,o){let i;let a;let r;if(t){a=l.getMetaModel();r=a.getObject(`${n}@sapui.name`);return a.requestValueListInfo(n,true).then(function(e){const n=e[e[""]?"":Object.keys(e)[0]];const a=n.$model;const s=a.getMetaModel();const l=n.Parameters.find(function(e){return e.LocalDataProperty&&e.LocalDataProperty.$PropertyPath===r});if(l&&!l.ValueListProperty){throw new Error(`Inconsistent value help annotation for ${r}`)}const c=s.getObject(`/${n.CollectionPath}/${l.ValueListProperty}@com.sap.vocabularies.Common.v1.Text`);if(c&&c.$Path){i=c.$Path;const e=new P({path:l.ValueListProperty,operator:"EQ",value1:t});const o=a.bindList(`/${n.CollectionPath}`,undefined,undefined,e,{$select:i});return o.requestContexts(0,2)}else{o="Value";return t}}).then(function(e){var n;const a=i?(n=e[0])===null||n===void 0?void 0:n.getObject()[i]:"";switch(o){case"Description":return a;case"DescriptionValue":return v.getLibraryResourceBundle("sap.fe.core").getText("C_FORMAT_FOR_TEXT_ARRANGEMENT",[a,t]);case"ValueDescription":return v.getLibraryResourceBundle("sap.fe.core").getText("C_FORMAT_FOR_TEXT_ARRANGEMENT",[t,a]);default:return t}}).catch(function(t){const o=t.status&&t.status===404?`Metadata not found (${t.status}) for value help of property ${n}`:t.message;e.error(o)})}return t},handleTypeMissmatch:function(e){const t=T(e.getSource());m.error(t.getText("M_FIELD_FILEUPLOADER_WRONG_MIMETYPE"),{details:`<p><strong>${t.getText("M_FIELD_FILEUPLOADER_WRONG_MIMETYPE_DETAILS_SELECTED")}</strong></p>${e.getParameters().mimeType}<br><br>`+`<p><strong>${t.getText("M_FIELD_FILEUPLOADER_WRONG_MIMETYPE_DETAILS_ALLOWED")}</strong></p>${e.getSource().getMimeType().toString().replaceAll(",",", ")}`,contentWidth:"150px"})},handleFileSizeExceed:function(e){m.error(T(e.getSource()).getText("M_FIELD_FILEUPLOADER_FILE_TOO_BIG",e.getSource().getMaximumFileSize().toFixed(3)),{contentWidth:"150px"})},_getExtensionController:function(e){return e.isA("sap.fe.core.ExtensionAPI")?e._controller:e},showCollaborationEditUser:function(e,t){var n,o,i;const a=s.getResourceModel(t);let r=v.byId(`manageCollaborationDraft--editUser`);if(!r){r=new h("manageCollaborationDraft--editUser",{showHeader:false,placement:"Bottom"});r.addStyleClass("sapUiContentPadding");t.addDependent(r)}const l=(n=e.getBinding("initials"))===null||n===void 0?void 0:n.getBindings().find(e=>{var t;return e===null||e===void 0?void 0:(t=e.getPath())===null||t===void 0?void 0:t.startsWith("/collaboration/activities")}).getPath();const c=(o=e.getBindingContext("internal"))===null||o===void 0?void 0:o.getObject(l);let d;if(c&&c.length>0){d=c.find(t=>t.key===F(e.getBindingContext().getPath()))}r.destroyContent();r.addContent(new f({text:a.getText("C_COLLABORATIONAVATAR_USER_EDIT_FIELD",[`${(i=d)===null||i===void 0?void 0:i.name}`])}));r.openBy(e)}};return O},true);
//# sourceMappingURL=FieldRuntime.js.map